const e=Symbol("Comlink.proxy"),t=Symbol("Comlink.endpoint"),o=Symbol("Comlink.releaseProxy"),r=Symbol("Comlink.thrown"),i=e=>"object"==typeof e&&null!==e||"function"==typeof e,n=new Map([["proxy",{canHandle:t=>i(t)&&t[e],serialize(e){const{port1:t,port2:o}=new MessageChannel;return a(e,t),[o,[o]]},deserialize:e=>(e.start(),u(e,[],undefined))}],["throw",{canHandle:e=>i(e)&&r in e,serialize({value:e}){let t;return t=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[t,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function a(e,t=self){t.addEventListener("message",(function o(i){if(!i||!i.data)return;const{id:n,type:l,path:u}=Object.assign({path:[]},i.data),c=(i.data.argumentList||[]).map(x);let f;try{const t=u.slice(0,-1).reduce(((e,t)=>e[t]),e),o=u.reduce(((e,t)=>e[t]),e);switch(l){case"GET":f=o;break;case"SET":t[u.slice(-1)[0]]=x(i.data.value),f=!0;break;case"APPLY":f=o.apply(t,c);break;case"CONSTRUCT":f=d(new o(...c));break;case"ENDPOINT":{const{port1:t,port2:o}=new MessageChannel;a(e,o),f=m(t,[t])}break;case"RELEASE":f=void 0;break;default:return}}catch(e){f={value:e,[r]:0}}Promise.resolve(f).catch((e=>({value:e,[r]:0}))).then((e=>{const[r,i]=p(e);t.postMessage(Object.assign(Object.assign({},r),{id:n}),i),"RELEASE"===l&&(t.removeEventListener("message",o),s(t))}))})),t.start&&t.start()}function s(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function l(e){if(e)throw new Error("Proxy has been released and is not useable")}function u(e,r=[],i=function(){}){let n=!1;const a=new Proxy(i,{get(t,i){if(l(n),i===o)return()=>h(e,{type:"RELEASE",path:r.map((e=>e.toString()))}).then((()=>{s(e),n=!0}));if("then"===i){if(0===r.length)return{then:()=>a};const t=h(e,{type:"GET",path:r.map((e=>e.toString()))}).then(x);return t.then.bind(t)}return u(e,[...r,i])},set(t,o,i){l(n);const[a,s]=p(i);return h(e,{type:"SET",path:[...r,o].map((e=>e.toString())),value:a},s).then(x)},apply(o,i,a){l(n);const s=r[r.length-1];if(s===t)return h(e,{type:"ENDPOINT"}).then(x);if("bind"===s)return u(e,r.slice(0,-1));const[f,m]=c(a);return h(e,{type:"APPLY",path:r.map((e=>e.toString())),argumentList:f},m).then(x)},construct(t,o){l(n);const[i,a]=c(o);return h(e,{type:"CONSTRUCT",path:r.map((e=>e.toString())),argumentList:i},a).then(x)}});return a}function c(e){const t=e.map(p);return[t.map((e=>e[0])),(o=t.map((e=>e[1])),Array.prototype.concat.apply([],o))];var o}const f=new WeakMap;function m(e,t){return f.set(e,t),e}function d(t){return Object.assign(t,{[e]:!0})}function p(e){for(const[t,o]of n)if(o.canHandle(e)){const[r,i]=o.serialize(e);return[{type:"HANDLER",name:t,value:r},i]}return[{type:"RAW",value:e},f.get(e)||[]]}function x(e){switch(e.type){case"HANDLER":return n.get(e.name).deserialize(e.value);case"RAW":return e.value}}function h(e,t,o){return new Promise((r=>{const i=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.addEventListener("message",(function t(o){o.data&&o.data.id&&o.data.id===i&&(e.removeEventListener("message",t),r(o.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:i},t),o)}))}var v="undefined"!=typeof Float32Array?Float32Array:Array;function g(){var e=new v(9);return v!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function b(){var e=new v(16);return v!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function M(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function C(e,t){if(e===t){var o=t[1],r=t[2],i=t[3],n=t[6],a=t[7],s=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=o,e[6]=t[9],e[7]=t[13],e[8]=r,e[9]=n,e[11]=t[14],e[12]=i,e[13]=a,e[14]=s}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function y(e,t){var o=t[0],r=t[1],i=t[2],n=t[3],a=t[4],s=t[5],l=t[6],u=t[7],c=t[8],f=t[9],m=t[10],d=t[11],p=t[12],x=t[13],h=t[14],v=t[15],g=o*s-r*a,b=o*l-i*a,M=o*u-n*a,C=r*l-i*s,y=r*u-n*s,S=i*u-n*l,w=c*x-f*p,T=c*h-m*p,I=c*v-d*p,P=f*h-m*x,N=f*v-d*x,D=m*v-d*h,V=g*D-b*N+M*P+C*I-y*T+S*w;return V?(V=1/V,e[0]=(s*D-l*N+u*P)*V,e[1]=(i*N-r*D-n*P)*V,e[2]=(x*S-h*y+v*C)*V,e[3]=(m*y-f*S-d*C)*V,e[4]=(l*I-a*D-u*T)*V,e[5]=(o*D-i*I+n*T)*V,e[6]=(h*M-p*S-v*b)*V,e[7]=(c*S-m*M+d*b)*V,e[8]=(a*N-s*I+u*w)*V,e[9]=(r*I-o*N-n*w)*V,e[10]=(p*y-x*M+v*g)*V,e[11]=(f*M-c*y-d*g)*V,e[12]=(s*T-a*P-l*w)*V,e[13]=(o*P-r*T+i*w)*V,e[14]=(x*b-p*C-h*g)*V,e[15]=(c*C-f*b+m*g)*V,e):null}function S(e,t,o){var r=t[0],i=t[1],n=t[2],a=t[3],s=t[4],l=t[5],u=t[6],c=t[7],f=t[8],m=t[9],d=t[10],p=t[11],x=t[12],h=t[13],v=t[14],g=t[15],b=o[0],M=o[1],C=o[2],y=o[3];return e[0]=b*r+M*s+C*f+y*x,e[1]=b*i+M*l+C*m+y*h,e[2]=b*n+M*u+C*d+y*v,e[3]=b*a+M*c+C*p+y*g,b=o[4],M=o[5],C=o[6],y=o[7],e[4]=b*r+M*s+C*f+y*x,e[5]=b*i+M*l+C*m+y*h,e[6]=b*n+M*u+C*d+y*v,e[7]=b*a+M*c+C*p+y*g,b=o[8],M=o[9],C=o[10],y=o[11],e[8]=b*r+M*s+C*f+y*x,e[9]=b*i+M*l+C*m+y*h,e[10]=b*n+M*u+C*d+y*v,e[11]=b*a+M*c+C*p+y*g,b=o[12],M=o[13],C=o[14],y=o[15],e[12]=b*r+M*s+C*f+y*x,e[13]=b*i+M*l+C*m+y*h,e[14]=b*n+M*u+C*d+y*v,e[15]=b*a+M*c+C*p+y*g,e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var w=S;function T(){var e=new v(3);return v!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function I(e,t,o){var r=new v(3);return r[0]=e,r[1]=t,r[2]=o,r}function P(e,t,o){return e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}function N(e,t){var o=t[0],r=t[1],i=t[2],n=o*o+r*r+i*i;return n>0&&(n=1/Math.sqrt(n)),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function D(e,t,o){var r=t[0],i=t[1],n=t[2],a=o[3]*r+o[7]*i+o[11]*n+o[15];return a=a||1,e[0]=(o[0]*r+o[4]*i+o[8]*n+o[12])/a,e[1]=(o[1]*r+o[5]*i+o[9]*n+o[13])/a,e[2]=(o[2]*r+o[6]*i+o[10]*n+o[14])/a,e}function V(){var e=new v(4);return v!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function _(e,t,o,r){var i=new v(4);return i[0]=e,i[1]=t,i[2]=o,i[3]=r,i}function E(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function B(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function O(e,t,o){var r=t[0],i=t[1],n=t[2],a=t[3];return e[0]=o[0]*r+o[4]*i+o[8]*n+o[12]*a,e[1]=o[1]*r+o[5]*i+o[9]*n+o[13]*a,e[2]=o[2]*r+o[6]*i+o[10]*n+o[14]*a,e[3]=o[3]*r+o[7]*i+o[11]*n+o[15]*a,e}function U(){var e=new v(4);return v!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function z(e,t){var o=new v(2);return o[0]=e,o[1]=t,o}T(),V(),T(),I(1,0,0),I(0,1,0),U(),U(),g(),function(){var e;e=new v(2),v!=Float32Array&&(e[0]=0,e[1]=0)}();class L{gl;webGLExtensions;uniforms;vao;drawElements;visible;modelWorldMatrix;primitiveType;indexCount;indexType;sortCoord;textures;constructor(e,t,o,r){this.gl=e,this.webGLExtensions=t,this.visible=r.visible??!1,this.primitiveType=r.primitiveType,this.indexCount=r.indexCount,this.indexType=r.indexBufferType,this.sortCoord=r.sortCoord,this.modelWorldMatrix=r.modelWorldMatrix,this.textures=r.textures;const i=e.createBuffer();if(!i)throw new Error("Could not create vertex buffer!");const n=e.createVertexArray();e.bindVertexArray(n),e.bindBuffer(34962,i),e.bufferData(34962,r.vertexBuffer,35044),function(e,t,o){const{stride:r}=t;for(const{semantic:i,components:n,type:a,normalize:s,byteOffset:l}of t.attributes){const t=o[i]?.location;null!=t&&(e.enableVertexAttribArray(t),e.vertexAttribPointer(t,n,a,s,r,l))}}(e,r.vertexLayout,o);let a=null;if(r.indexBuffer){if(a=e.createBuffer(),!a)throw new Error("Could not create index buffer!");e.bindBuffer(34963,a),e.bufferData(34963,r.indexBuffer,35044)}e.bindVertexArray(null),e.deleteBuffer(i),e.deleteBuffer(a),this.vao=n}triangleCount(){if(0===this.primitiveType)return 0;let e=this.indexCount;if(this.drawElements?.counts.length){e=0;for(const t of this.drawElements.counts)e+=t}switch(this.primitiveType){case 4:e/=3;break;case 5:case 6:e-=2;break;case 1:e/=2}return e}pointsCount(){if(0===this.primitiveType){if(this.drawElements?.counts.length){let e=0;for(const t of this.drawElements.counts)e+=t;return e}return this.indexCount}return 0}draw(e){const{gl:t,indexCount:o,primitiveType:r,indexType:i,vao:n}=this;t.bindVertexArray(n);const a="ios"==e.name||"ipad"==e.name;if(i){const{drawElements:e}=this;if(!a&&e?.counts.length){const{counts:t,offsets:o}=e,n=t.length;this.webGLExtensions.WEBGL_multi_draw.multiDrawElementsWEBGL(r,t,0,i,o,0,n)}else t.drawElements(r,o,i,0)}else!a&&this.drawElements?.counts.length?this.webGLExtensions.WEBGL_multi_draw.multiDrawArraysWEBGL(r,this.drawElements.offsets,0,this.drawElements.counts,0,this.drawElements.counts.length):t.drawArrays(r,0,o);t.bindVertexArray(null)}dispose(){const{gl:e,vao:t}=this;e.bindVertexArray(null),e.deleteVertexArray(t)}}class R{gl;webGLExtensions;kind;color;outline;_meshes=new Map;attributeLocations;constructor(e,t,o,r,i){this.gl=e,this.webGLExtensions=t,this.kind=o,this.color=r,this.outline=i,this.attributeLocations=function(e,t,o,r){const i={};let n=0;for(const{semantic:a,components:s,type:l,normalize:u,byteOffset:c,defaultValue:f}of o.attributes){const o=r?r[a]:`a${n}`;n++;const s=o?e.getAttribLocation(t,o):-1;-1!=s&&(i[a]={location:s,defaultValue:f})}return i}(e,r.program,r.vertexLayout,r.vertexSemanticNames)}createMesh(e,t){const o=new L(this.gl,this.webGLExtensions,this.attributeLocations,t);this._meshes.set(e,o)}updateMesh(e,t){const o=this._meshes.get(e);if(o){const{visible:e,modelWorldMatrix:r,uniforms:i,drawElements:n}=t;void 0!==e&&(o.visible=e),r&&(o.modelWorldMatrix=r),i&&(o.uniforms=i),n&&(o.drawElements=n)}}deleteMesh(e){const t=this._meshes.get(e);t&&(this._meshes.delete(e),t.dispose())}update(e,t){e&&this.color.updateUniforms(e),t&&this.color.updateTextureReferences(t)}get count(){return this._meshes.size}get meshes(){return this._meshes.values()}dispose(){for(const e of this.meshes)e.dispose();this._meshes.clear()}}function A(e,t,o){const r=e.createShader(e[t]);if(!r)throw new Error("WebGL Shader could not be created.");if(e.shaderSource(r,o),e.compileShader(r),!e.getShaderParameter(r,35713)){const i=t.split("_")[0].toLocaleLowerCase(),n=e.getShaderInfoLog(r);throw o.split("\r\n"),new Error(`: Failed to compile glsl ${i} shader!\r\n${n}`)}return r}function j(e,t,o){const r=A(e,"VERTEX_SHADER",(o??"")+t.vertex),i=A(e,"FRAGMENT_SHADER",(o??"")+t.fragment),n=e.createProgram();if(!n)throw new Error("Could not create WebGL shader program!");if(e.attachShader(n,r),e.attachShader(n,i),e.linkProgram(n),e.detachShader(n,r),e.detachShader(n,i),e.deleteShader(r),e.deleteShader(i),!e.getProgramParameter(n,35714))throw new Error(`: Failed to compile link shaders!\r\n${e.getProgramInfoLog(n)}`);return n}const F={bool:function(e,t,o){e.uniform1f(t,o?1:0)},float:function(e,t,o){e.uniform1f(t,o)},int:function(e,t,o){e.uniform1i(t,o)},uint:function(e,t,o){e.uniform1ui(t,o)},vec2:function(e,t,o){e.uniform2fv(t,o)},ivec2:function(e,t,o){e.uniform2iv(t,o)},uivec2:function(e,t,o){e.uniform2uiv(t,o)},vec3:function(e,t,o){e.uniform3fv(t,o)},ivec3:function(e,t,o){e.uniform3iv(t,o)},uvec3:function(e,t,o){e.uniform3uiv(t,o)},vec4:function(e,t,o){e.uniform4fv(t,o)},ivec4:function(e,t,o){e.uniform4iv(t,o)},uivec4:function(e,t,o){e.uniform4uiv(t,o)},mat2:function(e,t,o){e.uniformMatrix2fv(t,!1,o)},mat3:function(e,t,o){e.uniformMatrix3fv(t,!1,o)},mat4:function(e,t,o){e.uniformMatrix4fv(t,!1,o)}};function G(e,t,o){const r={};for(const i of Reflect.ownKeys(o)){if("string"!=typeof i)continue;const n=o[i];if(!n)continue;const[a,s,l]=n,u=e.getUniformLocation(t,a);if(u){const e=F[s];let t;r[i]={location:u,setter:e,defaultValue:l,currentValue:t}}}return{reset(){for(const e in r){const t=r[e];t.currentValue=t.defaultValue}},*check(){for(const e in r)null==r[e].currentValue&&(yield e)},set:t=>{for(const o in t)if(o in r){const i=r[o],{location:n,setter:a,defaultValue:s}=i,l=t[o]??s;void 0!==l&&n&&(a(e,n,l),i.currentValue=l)}}}}const W={type:3553,10240:9729,10241:9986,10242:10497,10243:10497},k={3042:!1,32773:new Float32Array([0,0,0,0]),32970:0,32968:0,34877:32774,32777:32774,32971:1,32969:1,2884:!1,2885:1029,2886:2305,2929:!1,2932:513,2930:!0,2928:new Float32Array([0,1]),3024:!0,32823:!1,32824:0,10752:0,32926:!1,32928:!1,32938:1,32939:!1,2960:!1,2962:519,2963:2147483647,2967:0,34816:519,36004:2147483647,36003:0};function H(e,t,o,r){function i(t){const o=r[t];return o?e.enable(t):e.disable(t),o}function n(t,...i){for(let n of i)if(o[n]!=r[n]){const o=i.map((e=>r[e]));t.apply(e,o);break}}const{OES_draw_buffers_indexed:a}=t;a?(r[3042]?a.enableiOES(3042,0):a.disableiOES(3042,0),n(((e,t)=>a.blendEquationSeparateiOES(0,e,t)),32777,34877),n(((e,t,o,r)=>a.blendFuncSeparateiOES(0,e,t,o,r)),32969,32968,32971,32970)):(i(3042),n(e.blendEquationSeparate,32777,34877),n(e.blendFuncSeparate,32969,32968,32971,32970)),n((t=>{e.blendColor(...t)}),32773),i(2884),n(e.cullFace,2885),n(e.frontFace,2886),i(2929),n(e.depthFunc,2932),n(e.depthMask,2930),n((t=>e.depthRange(...t)),2928),i(3024),i(32823),n(e.polygonOffset,32824,10752),i(32926),i(32928),n(e.sampleCoverage,32938,32939),i(2960),n(((t,o,r)=>e.stencilFuncSeparate(e.FRONT,t,o,r)),2962,2967,2963),n(((t,o,r)=>e.stencilFuncSeparate(e.BACK,t,o,r)),34816,36003,36004)}function q(e,t){const o=[10240,10241,10242,10243],{type:r}=t;for(const i of o){const o=t[i];o&&e.texParameteri(r,i,o)}}class X{gl;ext;extensions;program;defaultUniforms;uniforms;attributeDefaults;textureSlots;vertexLayout;vertexSemanticNames;textures;renderOrder;drawBuffers;constructor(e,t,o,r){this.gl=e,this.ext=t,this.extensions=o;const{shaders:i,vertexLayout:n,vertexSemanticNames:a,uniforms:s,drawBuffers:l}=r,u=[...i.flags??[]],{conditionalFlags:c}=i;if(c)for(const e in c){const t=e;if(o[t]){const e=c[t];e&&u.push(e)}}this.renderOrder=r.renderOrder??0;const f=function(e,t){let o="#version 300 es\n";for(const e of t)o+=`#define ${e}\n`;return o}(0,u),m=f+i.vertex,d=f+i.fragment,p={};for(const e in r.uniforms){const[t,o,i]=r.uniforms[e];void 0!==i&&Reflect.set(p,e,i)}this.defaultUniforms=p;const{textureSlots:x,images:h}=r,v={};if(x)for(let e=0;e<x.length;e++){const t=x[e],{textureSemantic:o,shaderUniform:r}=t;v[o]=[r,"int"]}if(h){const t={};for(let o in h){const r=h[o],i=e.createTexture();e.bindTexture(3553,i),e.texImage2D(3553,0,6408,6408,5121,r),e.bindTexture(3553,null),t[o]=i}e.bindTexture(3553,null),this.textures=t}const g=j(e,{vertex:m,fragment:d});this.uniforms=G(e,g,{...s,...v}),this.attributeDefaults=function(e,t,o,r){const i=[];for(const{semantic:n,defaultValue:a}of o.attributes){const o=r[n],s=o?e.getAttribLocation(t,o):void 0;null!=s&&-1!=s&&a&&i.push({index:s,defaultValue:a})}return i}(e,g,n,a),this.textureSlots=r.textureSlots??[],this.program=g,this.vertexLayout=n,this.vertexSemanticNames=a,this.drawBuffers=l??[36064]}}class Q{gl;ext;program;vertexLayout;vertexSemanticNames;renderOrder;uniformValues;textureUniforms={};attributeDefaults;uniforms;_drawBuffers;textureSlots;textureReferences;state=k;constructor(e,t,o){this.gl=e.gl,this.ext=e.ext,this.program=e.program,this.vertexLayout=e.vertexLayout,this.vertexSemanticNames=e.vertexSemanticNames,this.renderOrder=e.renderOrder,this.uniforms=e.uniforms,this.attributeDefaults=e.attributeDefaults,this.uniformValues={...e.defaultUniforms,...t};const{textureSlots:r}=e,i=this.textureUniforms;for(let e=0;e<r.length;e++)i[r[e].textureSemantic]=e;this.textureSlots=e.textureSlots,this.textureReferences=o??{},this._drawBuffers=e.drawBuffers}get isAlpha(){return!0===this.state[3042]}drawBuffers(e){return this._drawBuffers}updateUniforms(e){Object.assign(this.uniformValues,e)}updateTextureReferences(e){Object.assign(this.textureReferences,e)}applyShaders(){const{gl:e,program:t}=this;e.useProgram(t)}shouldRender;computeUniforms;computeMeshUniforms;apply(e){if(this.shouldRender&&0==this.shouldRender(e))return!1;this.applyShaders();const{gl:t,uniforms:o}=this;if(o.set(e.cameraUniforms),o.set(e.sceneUniforms),o.set(this.uniformValues),this.computeUniforms){const t=this.computeUniforms(e);o.set(t)}e.currentState=this.applyState(e.currentState);const r=e.settings.advanced.renderBufferMask,i=[...this.drawBuffers(e)];for(let e=0;e<i.length;e++)0==(r&1<<e)&&(i[e]=0);return t.drawBuffers(i),o.set(this.textureUniforms),this.applyTextures(e.textures,e.sceneTextures),!0}applyMeshUniforms(e,t){const{uniforms:o}=this;if(t.uniforms&&o.set(t.uniforms),this.computeMeshUniforms){const r=this.computeMeshUniforms(e,t);o.set(r)}if(t.textures.length>0){const{gl:o,textureSlots:r}=this;for(const i of t.textures){const{semantics:t,textureIndex:n}=i,a=r.map(((e,t)=>({s:e,i:t}))).filter((e=>e.s.textureSemantic===t))[0];if(!a)continue;let{samplerState:s}=a.s;const l=e.textures.getTexture(n);if(!l)continue;const{texture:u,samplerOverrides:c}=l;c&&(s={...s,...c}),u&&(o.activeTexture(33984+a.i),o.bindTexture(s.type,u),q(o,s))}}}cleanup(e){const{gl:t,textureSlots:o}=this;for(let e=0;e<o.length;e++){let{samplerState:r}=o[e];t.activeTexture(33984+e),t.bindTexture(r.type,null)}return t.activeTexture(33984),this.resetAttributes(),!1}applyTextures(e,t){const{gl:o,textureSlots:r}=this;let i=!0;for(let n=0;n<r.length;n++){let{textureSemantic:a,samplerState:s}=r[n];const l=this.textureReferences[a]??t[a],u=void 0!==l?e.getTexture(l):void 0;let c=null;if(u){c=u.texture;const{samplerOverrides:e}=u;e&&(s={...s,...e})}o.activeTexture(33984+n),c?(o.bindTexture(s.type,c),q(o,s)):(c=e.nullTexture(s.type),o.bindTexture(s.type,c),i=!1)}return i}applyAttributes(){const{gl:e,attributeDefaults:t}=this;for(const{index:o,defaultValue:r}of t)"number"==typeof r?e.vertexAttrib1f(o,r):e[`vertexAttrib${r.length}fv`](o,r)}resetAttributes(){const{gl:e,attributeDefaults:t}=this;for(const{index:o}of t)e.vertexAttrib4f(o,0,0,0,1)}applyState(e){const{gl:t,ext:o,state:r}=this;return H(t,o,e,r),r}}function Z(e){switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5126:return 4}}function Y(e){let t=0;const o=[];for(const r of e){const{semantic:e}=r,i=r.type??5126,n=r.components??1,a={semantic:e,components:n,type:i,normalize:r.normalize??!1,byteOffset:t,defaultValue:r.defaultValue};t+=Z(i)*n,o.push(a)}return{attributes:o,stride:t}}const $=Y([{semantic:0,type:5126,components:2,normalize:!1}]);class K extends Q{constructor(e,t,o){super(e,t,o)}computeUniforms=e=>({envBlurNormalized:e.settings.background.skyBoxBlur,mipCount:9});state={...k,3024:!1,2929:!0,2930:!1,2932:515}}(K||(K={})).contextData={shaders:{vertex:"precision highp float;uniform mat4 uViewClipMatrix;uniform mat3 uViewWorldMatrixNormal;in vec2 aPosition;out vec3 vDir;void main(){gl_Position=uViewClipMatrix[3][3]==0.0 ? vec4(aPosition.x,aPosition.y,1,1): vec4(0);vec3 dirVS=vec3(aPosition.x/uViewClipMatrix[0][0],aPosition.y/uViewClipMatrix[1][1],-1);vDir=uViewWorldMatrixNormal*dirVS;}",fragment:"precision highp float;uniform samplerCube texBackground;uniform samplerCube texRadiance;uniform mat4 uViewClipMatrix;uniform float uEnvBlurNormalized;uniform int uMipCount;in vec3 vDir;layout(location=0)out vec4 fragColor;void main(){vec3 color;if(uEnvBlurNormalized==0.){color=texture(texBackground,normalize(vDir)).rgb;}else{color=textureLod(texRadiance,normalize(vDir),uEnvBlurNormalized*float(uMipCount-1)).rgb;}fragColor=vec4(color,1);}",flags:[]},vertexLayout:$,vertexSemanticNames:{0:"aPosition"},uniforms:{viewWorldNormalMatrix:["uViewWorldMatrixNormal","mat3"],viewClipMatrix:["uViewClipMatrix","mat4"],envBlurNormalized:["uEnvBlurNormalized","float"],mipCount:["uMipCount","int"]},textureSlots:[{textureSemantic:"background",shaderUniform:"texBackground",samplerState:{type:34067,10240:9729,10241:9729,10242:33071,10243:33071}},{textureSemantic:"radiance",shaderUniform:"texRadiance",samplerState:{type:34067,10240:9729,10241:9987,10242:33071,10243:33071}}],renderOrder:-10};const J=Y([{semantic:0,type:5126,components:3,normalize:!1}]);class ee extends Q{modelClipMatrix=b();constructor(e,t){super(e,t)}state={...k,2884:!0,3024:!1,2929:!1,2930:!1,2932:519,3042:!0,32969:770,32968:1,32971:1,32970:1};computeUniforms=e=>{const{modelClipMatrix:t}=this,{width:o,height:r}=e.cameraUniforms,i=1.8815558201167732,n=Math.hypot(12.717486682726303,i),a=.2*Math.hypot(o,r),s=2*a/n/o,l=2*a/n/r,u=a/n*.1*.5/i;return t[0]=s,t[5]=l,t[10]=u,t[12]=1-1*s,t[13]=1*l-1,t[14]=.5*u,{modelClipMatrix:t}}}(ee||(ee={})).contextData={shaders:{vertex:"precision highp float;precision highp int;uniform mat4 uModelClipMatrix;uniform vec4 uColor;in vec3 aPosition;out float vElevation;void main(){vec4 p=uModelClipMatrix*vec4(aPosition,1.0);vElevation=p.z;gl_Position=vec4(p.xy,0.0,1.0);}",fragment:"precision highp float;precision highp int;uniform mat4 uModelClipMatrix;uniform vec4 uColor;in float vElevation;layout(location=0)out vec4 fragColor;void main(){float a=clamp(vElevation,0.0,1.0);fragColor=vec4(uColor.rgb,a);}",flags:[]},vertexLayout:J,vertexSemanticNames:{0:"aPosition"},uniforms:{modelClipMatrix:["uModelClipMatrix","mat4"],color:["uColor","vec4"]},renderOrder:10};const te="uniform mat4 uModelClipMatrix;uniform mat3 uModelViewMatrixNormal;in vec4 aPosition;in vec3 aNormal;in vec4 aColor;in vec2 aTexcoord0;out vec3 vNormal;out float vLinearZ;void main(){gl_Position=uModelClipMatrix*aPosition;vNormal=uModelViewMatrixNormal*aNormal;vLinearZ=gl_Position.w;}",oe="precision highp float;uniform vec4 uRGBA;in vec3 vNormal;in float vLinearZ;layout(location=0)out vec4 fragColor;layout(location=1)out vec2 fragNormal;layout(location=2)out float fragDepth;layout(location=3)out uvec2 fragInfo;void main(){fragColor=uRGBA;fragNormal=vNormal.xy;fragDepth=vLinearZ;fragInfo=uvec2(0xfffffff8U,0xffffffff);}",re=Y([{semantic:0,type:5126,components:3,normalize:!1},{semantic:1,type:5126,components:3,normalize:!1},{semantic:4,type:5126,components:2,normalize:!1}]),ie={0:"aPosition",1:"aNormal"},ne={modelClipMatrix:["uModelClipMatrix","mat4"],modelViewNormalMatrix:["uModelViewMatrixNormal","mat3"],rgba:["uRGBA","vec4"]},ae=[36064,36065,36066,36067];class se extends Q{constructor(e,t){super(e,t)}cameraUniforms={modelWorldMatrix:b(),modelClipMatrix:b(),modelViewMatrix:b()};computeMeshUniforms=(e,t)=>{const{cameraUniforms:o}=e,{modelWorldMatrix:r,modelClipMatrix:i,modelViewMatrix:n}=this.cameraUniforms;return t.modelWorldMatrix?(M(r,t.modelWorldMatrix),S(i,o.worldClipMatrix,r),S(n,o.worldViewMatrix,r)):(M(r,o.modelWorldMatrix),M(i,o.modelClipMatrix),M(n,o.modelViewMatrix)),this.cameraUniforms};state={...k,3024:!1,2929:!0,2932:519}}(se||(se={})).contextData={shaders:{vertex:te,fragment:oe,flags:[]},vertexLayout:re,vertexSemanticNames:ie,uniforms:ne,drawBuffers:ae};class le extends se{constructor(e,t){super(e,t)}state={...k,3024:!1,2929:!0}}(le||(le={})).contextData={shaders:{vertex:te,fragment:oe,flags:[]},vertexLayout:re,vertexSemanticNames:ie,uniforms:ne,drawBuffers:ae};class ue extends Q{constructor(e,t){super(e,t)}state={...k,2884:!1,2929:!0,2930:!1,3024:!1,3042:!0,32969:770,32968:771}}(ue||(ue={})).contextData={shaders:{vertex:te,fragment:oe,flags:[]},vertexLayout:re,vertexSemanticNames:ie,uniforms:ne,drawBuffers:ae};const ce="precision highp float;precision highp int;uniform mat4 uModelClipMatrix;uniform mat3 uModelWorldNormalMatrix;uniform vec3 uCameraPosMS;uniform vec4 uBaseColorFactor;uniform float uBaseColorUVSet;uniform float uAlphaCutoff;uniform sampler2D texBaseColor;uniform float uRoughnessFactor;uniform float uMetallicFactor;uniform float uMetallicRoughnessUVSet;uniform sampler2D texMetallicRoughness;uniform float uNormalScale;uniform float uNormalUVSet;uniform sampler2D texNormal;uniform float uOcclusionStrength;uniform float uOcclusionUVSet;uniform sampler2D texOcclusion;uniform vec3 uEmissiveFactor;uniform float uEmissiveUVSet;uniform sampler2D texEmissive;uniform vec3 uSunDir;uniform float uSunBrightness;uniform float uAmbientLight;uniform float uExposure;uniform float uMipCount;uniform samplerCube texIrradiance;uniform samplerCube texRadiance;uniform sampler2D texGGXLUT;in vec4 aPosition;in vec3 aNormal;in vec4 aTangent;in vec2 aTextureCoord0;in vec2 aTextureCoord1;in vec4 aColor0;out vec3 vToCamera;out mat3 vTBN;out vec2 vTextureCoord0;out vec2 vTextureCoord1;out vec4 vColor0;out float vLinearZ;void main(){gl_Position=uModelClipMatrix*aPosition;vToCamera=uModelWorldNormalMatrix*(uCameraPosMS-aPosition.xyz);vec3 normalWS=uModelWorldNormalMatrix*aNormal;vec3 tangentWS=uModelWorldNormalMatrix*aTangent.xyz;vec3 bitangentWS=cross(normalWS,tangentWS)*aTangent.w;vTBN=mat3(tangentWS,bitangentWS,normalWS);vTextureCoord0=aTextureCoord0;vTextureCoord1=aTextureCoord1;vColor0=aColor0;vLinearZ=gl_Position.w;}",fe="precision highp float;precision highp int;uniform mat4 uModelClipMatrix;uniform mat3 uModelWorldNormalMatrix;uniform vec3 uCameraPosMS;uniform vec4 uBaseColorFactor;uniform float uBaseColorUVSet;uniform float uAlphaCutoff;uniform sampler2D texBaseColor;uniform float uRoughnessFactor;uniform float uMetallicFactor;uniform float uMetallicRoughnessUVSet;uniform sampler2D texMetallicRoughness;uniform float uNormalScale;uniform float uNormalUVSet;uniform sampler2D texNormal;uniform float uOcclusionStrength;uniform float uOcclusionUVSet;uniform sampler2D texOcclusion;uniform vec3 uEmissiveFactor;uniform float uEmissiveUVSet;uniform sampler2D texEmissive;uniform vec3 uSunDir;uniform float uSunBrightness;uniform float uAmbientLight;uniform float uExposure;uniform float uMipCount;uniform samplerCube texIrradiance;uniform samplerCube texRadiance;uniform sampler2D texGGXLUT;in vec3 vToCamera;in mat3 vTBN;in vec2 vTextureCoord0;in vec2 vTextureCoord1;in vec4 vColor0;in float vLinearZ;layout(location=0)out vec4 fragColor;layout(location=1)out vec2 fragNormal;layout(location=2)out float fragDepth;layout(location=3)out uvec2 fragInfo;const float M_PI=3.141592653589793;vec3 F_Schlick(vec3 f0,vec3 f90,float VdotH){return f0+(f90-f0)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}float V_GGX(float NdotL,float NdotV,float alphaRoughness){float alphaRoughnessSq=alphaRoughness*alphaRoughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-alphaRoughnessSq)+alphaRoughnessSq);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-alphaRoughnessSq)+alphaRoughnessSq);float GGX=GGXV+GGXL;if(GGX>0.0){return 0.5/GGX;}return 0.0;}float D_GGX(float NdotH,float alphaRoughness){float alphaRoughnessSq=alphaRoughness*alphaRoughness;float f=(NdotH*NdotH)*(alphaRoughnessSq-1.0)+1.0;return alphaRoughnessSq/(M_PI*f*f);}vec3 BRDF_lambertian(vec3 f0,vec3 f90,vec3 diffuseColor,float VdotH){return(1.0-F_Schlick(f0,f90,VdotH))*(diffuseColor/M_PI);}vec3 BRDF_specularGGX(vec3 f0,vec3 f90,float alphaRoughness,float VdotH,float NdotL,float NdotV,float NdotH){vec3 F=F_Schlick(f0,f90,VdotH);float Vis=V_GGX(NdotL,NdotV,alphaRoughness);float D=D_GGX(NdotH,alphaRoughness);return F*Vis*D;}const float GAMMA=2.2;const float INV_GAMMA=1.0/GAMMA;vec3 linearTosRGB(vec3 color){return pow(color,vec3(INV_GAMMA));}vec3 sRGBToLinear(vec3 srgbIn){return vec3(pow(srgbIn.xyz,vec3(GAMMA)));}vec3 toneMapACES_Narkowicz(vec3 color){const float A=2.51;const float B=0.03;const float C=2.43;const float D=0.59;const float E=0.14;return clamp((color*(A*color+B))/(color*(C*color+D)+E),0.0,1.0);}vec3 RRTAndODTFit(vec3 color){vec3 a=color*(color+0.0245786)-0.000090537;vec3 b=color*(0.983729*color+0.4329510)+0.238081;return a/b;}const float maxHDR=16.0;vec3 rgbmToFloat(vec4 rgbe){return rgbe.rgb*rgbe.a*maxHDR;}float clampedDot(vec3 x,vec3 y){return clamp(dot(x,y),0.0,1.0);}struct NormalInfo{vec3 ng;vec3 n;vec3 t;vec3 b;};NormalInfo getNormalInfo(vec3 v){vec2 UV=uNormalUVSet<1.0 ? vTextureCoord0 : vTextureCoord1;vec3 uv_dx=dFdx(vec3(UV,0.0));vec3 uv_dy=dFdy(vec3(UV,0.0));vec3 t_=(uv_dy.t*dFdx(v)-uv_dx.t*dFdy(v))/(uv_dx.s*uv_dy.t-uv_dy.s*uv_dx.t);vec3 n,t,b,ng;ng=normalize(vTBN[2]);t=normalize(t_-ng*dot(ng,t_));b=cross(ng,t);float facing=step(0.0,dot(v,ng))*2.0-1.0;t*=facing;b*=facing;ng*=facing;if(uNormalUVSet>=0.0){n=texture(texNormal,UV).rgb*2.0-vec3(1.0);n*=vec3(uNormalScale,uNormalScale,1.0);n=mat3(t,b,ng)*normalize(n);}else{n=ng;}NormalInfo info;info.ng=ng;info.t=t;info.b=b;info.n=n;return info;}struct MaterialInfo{float perceptualRoughness;vec3 f0;float alphaRoughness;vec3 albedoColor;vec3 f90;float metallic;vec3 n;vec3 baseColor;};MaterialInfo getMetallicRoughnessInfo(MaterialInfo info,float f0_ior){info.metallic=uMetallicFactor;info.perceptualRoughness=uRoughnessFactor;if(uMetallicRoughnessUVSet>=0.0){vec2 uv=uMetallicRoughnessUVSet<1.0 ? vTextureCoord0 : vTextureCoord1;vec4 mrSample=texture(texMetallicRoughness,uv);info.perceptualRoughness*=mrSample.g;info.metallic*=mrSample.b;}vec3 f0=vec3(f0_ior);info.albedoColor=mix(info.baseColor.rgb*(vec3(1.0)-f0),vec3(0),info.metallic);info.f0=mix(f0,info.baseColor.rgb,info.metallic);return info;}vec3 getIBLRadianceGGX(vec3 n,vec3 v,float perceptualRoughness,vec3 specularColor){float NdotV=clampedDot(n,v);vec3 reflection=normalize(reflect(-v,n));vec2 brdfSamplePoint=clamp(vec2(NdotV,perceptualRoughness),vec2(0.0,0.0),vec2(1.0,1.0));vec2 brdf=texture(texGGXLUT,brdfSamplePoint).rg;float lod=clamp(perceptualRoughness*float(uMipCount),0.0,float(uMipCount));vec4 specularSample=textureLod(texRadiance,reflection,lod);vec3 specularLight=specularSample.rgb;return specularLight*(specularColor*brdf.x+brdf.y);}vec3 getIBLRadianceLambertian(vec3 n,vec3 diffuseColor){vec3 diffuseLight=texture(texIrradiance,n).rgb;return diffuseLight*diffuseColor;}void main(){vec4 baseColor=uBaseColorFactor*vColor0;vec3 color=baseColor.rgb;if(uBaseColorUVSet>=0.0){vec2 uv=uBaseColorUVSet<1.0 ? vTextureCoord0 : vTextureCoord1;vec4 bc=texture(texBaseColor,uv);\n#if !defined(UNLIT)\nbaseColor*=vec4(sRGBToLinear(bc.rgb),bc.a);\n#else\nbaseColor*=bc;\n#endif\n}if(baseColor.a<uAlphaCutoff)discard;vec3 v=normalize(vToCamera);NormalInfo normalInfo=getNormalInfo(v);vec3 n=normalInfo.n;\n#if !defined(UNLIT)\nvec3 l=normalize(uSunDir);vec3 h=normalize(l+v);MaterialInfo materialInfo;materialInfo.baseColor=baseColor.rgb;float ior=1.5;float f0_ior=0.04;materialInfo=getMetallicRoughnessInfo(materialInfo,f0_ior);materialInfo.perceptualRoughness=clamp(materialInfo.perceptualRoughness,0.0,1.0);materialInfo.metallic=clamp(materialInfo.metallic,0.0,1.0);materialInfo.alphaRoughness=materialInfo.perceptualRoughness*materialInfo.perceptualRoughness;float reflectance=max(max(materialInfo.f0.r,materialInfo.f0.g),materialInfo.f0.b);materialInfo.f90=vec3(clamp(reflectance*50.0,0.0,1.0));materialInfo.n=n;vec3 f_specular=vec3(0.0);vec3 f_diffuse=vec3(0.0);vec3 f_emissive=vec3(0.0);f_specular+=getIBLRadianceGGX(n,v,materialInfo.perceptualRoughness,materialInfo.f0);f_diffuse+=getIBLRadianceLambertian(n,materialInfo.albedoColor);float NdotL=clampedDot(n,l);float NdotV=clampedDot(n,v);float NdotH=clampedDot(n,h);float LdotH=clampedDot(l,h);float VdotH=clampedDot(v,h);vec3 intensity=vec3(uSunBrightness);if(NdotL>0.0||NdotV>0.0){f_specular+=intensity*NdotL*BRDF_specularGGX(materialInfo.f0,materialInfo.f90,materialInfo.alphaRoughness,VdotH,NdotL,NdotV,NdotH);f_diffuse+=intensity*NdotL*BRDF_lambertian(materialInfo.f0,materialInfo.f90,materialInfo.albedoColor,VdotH);}f_emissive=uEmissiveFactor;if(uEmissiveUVSet>=0.0){vec2 uv=uEmissiveUVSet<1.0 ? vTextureCoord0 : vTextureCoord1;f_emissive*=sRGBToLinear(texture(texEmissive,uv).rgb);}color=(f_emissive+f_diffuse+f_specular)+uAmbientLight*materialInfo.albedoColor;if(uOcclusionUVSet>=0.0){vec2 uv=uOcclusionUVSet<1.0 ? vTextureCoord0 : vTextureCoord1;float ao=texture(texOcclusion,uv).r;color=mix(color,color*ao,uOcclusionStrength);}\n#else\ncolor=baseColor.rgb;\n#endif\nfragColor.rgb=color;fragColor.a=baseColor.a;if(fragColor.a>=1.0){fragNormal=n.xy;fragDepth=vLinearZ;fragInfo=uvec2(0xfffffffeU,0xffffffffU);}}",me=function(){const e=I(0,1,0);return function(t){if(t){const a=t.inclination*Math.PI/360,s=t.azimuth*Math.PI/360;o=e,r=Math.cos(a)*Math.sin(s),i=Math.sin(a),n=Math.cos(a)*-Math.cos(s),o[0]=r,o[1]=i,o[2]=n}var o,r,i,n;return e}}(),de=Y([{semantic:0,type:5126,components:3,normalize:!1},{semantic:1,type:5126,components:3,normalize:!1},{semantic:2,type:5126,components:4,normalize:!1},{semantic:4,type:5126,components:2,normalize:!1},{semantic:5,type:5126,components:2,normalize:!1},{semantic:12,type:5126,components:4,normalize:!1,defaultValue:[1,1,1,1]}]),pe=Y([{semantic:0,type:5126,components:3,normalize:!1},{semantic:4,type:5126,components:2,normalize:!1},{semantic:12,type:5126,components:4,normalize:!1,defaultValue:[1,1,1,1]}]),xe={0:"aPosition",1:"aNormal",2:"aTangent",4:"aTextureCoord0",5:"aTextureCoord1",12:"aColor0"},he={modelClipMatrix:["uModelClipMatrix","mat4"],modelWorldNormalMatrix:["uModelWorldNormalMatrix","mat3"],cameraPosMS:["uCameraPosMS","vec3"],baseColorFactor:["uBaseColorFactor","vec4"],roughnessFactor:["uRoughnessFactor","float"],metallicFactor:["uMetallicFactor","float"],normalScale:["uNormalScale","float"],occlusionStrength:["uOcclusionStrength","float"],emissiveFactor:["uEmissiveFactor","vec3"],alphaCutoff:["uAlphaCutoff","float"],baseColorUVSet:["uBaseColorUVSet","float"],metallicRoughnessUVSet:["uMetallicRoughnessUVSet","float"],normalUVSet:["uNormalUVSet","float"],occlusionUVSet:["uOcclusionUVSet","float"],emissiveUVSet:["uEmissiveUVSet","float"],exposure:["uExposure","float"],sunDirection:["uSunDir","vec3"],sunBrightness:["uSunBrightness","float"],ambientLight:["uAmbientLight","float"],mipCount:["uMipCount","float",7]},ve=[{textureSemantic:"albedo",shaderUniform:"texBaseColor",samplerState:W},{textureSemantic:"metallic+roughness",shaderUniform:"texMetallicRoughness",samplerState:W},{textureSemantic:"normal",shaderUniform:"texNormal",samplerState:W},{textureSemantic:"occlusion",shaderUniform:"texOcclusion",samplerState:W},{textureSemantic:"emissive",shaderUniform:"texEmissive",samplerState:W},{textureSemantic:"irradiance",shaderUniform:"texIrradiance",samplerState:{type:34067,10240:9729,10241:9729,10242:33071,10243:33071}},{textureSemantic:"radiance",shaderUniform:"texRadiance",samplerState:{type:34067,10240:9729,10241:9987,10242:33071,10243:33071}},{textureSemantic:"ggx_lut",shaderUniform:"texGGXLUT",samplerState:{type:3553,10240:9729,10241:9729,10242:33071,10243:33071}}],ge=[36064,36065,36066,36067];class be extends Q{viewModelMatrix=b();cameraUniforms={modelClipMatrix:b(),modelWorldNormalMatrix:g(),cameraPosMS:T()};constructor(e,t,o){super(e,t,o)}computeUniforms=e=>{const{settings:t,textures:o,sceneTextures:r}=e,i=t.light.sun?.brightness??0,n=me(t.light.sun?.position),a=t.light.ambient?.brightness??0,s=Math.pow(2,t.exposure??0),{cameraPosMS:l}=this.cameraUniforms,u=this.textureReferences.radiance??r.radiance,c=void 0!==u?o.getTexture(u):void 0;return{exposure:s,sunBrightness:i,sunDirection:n,ambientLight:a,cameraPosMS:l,mipCount:c?c.mips:1}};computeMeshUniforms=(e,t)=>{const{cameraUniforms:o}=e,r=t.modelWorldMatrix??o.modelWorldMatrix,{modelClipMatrix:i,modelWorldNormalMatrix:n,cameraPosMS:a}=this.cameraUniforms;var s,l,u,c,f,m,d,p,x,h,v,g,b,M,C,w,T,I,P,N,D,V,_,E,B,O,U,z,L,R,A;S(i,o.worldClipMatrix,r),s=n,u=(l=r)[0],c=l[1],f=l[2],m=l[3],d=l[4],p=l[5],x=l[6],h=l[7],v=l[8],g=l[9],b=l[10],M=l[11],C=l[12],w=l[13],T=l[14],(A=(P=u*p-c*d)*(R=b*(I=l[15])-M*T)-(N=u*x-f*d)*(L=g*I-M*w)+(D=u*h-m*d)*(z=g*T-b*w)+(V=c*x-f*p)*(U=v*I-M*C)-(_=c*h-m*p)*(O=v*T-b*C)+(E=f*h-m*x)*(B=v*w-g*C))&&(A=1/A,s[0]=(p*R-x*L+h*z)*A,s[1]=(x*U-d*R-h*O)*A,s[2]=(d*L-p*U+h*B)*A,s[3]=(f*L-c*R-m*z)*A,s[4]=(u*R-f*U+m*O)*A,s[5]=(c*U-u*L-m*B)*A,s[6]=(w*E-T*_+I*V)*A,s[7]=(T*D-C*E-I*N)*A,s[8]=(C*_-w*D+I*P)*A);const{viewModelMatrix:j}=this;return S(j,o.worldViewMatrix,r),y(j,j),function(e,t){e[0]=t[12],e[1]=t[13],e[2]=t[14]}(a,j),this.cameraUniforms};state={...k,2884:!1,3024:!1,2929:!0}}(be||(be={})).contextData={shaders:{vertex:ce,fragment:fe,flags:[]},vertexLayout:de,vertexSemanticNames:xe,uniforms:he,textureSlots:ve,drawBuffers:ge};class Me extends be{constructor(e,t,o){super(e,t,o)}}(Me||(Me={})).contextData={shaders:{vertex:ce,fragment:fe,flags:["UNLIT"]},vertexLayout:pe,vertexSemanticNames:xe,uniforms:he,textureSlots:ve,drawBuffers:ge};class Ce extends be{constructor(e,t,o){super(e,t,o)}state={...k,2884:!1,3024:!1,2929:!0,2930:!1,3042:!0,32969:770,32971:1,32968:771,32970:1,2932:515}}(Ce||(Ce={})).contextData={shaders:{vertex:ce,fragment:fe,flags:[]},vertexLayout:de,vertexSemanticNames:xe,uniforms:he,textureSlots:ve,drawBuffers:ge,renderOrder:1};class ye extends Ce{constructor(e,t,o){super(e,t,o)}}(ye||(ye={})).contextData={shaders:{vertex:ce,fragment:fe,flags:["UNLIT"]},vertexLayout:pe,vertexSemanticNames:xe,uniforms:he,textureSlots:ve,drawBuffers:ge,renderOrder:1};const Se=Y([{semantic:0,type:5126,components:3,normalize:!1},{semantic:12,type:5126,components:3,normalize:!1,defaultValue:[1,1,1,1]}]);class we extends Q{cameraUniforms={modelClipMatrix:b()};constructor(e,t,o){super(e,t,o)}computeMeshUniforms=(e,t)=>{const{cameraUniforms:o}=e,r=t.modelWorldMatrix??o.modelWorldMatrix,{modelClipMatrix:i}=this.cameraUniforms;return S(i,o.worldClipMatrix,r),this.cameraUniforms};state={...k,3024:!1,2929:!0,2930:!0}}(we||(we={})).contextData={shaders:{vertex:"precision highp float;precision highp int;uniform mat4 uModelClipMatrix;in vec4 aPosition;in vec4 aColor0;out vec4 vColor0;void main(){gl_Position=uModelClipMatrix*aPosition;gl_PointSize=1.0;vColor0=aColor0;}",fragment:"precision highp float;precision highp int;uniform mat4 uModelClipMatrix;in vec4 vColor0;layout(location=0)out vec4 fragColor;void main(){fragColor=vColor0;}",flags:[]},vertexLayout:Se,vertexSemanticNames:{0:"aPosition",12:"aColor0"},uniforms:{modelClipMatrix:["uModelClipMatrix","mat4"]}};const Te="precision highp float;precision highp int;const int MaxClippingPlanes=6;uniform mat4 uModelClipMatrix;uniform mat4 uModelWorldMatrix;uniform mat4 uModelViewMatrix;uniform mat3 uModelWorldMatrixNormal;uniform mat3 uModelViewMatrixNormal;uniform mat3 uViewWorldMatrixNormal;uniform float uNumMaterials;uniform vec2 uObjectInfoTextureSize;uniform float uOctantMask;uniform vec4 uClippingPlanes[MaxClippingPlanes];uniform float uNumClippingPlanes;uniform bool uClipInside;uniform vec3 uSunDir;uniform float uSunBrightness;uniform float uAmbientLight;uniform vec4 uHeadlightColor;uniform float uHeadlightDistance;uniform float uElevationRangeMin,uElevationRangeMax;uniform float uMipCount;uniform float uOutlineEnabled;uniform vec4 uOutlineColor;uniform sampler2D texMaterialProperties;uniform sampler2D texObjectInfo;uniform sampler2D texColorMatrices;uniform sampler2D texElevationColors;uniform samplerCube texIrradiance;uniform samplerCube texEnvironment;in vec4 aPosition;in vec3 aNormal;in vec2 aTexcoord0;in vec3 aTexcoord1;out vec3 vPositionVS;out float vObjectIndex;out float vLinearZ;out vec3 vNormalVS;out vec3 vNormalWS;out vec2 vTextureCoord0;out float vObjectHighlight;out vec2 vTextureCoord1;out float vElevationTexCoord;bool bitTest(uint bits,uint bitValue){return(bits&bitValue)!=0U;}void main(){\n#if defined(RENDER_ELEVATION)\nif(uElevationRangeMin>uElevationRangeMax)return;\n#endif\nfloat w=uObjectInfoTextureSize.x;float h=uObjectInfoTextureSize.y;vec2 objectInfoUV=vec2((mod(aTexcoord1.z,w)+.5)/w,(floor(aTexcoord1.z/w)+.5)/h);float octantBits=round(aTexcoord1.x);if(octantBits!=float(0xff)&&!bitTest(uint(uOctantMask),uint(octantBits)))return;float objectHighlight=round(texture(texObjectInfo,objectInfoUV).x*255.);bool hidden=objectHighlight==255.;if(hidden)return;gl_Position=uModelClipMatrix*aPosition;vObjectHighlight=objectHighlight;vTextureCoord1=vec2(aTexcoord1.x,(aTexcoord1.y+0.5)/uNumMaterials);vPositionVS=vec3(uModelViewMatrix*aPosition);vObjectIndex=aTexcoord1.z;vLinearZ=-vPositionVS.z;vNormalVS=uModelViewMatrixNormal*aNormal;vNormalWS=uModelWorldMatrixNormal*aNormal;vTextureCoord0=aTexcoord0;vElevationTexCoord=(uElevationRangeMin==uElevationRangeMax)? 0.0 :((uModelWorldMatrix*aPosition).y-uElevationRangeMin)/(uElevationRangeMax-uElevationRangeMin);}",Ie="precision highp float;precision highp int;const int MaxClippingPlanes=6;uniform mat4 uModelClipMatrix;uniform mat4 uModelWorldMatrix;uniform mat4 uModelViewMatrix;uniform mat3 uModelWorldMatrixNormal;uniform mat3 uModelViewMatrixNormal;uniform mat3 uViewWorldMatrixNormal;uniform float uNumMaterials;uniform vec2 uObjectInfoTextureSize;uniform float uOctantMask;uniform vec4 uClippingPlanes[MaxClippingPlanes];uniform float uNumClippingPlanes;uniform bool uClipInside;uniform vec3 uSunDir;uniform float uSunBrightness;uniform float uAmbientLight;uniform vec4 uHeadlightColor;uniform float uHeadlightDistance;uniform float uElevationRangeMin,uElevationRangeMax;uniform float uMipCount;uniform float uOutlineEnabled;uniform vec4 uOutlineColor;uniform sampler2D texMaterialProperties;uniform sampler2D texObjectInfo;uniform sampler2D texColorMatrices;uniform sampler2D texElevationColors;uniform samplerCube texIrradiance;uniform samplerCube texEnvironment;in vec3 vPositionVS;in float vObjectIndex;in float vLinearZ;in vec3 vNormalVS;in vec3 vNormalWS;in vec2 vTextureCoord0;in float vObjectHighlight;in vec2 vTextureCoord1;in float vElevationTexCoord;layout(location=0)out vec4 fragColor;layout(location=1)out vec4 fragNormal;layout(location=2)out vec4 fragDepth;layout(location=3)out uvec2 fragInfo;const float GAMMA=2.2;const float INV_GAMMA=1.0/GAMMA;vec3 linearTosRGB(vec3 color){return pow(color,vec3(INV_GAMMA));}vec3 sRGBToLinear(vec3 srgbIn){return vec3(pow(srgbIn.xyz,vec3(GAMMA)));}vec3 toneMapACES_Narkowicz(vec3 color){const float A=2.51;const float B=0.03;const float C=2.43;const float D=0.59;const float E=0.14;return clamp((color*(A*color+B))/(color*(C*color+D)+E),0.0,1.0);}vec3 RRTAndODTFit(vec3 color){vec3 a=color*(color+0.0245786)-0.000090537;vec3 b=color*(0.983729*color+0.4329510)+0.238081;return a/b;}const float roughness=1.0;const float albedo=0.95;const float maxHDR=16.0;float phongSpecular(vec3 lightDirection,vec3 viewDirection,vec3 surfaceNormal,float shininess){vec3 R=-reflect(lightDirection,surfaceNormal);return pow(max(0.0,dot(viewDirection,R)),shininess);}\n#define PI 3.14159265\nfloat orenNayarDiffuse(vec3 lightDirection,vec3 viewDirection,vec3 surfaceNormal,float roughness,float albedo){float LdotV=dot(lightDirection,viewDirection);float NdotL=dot(lightDirection,surfaceNormal);float NdotV=dot(surfaceNormal,viewDirection);float s=LdotV-NdotL*NdotV;float t=mix(1.0,max(NdotL,NdotV),step(0.0,s));float sigma2=roughness*roughness;float A=1.0+sigma2*(albedo/(sigma2+0.13)+0.5/(sigma2+0.33));float B=0.45*sigma2/(sigma2+0.09);return albedo*max(0.0,NdotL)*(A+B*s/t)/PI;}const mat4 ditherThresholds=mat4(0.0/16.0,8.0/16.0,2.0/16.0,10.0/16.0,12.0/16.0,4.0/16.0,14.0/16.0,6.0/16.0,3.0/16.0,11.0/16.0,1.0/16.0,9.0/16.0,15.0/16.0,7.0/16.0,13.0/16.0,5.0/16.0);float dither(vec2 xy){int x=int(xy.x)&3;int y=int(xy.y)&3;return ditherThresholds[y][x];}bool intersectsViewPlane(float z){float zX=dFdx(z)+z;float zY=dFdy(z)+z;return(((z<=0.&&zX>0.)||(z>=0.&&zX<0.)||(z<=0.&&zY>0.)||(z>=0.&&zY<0.)));}void main(){\n#if defined(RENDER_OUTLINE)\nif(!intersectsViewPlane(vPositionVS.z))discard;\n#endif\nvec4 vPVS=vec4(vPositionVS,1);bool inside=uNumClippingPlanes>0.0;int nc=int(uNumClippingPlanes);for(int i=0;i<MaxClippingPlanes;i++){if(!inside||i>=nc)break;inside=dot(vPVS,uClippingPlanes[i])<=0.0;}if(inside==uClipInside)discard;\n#if defined(RENDER_ELEVATION)\nvec4 diffuseOpacity=texture(texElevationColors,vec2(vElevationTexCoord,0.0));\n#else\nvec4 diffuseOpacity=texture(texMaterialProperties,vec2(vTextureCoord1.y,0.5/2.0));\n#endif\ndiffuseOpacity.rgb=sRGBToLinear(diffuseOpacity.rgb);float objectHighlight=round(vObjectHighlight);float u=(objectHighlight+0.5)/256.0;mat4 colorTransform;colorTransform[0]=texture(texColorMatrices,vec2(u,0.5/5.0));colorTransform[1]=texture(texColorMatrices,vec2(u,1.5/5.0));colorTransform[2]=texture(texColorMatrices,vec2(u,2.5/5.0));colorTransform[3]=texture(texColorMatrices,vec2(u,3.5/5.0));vec4 colorTranslation=texture(texColorMatrices,vec2(u,4.5/5.0));diffuseOpacity=colorTransform*diffuseOpacity+colorTranslation;\n#if !defined(USE_ALPHA_BLEND)\nif((diffuseOpacity.a-0.5/16.0)<dither(gl_FragCoord.xy))discard;\n#endif\nif(diffuseOpacity.a==0.){discard;}fragNormal=vec4(normalize(gl_FrontFacing ? vNormalVS :-vNormalVS).xy,0,1);fragDepth=vec4(vLinearZ,0,0,1);fragInfo=uvec2(round(vObjectIndex),0);vec3 V=uViewWorldMatrixNormal*normalize(vPositionVS);vec3 N=normalize(gl_FrontFacing ? vNormalWS :-vNormalWS);vec3 irradiance=texture(texIrradiance,N).rgb;\n#if defined(RENDER_ELEVATION)\nvec4 specularShininess=vec4(0.0);vec3 reflection=vec3(0.0);\n#else\nvec4 specularShininess=texture(texMaterialProperties,vec2(vTextureCoord1.y,1.5/2.0));specularShininess.rgb=sRGBToLinear(specularShininess.rgb);float perceptualRoughness=clamp((1.0-specularShininess.a),0.0,1.0);perceptualRoughness*=perceptualRoughness;float lod=perceptualRoughness*(uMipCount-1.0);vec3 reflection=textureLod(texEnvironment,reflect(V,N),lod).rgb;\n#endif\nif(uSunBrightness>.0){vec3 L=uSunDir;if(specularShininess.a>0.0)reflection+=uSunBrightness*phongSpecular(L,-V,N,specularShininess.a*255.0)+uAmbientLight;irradiance+=uSunBrightness*orenNayarDiffuse(L,-V,N,roughness,albedo)+uAmbientLight;}else if(uAmbientLight>.0){if(specularShininess.a>0.0)reflection+=uAmbientLight;irradiance+=uAmbientLight;}if(uHeadlightColor.a>.0){float falloff=1.0-length(vPositionVS)/uHeadlightDistance;if(falloff>0.0){if(specularShininess.a>0.0)reflection+=uHeadlightColor.rgb*(phongSpecular(-V,V,N,specularShininess.a*255.0)*uHeadlightColor.a*falloff);irradiance+=uHeadlightColor.rgb*(orenNayarDiffuse(-V,V,N,roughness,albedo)*uHeadlightColor.a*falloff);}}vec3 color=diffuseOpacity.rgb*irradiance+specularShininess.rgb*reflection;\n#if defined(RENDER_OUTLINE)\nif(dot(uOutlineColor,uOutlineColor)==0.){color=diffuseOpacity.rgb;}else{color=uOutlineColor.rgb;diffuseOpacity.a=uOutlineColor.a;}\n#endif\nfragColor.rgb=color;\n#if defined(USE_ALPHA_BLEND)\nfragColor.a=diffuseOpacity.a;\n#else\nfragColor.a=1.0;\n#endif\n}",Pe=Y([{semantic:0,type:5126,components:3,normalize:!1},{semantic:1,type:5126,components:3,normalize:!1},{semantic:4,type:5126,components:2,normalize:!1},{semantic:22,type:5126,components:3,normalize:!1}]),Ne={0:"aPosition",1:"aNormal",4:"aTexcoord0",22:"aTexcoord1"},De={modelClipMatrix:["uModelClipMatrix","mat4"],modelWorldMatrix:["uModelWorldMatrix","mat4"],modelViewMatrix:["uModelViewMatrix","mat4"],modelWorldNormalMatrix:["uModelWorldMatrixNormal","mat3"],viewWorldNormalMatrix:["uViewWorldMatrixNormal","mat3"],modelViewNormalMatrix:["uModelViewMatrixNormal","mat3"],numMaterials:["uNumMaterials","float"],mipCount:["uMipCount","float"],objectInfoTextureSize:["uObjectInfoTextureSize","vec2"],octantMask:["uOctantMask","float",0],elevationRangeMin:["uElevationRangeMin","float",1],elevationRangeMax:["uElevationRangeMax","float",-1],clippingPlanes0:["uClippingPlanes[0]","vec4",V()],clippingPlanes1:["uClippingPlanes[1]","vec4",V()],clippingPlanes2:["uClippingPlanes[2]","vec4",V()],clippingPlanes3:["uClippingPlanes[3]","vec4",V()],clippingPlanes4:["uClippingPlanes[4]","vec4",V()],clippingPlanes5:["uClippingPlanes[5]","vec4",V()],numClippingPlanes:["uNumClippingPlanes","float"],clipInside:["uClipInside","bool"],headlightColor:["uHeadlightColor","vec4"],headlightDistance:["uHeadlightDistance","float"],sunDirection:["uSunDir","vec3"],sunBrightness:["uSunBrightness","float"],ambientLight:["uAmbientLight","float"],outlineEnabled:["uOutlineEnabled","float",0],outlineColor:["uOutlineColor","vec4",V()]},Ve={type:3553,10240:9728,10241:9728,10242:33071,10243:33071},_e=[{textureSemantic:"material_properties",shaderUniform:"texMaterialProperties",samplerState:Ve},{textureSemantic:"object_info",shaderUniform:"texObjectInfo",samplerState:Ve},{textureSemantic:"color_matrix",shaderUniform:"texColorMatrices",samplerState:Ve},{textureSemantic:"elevation",shaderUniform:"texElevationColors",samplerState:Ve},{textureSemantic:"irradiance",shaderUniform:"texIrradiance",samplerState:{type:34067,10240:9729,10241:9729,10242:33071,10243:33071}},{textureSemantic:"radiance",shaderUniform:"texEnvironment",samplerState:{type:34067,10240:9729,10241:9987,10242:33071,10243:33071}}],Ee=[36064,36065,36066,36067],Be=[36064];class Oe extends Q{cameraUniforms={modelWorldMatrix:b(),modelClipMatrix:b(),modelViewMatrix:b()};constructor(e,t,o){super(e,t,o)}isDoubleSided=e=>e.settings.advanced.doubleSided.opaque;computeUniforms=e=>{const{settings:t,cameraUniforms:o,textures:r,sceneTextures:i}=e,n=_(1,1,1,t.light.camera.brightness),a=t.light.camera?.distance??10;let s={},l=0,u=!0;if(t.clippingPlanes&&t.clippingPlanes.enabled){const e=[_(-1,0,0,t.clippingPlanes.bounds.min[0]),_(0,-1,0,t.clippingPlanes.bounds.min[1]),_(0,0,-1,t.clippingPlanes.bounds.min[2]),_(1,0,0,-t.clippingPlanes.bounds.max[0]),_(0,1,0,-t.clippingPlanes.bounds.max[1]),_(0,0,1,-t.clippingPlanes.bounds.max[2])],r=y(b(),o.worldViewMatrix);C(r,r);for(const t of e)O(t,t,r);for(let t=0;t<6;t++)s[`clippingPlanes${t}`]=e[t];l=6,u=t.clippingPlanes.inside}const{clippingVolume:c}=t;if(c.enabled){const e="intersection"==c.mode,t=[V(),V(),V(),V(),V(),V()],{planes:r}=c;l=Math.min(6,r.length);for(let o=0;o<l;o++)e?B(t[o],r[o]):E(t[o],r[o]);const i=y(b(),o.worldViewMatrix);C(i,i);for(const e of t)O(e,e,i);for(let e=0;e<6;e++)s[`clippingPlanes${e}`]=t[e];u=e}const f=t.light.sun?.brightness??0,m=me(t.light.sun?.position),d=t.light.ambient?.brightness??0,p=this.textureReferences.radiance??i.radiance,x=void 0!==p?r.getTexture(p):void 0,h=x?x.mips:1;this.state={...this.state,2884:!this.isDoubleSided(e)};const v=e.settings.outline.enable?1:0,g=e.settings.outline.color??[0,0,0,0];return{headlightColor:n,headlightDistance:a,sunBrightness:f,sunDirection:m,ambientLight:d,...s,numClippingPlanes:l,clipInside:u,mipCount:h,outlineEnabled:v,outlineColor:g}};computeMeshUniforms=(e,t)=>{const{cameraUniforms:o}=e,{modelWorldMatrix:r,modelClipMatrix:i,modelViewMatrix:n}=this.cameraUniforms;return t.modelWorldMatrix?(M(r,t.modelWorldMatrix),S(i,o.worldClipMatrix,r),S(n,o.worldViewMatrix,r)):(M(r,o.modelWorldMatrix),M(i,o.modelClipMatrix),M(n,o.modelViewMatrix)),this.cameraUniforms};state={...k,3024:!1,2929:!0,2930:!0,2884:!0,2932:515}}!function(e){e.contextData={shaders:{vertex:Te,fragment:Ie,flags:[]},vertexLayout:Pe,vertexSemanticNames:Ne,uniforms:De,textureSlots:_e,drawBuffers:Ee},e.outlineVariant="octree_outline",e.isDoubleSided=function(e){throw new Error("Function not implemented.")}}(Oe||(Oe={}));class Ue extends Oe{constructor(e,t,o){super(e,t,o)}state={...k,3024:!1,2929:!0,2930:!1,2884:!0,3042:!0,32969:770,32971:1,32968:771,32970:1,2932:515};drawBuffers(e){return e.settings.pickBuffer.includeTransparent?Ee:Be}isDoubleSided=e=>e.settings.advanced.doubleSided.transparent}(Ue||(Ue={})).contextData={shaders:{vertex:Te,fragment:Ie,flags:["USE_ALPHA_BLEND"]},vertexLayout:Pe,vertexSemanticNames:Ne,uniforms:De,textureSlots:_e,drawBuffers:Ee,renderOrder:1};class ze extends Oe{constructor(e,t,o){super(e,t,o)}isDoubleSided=e=>!0}(ze||(ze={})).contextData={...Oe.contextData};class Le extends Ue{constructor(e,t,o){super(e,t,o)}isDoubleSided=e=>!0}(Le||(Le={})).contextData={...Ue.contextData};class Re extends Oe{constructor(e,t,o){super(e,t,o)}}(Re||(Re={})).contextData={...Oe.contextData,shaders:{...Oe.contextData.shaders,flags:["RENDER_OUTLINE"]},drawBuffers:Be};class Ae extends ze{constructor(e,t,o){super(e,t,o)}}(Ae||(Ae={})).contextData={...ze.contextData,shaders:{...ze.contextData.shaders,flags:["RENDER_OUTLINE"]}};class je extends Oe{constructor(e,t,o){super(e,t,o)}cleanup(e){return super.cleanup(e),e.settings.terrain.asBackground}}!function(e){e.contextData={...Oe.contextData,shaders:{...Oe.contextData.shaders,flags:["RENDER_ELEVATION"]},renderOrder:-5},e.objectIndexVariant="octree_terrain_pick",e.depthVariant="octree_terrain_depth",e.normalVariant="octree_terrain_normal"}(je||(je={}));const Fe="precision highp float;precision highp int;const int MaxClippingPlanes=6;uniform mat4 uModelClipMatrix;uniform mat4 uModelWorldMatrix;uniform mat4 uModelViewMatrix;uniform mat3 uModelWorldMatrixNormal;uniform mat3 uModelViewMatrixNormal;uniform mat3 uViewWorldMatrixNormal;uniform vec2 uObjectInfoTextureSize;uniform float uOctantMask;uniform vec4 uClippingPlanes[MaxClippingPlanes];uniform float uNumClippingPlanes;uniform bool uClipInside;uniform float uOutlineEnabled;uniform vec4 uOutlineColor;uniform sampler2D texAlbedo;uniform sampler2D texObjectInfo;uniform sampler2D texColorMatrices;in vec4 aPosition;in vec2 aTexcoord0;in vec3 aTexcoord1;out vec3 vPositionVS;out float vObjectIndex;out float vLinearZ;out vec2 vTextureCoord0;out float vObjectHighlight;bool bitTest(uint bits,uint bitValue){return(bits&bitValue)!=0U;}void main(){float w=uObjectInfoTextureSize.x;float h=uObjectInfoTextureSize.y;vec2 objectInfoUV=vec2((mod(aTexcoord1.z,w)+0.5)/w,(floor(aTexcoord1.z/w)+0.5)/h);float octantBits=round(aTexcoord1.x);if(octantBits!=float(0xff)&&!bitTest(uint(uOctantMask),uint(octantBits)))return;float objectHighlight=round(texture(texObjectInfo,objectInfoUV).x*255.0);bool hidden=objectHighlight==255.0;if(hidden)return;vObjectHighlight=objectHighlight;gl_Position=uModelClipMatrix*aPosition;vPositionVS=vec3(uModelViewMatrix*aPosition);vLinearZ=-vPositionVS.z;vObjectIndex=aTexcoord1.z;vTextureCoord0=aTexcoord0;}",Ge="precision highp float;precision highp int;const int MaxClippingPlanes=6;uniform mat4 uModelClipMatrix;uniform mat4 uModelWorldMatrix;uniform mat4 uModelViewMatrix;uniform mat3 uModelWorldMatrixNormal;uniform mat3 uModelViewMatrixNormal;uniform mat3 uViewWorldMatrixNormal;uniform vec2 uObjectInfoTextureSize;uniform float uOctantMask;uniform vec4 uClippingPlanes[MaxClippingPlanes];uniform float uNumClippingPlanes;uniform bool uClipInside;uniform float uOutlineEnabled;uniform vec4 uOutlineColor;uniform sampler2D texAlbedo;uniform sampler2D texObjectInfo;uniform sampler2D texColorMatrices;in vec3 vPositionVS;in float vObjectIndex;in float vLinearZ;in vec2 vTextureCoord0;in float vObjectHighlight;layout(location=0)out vec4 fragColor;layout(location=1)out vec2 fragNormal;layout(location=2)out float fragDepth;layout(location=3)out uvec2 fragInfo;const float GAMMA=2.2;const float INV_GAMMA=1.0/GAMMA;vec3 linearTosRGB(vec3 color){return pow(color,vec3(INV_GAMMA));}vec3 sRGBToLinear(vec3 srgbIn){return vec3(pow(srgbIn.xyz,vec3(GAMMA)));}vec3 toneMapACES_Narkowicz(vec3 color){const float A=2.51;const float B=0.03;const float C=2.43;const float D=0.59;const float E=0.14;return clamp((color*(A*color+B))/(color*(C*color+D)+E),0.0,1.0);}vec3 RRTAndODTFit(vec3 color){vec3 a=color*(color+0.0245786)-0.000090537;vec3 b=color*(0.983729*color+0.4329510)+0.238081;return a/b;}const float maxHDR=16.0;const mat4 ditherThresholds=mat4(0.0/16.0,8.0/16.0,2.0/16.0,10.0/16.0,12.0/16.0,4.0/16.0,14.0/16.0,6.0/16.0,3.0/16.0,11.0/16.0,1.0/16.0,9.0/16.0,15.0/16.0,7.0/16.0,13.0/16.0,5.0/16.0);float dither(vec2 xy){int x=int(xy.x)&3;int y=int(xy.y)&3;return ditherThresholds[y][x];}bool intersectsViewPlane(float z){float zX=dFdx(z)+z;float zY=dFdy(z)+z;return(((z<=0.&&zX>0.)||(z>=0.&&zX<0.)||(z<=0.&&zY>0.)||(z>=0.&&zY<0.)));}void main(){\n#if defined(RENDER_OUTLINE)\nif(!intersectsViewPlane(vPositionVS.z))discard;\n#endif\nvec4 vPVS=vec4(vPositionVS,1);bool inside=uNumClippingPlanes>0.0;int nc=int(uNumClippingPlanes);for(int i=0;i<MaxClippingPlanes;i++){if(!inside||i>=nc)break;inside=dot(vPVS,uClippingPlanes[i])<=0.0;}if(inside==uClipInside)discard;vec4 diffuseOpacity=texture(texAlbedo,vTextureCoord0);float objectHighlight=round(vObjectHighlight);float u=(objectHighlight+0.5)/256.0;mat4 colorTransform;colorTransform[0]=texture(texColorMatrices,vec2(u,0.5/5.0));colorTransform[1]=texture(texColorMatrices,vec2(u,1.5/5.0));colorTransform[2]=texture(texColorMatrices,vec2(u,2.5/5.0));colorTransform[3]=texture(texColorMatrices,vec2(u,3.5/5.0));vec4 colorTranslation=texture(texColorMatrices,vec2(u,4.5/5.0));diffuseOpacity=colorTransform*diffuseOpacity+colorTranslation;if((diffuseOpacity.a-0.5/16.0)<dither(gl_FragCoord.xy))discard;vec3 ng=normalize(cross(dFdx(vPositionVS),dFdy(vPositionVS)));if(diffuseOpacity.a>=1.0){fragNormal=normalize(gl_FrontFacing ? ng :-ng).xy;fragDepth=vLinearZ;fragInfo=uvec2(round(vObjectIndex),0);}\n#if defined(RENDER_OUTLINE)\nif(dot(uOutlineColor,uOutlineColor)!=0.){diffuseOpacity.rgb=uOutlineColor.rgb;}\n#endif\nfragColor.rgb=diffuseOpacity.rgb;fragColor.a=1.0;}",We=Y([{semantic:0,type:5126,components:3,normalize:!1},{semantic:1,type:5126,components:3,normalize:!1},{semantic:4,type:5126,components:2,normalize:!1},{semantic:22,type:5126,components:3,normalize:!1}]),ke={0:"aPosition",1:"aNormal",4:"aTexcoord0",22:"aTexcoord1"},He={modelClipMatrix:["uModelClipMatrix","mat4"],modelWorldMatrix:["uModelWorldMatrix","mat4"],modelViewMatrix:["uModelViewMatrix","mat4"],modelWorldNormalMatrix:["uModelWorldMatrixNormal","mat3"],viewWorldNormalMatrix:["uViewWorldMatrixNormal","mat3"],modelViewNormalMatrix:["uModelViewMatrixNormal","mat3"],objectInfoTextureSize:["uObjectInfoTextureSize","vec2"],octantMask:["uOctantMask","float",0],clippingPlanes0:["uClippingPlanes[0]","vec4",V()],clippingPlanes1:["uClippingPlanes[1]","vec4",V()],clippingPlanes2:["uClippingPlanes[2]","vec4",V()],clippingPlanes3:["uClippingPlanes[3]","vec4",V()],clippingPlanes4:["uClippingPlanes[4]","vec4",V()],clippingPlanes5:["uClippingPlanes[5]","vec4",V()],numClippingPlanes:["uNumClippingPlanes","float"],clipInside:["uClipInside","bool"],outlineEnabled:["uOutlineEnabled","float",0],outlineColor:["uOutlineColor","vec4",V()]},qe={type:3553,10240:9728,10241:9728,10242:33071,10243:33071},Xe=[{textureSemantic:"albedo",shaderUniform:"texAlbedo",samplerState:{type:3553,10240:9729,10241:9729,10242:33071,10243:33071}},{textureSemantic:"object_info",shaderUniform:"texObjectInfo",samplerState:qe},{textureSemantic:"color_matrix",shaderUniform:"texColorMatrices",samplerState:qe}],Qe=[36064,36065,36066,36067];class Ze extends Q{cameraUniforms={modelWorldMatrix:b(),modelClipMatrix:b(),modelViewMatrix:b()};constructor(e,t,o){super(e,t,o)}isDoubleSided=e=>!0;computeUniforms=e=>{const{settings:t,cameraUniforms:o}=e;let r={},i=0,n=!0;if(t.clippingPlanes&&t.clippingPlanes.enabled){const e=[_(-1,0,0,t.clippingPlanes.bounds.min[0]),_(0,-1,0,t.clippingPlanes.bounds.min[1]),_(0,0,-1,t.clippingPlanes.bounds.min[2]),_(1,0,0,-t.clippingPlanes.bounds.max[0]),_(0,1,0,-t.clippingPlanes.bounds.max[1]),_(0,0,1,-t.clippingPlanes.bounds.max[2])],a=y(b(),o.worldViewMatrix);C(a,a);for(const t of e)O(t,t,a);for(let t=0;t<6;t++)r[`clippingPlanes${t}`]=e[t];i=6,n=t.clippingPlanes.inside}const{clippingVolume:a}=t;if(a.enabled){const e="intersection"==a.mode,t=[V(),V(),V(),V(),V(),V()],{planes:s}=a;i=Math.min(6,s.length);for(let o=0;o<i;o++)e?B(t[o],s[o]):E(t[o],s[o]);const l=y(b(),o.worldViewMatrix);C(l,l);for(const e of t)O(e,e,l);for(let e=0;e<6;e++)r[`clippingPlanes${e}`]=t[e];n=e}this.state={...this.state,2884:!this.isDoubleSided(e)};const s=e.settings.outline.enable?1:0,l=e.settings.outline.color??[0,0,0,0];return{...r,numClippingPlanes:i,clipInside:n,outlineEnabled:s,outlineColor:l}};computeMeshUniforms=(e,t)=>{const{cameraUniforms:o}=e,{modelWorldMatrix:r,modelClipMatrix:i,modelViewMatrix:n}=this.cameraUniforms;return t.modelWorldMatrix?(M(r,t.modelWorldMatrix),S(i,o.worldClipMatrix,r),S(n,o.worldViewMatrix,r)):(M(r,o.modelWorldMatrix),M(i,o.modelClipMatrix),M(n,o.modelViewMatrix)),this.cameraUniforms};cleanup(e){return super.cleanup(e),e.settings.terrain.asBackground}state={...k,3024:!1,2929:!0,2884:!0,2932:515}}!function(e){e.contextData={shaders:{vertex:Fe,fragment:Ge,flags:[]},vertexLayout:We,vertexSemanticNames:ke,uniforms:He,textureSlots:Xe,drawBuffers:Qe,renderOrder:-5},e.isDoubleSided=function(e){throw new Error("Function not implemented.")}}(Ze||(Ze={}));class Ye extends Ze{cleanup(e){return super.cleanup(e),!1}}!function(e){e.contextData={shaders:{vertex:Fe,fragment:Ge,flags:[]},vertexLayout:We,vertexSemanticNames:ke,uniforms:He,drawBuffers:Qe,textureSlots:Xe},e.isDoubleSided=function(e){throw new Error("Function not implemented.")}}(Ye||(Ye={}));const $e="precision highp float;precision highp int;const int MaxClippingPlanes=6;uniform mat4 uModelViewMatrix;uniform mat4 uViewClipMatrix;uniform vec2 uWindowSize;uniform vec2 uObjectInfoTextureSize;uniform float uOctantMask;uniform float uPixelSize;uniform float uMaxPixelSize;uniform float uMetricSize;uniform float uTolerance;uniform float uToleranceFactor;uniform bool uRenderAsDisc;uniform vec4 uClippingPlanes[MaxClippingPlanes];uniform float uNumClippingPlanes;uniform bool uClipInside;uniform sampler2D texObjectInfo;uniform sampler2D texColorMatrices;uniform sampler2D texDeviationColors;uniform int uMode;uniform int uIndex;uniform float uDeviationRangeMin;uniform float uDeviationRangeMax;uniform sampler2D texIntensityColors;uniform int uIntensityMode;uniform float uIntensityRangeMin;uniform float uIntensityRangeMax;in vec4 aPosition;in vec3 aColor;in vec3 aObjectInfo;in float aDeviation;in float aDeviation1;in float aIntensity;out float vObjectIndex;out float vLinearZ;out float vDeviation;out float vIntensity;out vec4 vColor;out vec2 vScreenPos;out float vRadius;out vec4 posVS;out float vObjectHighlight;bool bitTest(uint bits,uint bitValue){return(bits&bitValue)!=0U;}void main(){float octantBits=round(aObjectInfo.x);if(octantBits!=float(0xff)&&!bitTest(uint(uOctantMask),uint(octantBits)))return;float objectIndex=aObjectInfo.z;float w=uObjectInfoTextureSize.x;float h=uObjectInfoTextureSize.y;vec2 objectInfoUV=vec2((mod(objectIndex,w)+0.5)/w,(floor(objectIndex/w)+0.5)/h);vObjectHighlight=round(texture(texObjectInfo,objectInfoUV).x*255.0);bool hidden=vObjectHighlight==255.0;posVS=uModelViewMatrix*aPosition;vColor=vec4(aColor,1.0);float linearSize=uMetricSize+uTolerance*uToleranceFactor;gl_Position=uViewClipMatrix*posVS;float projectedSize=uViewClipMatrix[1][1]*linearSize*uWindowSize.y*0.5/gl_Position.w;gl_PointSize=hidden ? 0. : min(uMaxPixelSize,max(1.0,uPixelSize+projectedSize));vec2 halfsize=uWindowSize*0.5;vScreenPos=halfsize+((gl_Position.xy/gl_Position.w)*halfsize);vRadius=hidden ? 0. : max(1.0,gl_PointSize*0.5);vObjectIndex=objectIndex;vLinearZ=-posVS.z;vDeviation=uIndex>0 ? aDeviation1 : aDeviation;vIntensity=aIntensity;}",Ke="precision highp float;precision highp int;const float NaN=.0/.0;const int MaxClippingPlanes=6;uniform mat4 uModelViewMatrix;uniform mat4 uViewClipMatrix;uniform vec2 uWindowSize;uniform vec2 uObjectInfoTextureSize;uniform float uOctantMask;uniform float uPixelSize;uniform float uMaxPixelSize;uniform float uMetricSize;uniform float uTolerance;uniform float uToleranceFactor;uniform bool uRenderAsDisc;uniform vec4 uClippingPlanes[MaxClippingPlanes];uniform float uNumClippingPlanes;uniform bool uClipInside;uniform sampler2D texObjectInfo;uniform sampler2D texColorMatrices;uniform sampler2D texDeviationColors;uniform int uMode;uniform float uDeviationRangeMin;uniform float uDeviationRangeMax;uniform sampler2D texIntensityColors;uniform int uIntensityMode;uniform float uIntensityRangeMin;uniform float uIntensityRangeMax;in float vObjectIndex;in float vLinearZ;in float vDeviation;in float vIntensity;in vec4 vColor;in vec2 vScreenPos;in float vRadius;in vec4 posVS;in float vObjectHighlight;layout(location=0)out vec4 fragColor;layout(location=1)out vec2 fragNormal;layout(location=2)out float fragDepth;layout(location=3)out uvec2 fragInfo;const mat4 ditherThresholds=mat4(0.0/16.0,8.0/16.0,2.0/16.0,10.0/16.0,12.0/16.0,4.0/16.0,14.0/16.0,6.0/16.0,3.0/16.0,11.0/16.0,1.0/16.0,9.0/16.0,15.0/16.0,7.0/16.0,13.0/16.0,5.0/16.0);float dither(vec2 xy){int x=int(xy.x)&3;int y=int(xy.y)&3;return ditherThresholds[y][x];}void main(){if(vRadius<0.5){discard;}bool inside=uNumClippingPlanes>0.0;int nc=int(uNumClippingPlanes);for(int i=0;i<MaxClippingPlanes;i++){if(!inside||i>=nc)break;inside=dot(posVS,uClippingPlanes[i])<=0.0;}if(inside==uClipInside)discard;float u=(vObjectHighlight+0.5)/256.0;mat4 colorTransform;colorTransform[0]=texture(texColorMatrices,vec2(u,0.1));colorTransform[1]=texture(texColorMatrices,vec2(u,0.3));colorTransform[2]=texture(texColorMatrices,vec2(u,0.5));colorTransform[3]=texture(texColorMatrices,vec2(u,0.7));vec4 colorTranslation=texture(texColorMatrices,vec2(u,0.9));vec4 color=vColor;if(uMode>0){float deviationTexCoord=(uDeviationRangeMin>=uDeviationRangeMax)? 0.0 :(vDeviation-uDeviationRangeMin)/(uDeviationRangeMax-uDeviationRangeMin);vec4 devcolor=texture(texDeviationColors,vec2(deviationTexCoord,0.0));if(uMode==1){if(devcolor.a<0.1)discard;color=devcolor;}else if(devcolor.a>0.99)color.rgb=devcolor.rgb;else if(devcolor.a>0.01)color.rgb=vColor.rgb*(1.0-devcolor.a)+devcolor.rgb*devcolor.a;}if(uIntensityMode>0){float intensityTexCoord=(uIntensityRangeMin>=uIntensityRangeMax)? 0.0 :(vIntensity-uIntensityRangeMin)/(uIntensityRangeMax-uIntensityRangeMin);vec4 intcolor=texture(texIntensityColors,vec2(intensityTexCoord,0.0));if(uIntensityMode==1){if(intcolor.a<0.1)discard;color=intcolor;}else if(intcolor.a>0.99)color.rgb=intcolor.rgb;else if(intcolor.a>0.01)color.rgb=vColor.rgb*(1.0-intcolor.a)+intcolor.rgb*intcolor.a;}color=colorTransform*color+colorTranslation;if(uRenderAsDisc&&distance(gl_FragCoord.xy,vScreenPos)>vRadius)discard;if((color.a-0.5/16.0)<dither(gl_FragCoord.xy))discard;fragColor=vec4(color.rgb,1.0);fragNormal=vec2(NaN,NaN);fragDepth=vLinearZ;fragInfo=uvec2(round(vObjectIndex),packHalf2x16(vec2(vDeviation,vIntensity)));}",Je=Y([{semantic:0,type:5126,components:3,normalize:!1},{semantic:12,type:5126,components:3,normalize:!1},{semantic:22,type:5126,components:3,normalize:!1}]),et={modelViewMatrix:["uModelViewMatrix","mat4"],viewClipMatrix:["uViewClipMatrix","mat4"],objectInfoTextureSize:["uObjectInfoTextureSize","vec2"],octantMask:["uOctantMask","float",0],clippingPlanes0:["uClippingPlanes[0]","vec4",V()],clippingPlanes1:["uClippingPlanes[1]","vec4",V()],clippingPlanes2:["uClippingPlanes[2]","vec4",V()],clippingPlanes3:["uClippingPlanes[3]","vec4",V()],clippingPlanes4:["uClippingPlanes[4]","vec4",V()],clippingPlanes5:["uClippingPlanes[5]","vec4",V()],numClippingPlanes:["uNumClippingPlanes","float"],clipInside:["uClipInside","bool"],windowSize:["uWindowSize","vec2"],pixelSize:["uPixelSize","float"],maxPixelSize:["uMaxPixelSize","float",20],metricSize:["uMetricSize","float"],tolerance:["uTolerance","float",0],toleranceFactor:["uToleranceFactor","float"],renderAsDisc:["uRenderAsDisc","bool"]},tt={type:3553,10240:9728,10241:9728,10242:33071,10243:33071},ot=[{textureSemantic:"material_properties",shaderUniform:"texMaterialProperties",samplerState:tt},{textureSemantic:"object_info",shaderUniform:"texObjectInfo",samplerState:tt},{textureSemantic:"color_matrix",shaderUniform:"texColorMatrices",samplerState:tt}];class rt extends Q{modelViewMatrix=b();meshUniforms;constructor(e,t,o){super(e,t,o);const{modelViewMatrix:r}=this;this.meshUniforms={modelViewMatrix:r}}state={...k,3024:!1,2929:!0,2930:!0,2932:515};computeUniforms=this._computeUniforms;_computeUniforms(e){const{settings:t,cameraUniforms:o}=e,{points:r}=t,{width:i}=o,{drawingBufferWidth:n,drawingBufferHeight:a}=e.gl,s=z(n,a);let l=0,u=0,c=0,f=!0,m=20;if(r){f="disc"==r.shape;const{size:e}=r;e&&(l=(e.pixel??0)*n/i,m=(e.maxPixel??20)*n/i,u=e.metric??0,c=e.toleranceFactor??0)}let d={},p=0,x=!0;if(t.clippingPlanes&&t.clippingPlanes.enabled){const e=[_(-1,0,0,t.clippingPlanes.bounds.min[0]),_(0,-1,0,t.clippingPlanes.bounds.min[1]),_(0,0,-1,t.clippingPlanes.bounds.min[2]),_(1,0,0,-t.clippingPlanes.bounds.max[0]),_(0,1,0,-t.clippingPlanes.bounds.max[1]),_(0,0,1,-t.clippingPlanes.bounds.max[2])],r=y(b(),o.worldViewMatrix);C(r,r);for(const t of e)O(t,t,r);for(let t=0;t<6;t++)d[`clippingPlanes${t}`]=e[t];p=6,x=t.clippingPlanes.inside}const{clippingVolume:h}=t;if(h.enabled){const e="intersection"==h.mode,t=[V(),V(),V(),V(),V(),V()],{planes:r}=h;p=Math.min(6,r.length);for(let o=0;o<p;o++)e?B(t[o],r[o]):E(t[o],r[o]);const i=y(b(),o.worldViewMatrix);C(i,i);for(const e of t)O(e,e,i);for(let e=0;e<6;e++)d[`clippingPlanes${e}`]=t[e];x=e}return{windowSize:s,pixelSize:l,maxPixelSize:m,metricSize:u,toleranceFactor:c,renderAsDisc:f,...d,numClippingPlanes:p,clipInside:x}}computeMeshUniforms=(e,t)=>{const{cameraUniforms:o}=e,{modelViewMatrix:r,meshUniforms:i}=this,{modelWorldMatrix:n}=t;return n?S(r,o.worldViewMatrix,n):M(r,o.modelViewMatrix),i}}(rt||(rt={})).contextData={shaders:{vertex:$e,fragment:Ke,flags:[]},vertexLayout:Je,vertexSemanticNames:{0:"aPosition",12:"aColor",22:"aObjectInfo"},uniforms:et,textureSlots:ot,drawBuffers:[36064,36065,36066,36067]};const it=Y([{semantic:0,type:5126,components:3,normalize:!1},{semantic:12,type:5126,components:3,normalize:!1},{semantic:13,type:5126,components:1,normalize:!1},{semantic:22,type:5126,components:3,normalize:!1}]),nt=Y([{semantic:0,type:5126,components:3,normalize:!1},{semantic:12,type:5126,components:3,normalize:!1},{semantic:13,type:5126,components:1,normalize:!1},{semantic:15,type:5126,components:1,normalize:!1},{semantic:22,type:5126,components:3,normalize:!1}]),at={deviationRangeMin:["uDeviationRangeMin","float",1],deviationRangeMax:["uDeviationRangeMax","float",-1],deviationMode:["uMode","int",0],deviationIndex:["uIndex","int",0]},st={type:3553,10240:9728,10241:9728,10242:33071,10243:33071},lt=[{textureSemantic:"material_properties",shaderUniform:"texMaterialProperties",samplerState:st},{textureSemantic:"object_info",shaderUniform:"texObjectInfo",samplerState:st},{textureSemantic:"color_matrix",shaderUniform:"texColorMatrices",samplerState:st},{textureSemantic:"deviation",shaderUniform:"texDeviationColors",samplerState:st}],ut=[36064,36065,36066,36067];class ct extends rt{constructor(e,t,o){super(e,t,o)}computeUniforms=e=>{const t=this._computeUniforms(e),{mode:o,index:r}=e.settings.points.deviation;let i=0;if(0==r)switch(o){case"on":i=1;break;case"mix":i=2}return{...t,deviationMode:i,deviationIndex:0}}}(ct||(ct={})).contextData={shaders:{vertex:$e,fragment:Ke,flags:["DEVIATION"]},vertexLayout:it,vertexSemanticNames:{0:"aPosition",12:"aColor",13:"aDeviation",22:"aObjectInfo"},uniforms:{...rt.contextData.uniforms,...at},textureSlots:lt,drawBuffers:ut};class ft extends rt{constructor(e,t,o){super(e,t,o)}computeUniforms=e=>{const t=this._computeUniforms(e),{mode:o,index:r}=e.settings.points.deviation;let i=0,n=r;switch(o){case"on":i=1;break;case"mix":i=2}return{...t,deviationMode:i,deviationIndex:n}}}(ft||(ft={})).contextData={shaders:{vertex:$e,fragment:Ke,flags:["DEVIATION","DEVIATION1"]},vertexLayout:nt,vertexSemanticNames:{0:"aPosition",12:"aColor",13:"aDeviation",15:"aDeviation1",22:"aObjectInfo"},uniforms:{...rt.contextData.uniforms,...at},textureSlots:lt,drawBuffers:ut};const mt=Y([{semantic:0,type:5126,components:3,normalize:!1},{semantic:12,type:5126,components:3,normalize:!1},{semantic:14,type:5126,components:1,normalize:!1},{semantic:22,type:5126,components:3,normalize:!1}]),dt={type:3553,10240:9728,10241:9728,10242:33071,10243:33071},pt=[{textureSemantic:"material_properties",shaderUniform:"texMaterialProperties",samplerState:dt},{textureSemantic:"object_info",shaderUniform:"texObjectInfo",samplerState:dt},{textureSemantic:"color_matrix",shaderUniform:"texColorMatrices",samplerState:dt},{textureSemantic:"intensity",shaderUniform:"texIntensityColors",samplerState:dt}];class xt extends rt{constructor(e,t,o){super(e,t,o)}computeUniforms=e=>{const t=this._computeUniforms(e),{mode:o}=e.settings.points.intensity;let r=0;switch(o){case"on":r=1;break;case"mix":r=2}return{...t,intensityMode:r}}}(xt||(xt={})).contextData={shaders:{vertex:$e,fragment:Ke,flags:["INTENSITY"]},vertexLayout:mt,vertexSemanticNames:{0:"aPosition",12:"aColor",14:"aIntensity",22:"aObjectInfo"},uniforms:{...rt.contextData.uniforms,intensityRangeMin:["uIntensityRangeMin","float",1],intensityRangeMax:["uIntensityRangeMax","float",-1],intensityMode:["uIntensityMode","int",0]},textureSlots:pt,drawBuffers:[36064,36065,36066,36067]};const ht=Y([{semantic:0,type:5126,components:3,normalize:!1},{semantic:12,type:5126,components:3,normalize:!1},{semantic:13,type:5126,components:1,normalize:!1},{semantic:14,type:5126,components:1,normalize:!1},{semantic:22,type:5126,components:3,normalize:!1}]),vt=Y([{semantic:0,type:5126,components:3,normalize:!1},{semantic:12,type:5126,components:3,normalize:!1},{semantic:13,type:5126,components:1,normalize:!1},{semantic:14,type:5126,components:1,normalize:!1},{semantic:15,type:5126,components:1,normalize:!1},{semantic:22,type:5126,components:3,normalize:!1}]),gt={0:"aPosition",12:"aColor",13:"aDeviation",14:"aIntensity",15:"aDeviation1",22:"aObjectInfo"},bt={deviationRangeMin:["uDeviationRangeMin","float",1],deviationRangeMax:["uDeviationRangeMax","float",-1],deviationMode:["uMode","int",0],deviationIndex:["uIndex","int",0],intensityRangeMin:["uIntensityRangeMin","float",1],intensityRangeMax:["uIntensityRangeMax","float",-1],intensityMode:["uIntensityMode","int",0]},Mt={type:3553,10240:9728,10241:9728,10242:33071,10243:33071},Ct=[{textureSemantic:"material_properties",shaderUniform:"texMaterialProperties",samplerState:Mt},{textureSemantic:"object_info",shaderUniform:"texObjectInfo",samplerState:Mt},{textureSemantic:"color_matrix",shaderUniform:"texColorMatrices",samplerState:Mt},{textureSemantic:"deviation",shaderUniform:"texDeviationColors",samplerState:Mt},{textureSemantic:"intensity",shaderUniform:"texIntensityColors",samplerState:Mt}],yt=[36064,36065,36066,36067];class St extends rt{constructor(e,t,o){super(e,t,o)}computeUniforms=e=>{const t=this._computeUniforms(e);let o=0;{const{mode:t,index:r}=e.settings.points.deviation;if(0==r)switch(t){case"on":o=1;break;case"mix":o=2}}return{...t,deviationMode:o,deviationIndex:0,intensityMode:0}}}(St||(St={})).contextData={shaders:{vertex:$e,fragment:Ke,flags:["DEVIATION","INTENSITY"]},vertexLayout:ht,vertexSemanticNames:{0:"aPosition",12:"aColor",13:"aDeviation",14:"aIntensity",22:"aObjectInfo"},uniforms:{...rt.contextData.uniforms,...bt},textureSlots:Ct,drawBuffers:yt};class wt extends rt{constructor(e,t,o){super(e,t,o)}computeUniforms=e=>{const t=this._computeUniforms(e);let o=0,r=0;{const{mode:t,index:i}=e.settings.points.deviation;switch(r=i,t){case"on":o=1;break;case"mix":o=2}}return{...t,deviationMode:o,deviationIndex:r,intensityMode:0}}}(wt||(wt={})).contextData={shaders:{vertex:$e,fragment:Ke,flags:["DEVIATION","DEVIATION1","INTENSITY"]},vertexLayout:vt,vertexSemanticNames:gt,uniforms:{...rt.contextData.uniforms,...bt},textureSlots:Ct,drawBuffers:yt};const Tt=Y([{semantic:0,type:5126,components:3,normalize:!1},{semantic:22,type:5126,components:3,normalize:!1}]),It={0:"aPosition",22:"aTexcoord1"},Pt={modelClipMatrix:["uModelClipMatrix","mat4"],modelWorldMatrix:["uModelWorldMatrix","mat4"],modelViewMatrix:["uModelViewMatrix","mat4"],numMaterials:["uNumMaterials","float"],objectInfoTextureSize:["uObjectInfoTextureSize","vec2"],octantMask:["uOctantMask","float",0],clippingPlanes0:["uClippingPlanes[0]","vec4",V()],clippingPlanes1:["uClippingPlanes[1]","vec4",V()],clippingPlanes2:["uClippingPlanes[2]","vec4",V()],clippingPlanes3:["uClippingPlanes[3]","vec4",V()],clippingPlanes4:["uClippingPlanes[4]","vec4",V()],clippingPlanes5:["uClippingPlanes[5]","vec4",V()],numClippingPlanes:["uNumClippingPlanes","float"],clipInside:["uClipInside","bool"]},Nt={type:3553,10240:9728,10241:9728,10242:33071,10243:33071},Dt=[{textureSemantic:"material_properties",shaderUniform:"texMaterialProperties",samplerState:Nt},{textureSemantic:"object_info",shaderUniform:"texObjectInfo",samplerState:Nt},{textureSemantic:"color_matrix",shaderUniform:"texColorMatrices",samplerState:Nt}],Vt=[36064,36065,36066,36067];class _t extends Q{cameraUniforms={modelWorldMatrix:b(),modelClipMatrix:b(),modelViewMatrix:b()};constructor(e,t,o){super(e,t,o)}isDoubleSided=e=>e.settings.advanced.doubleSided.opaque;computeUniforms=e=>{const{settings:t,cameraUniforms:o,textures:r,sceneTextures:i}=e;let n={},a=0,s=!0;if(t.clippingPlanes&&t.clippingPlanes.enabled){const e=[_(-1,0,0,t.clippingPlanes.bounds.min[0]),_(0,-1,0,t.clippingPlanes.bounds.min[1]),_(0,0,-1,t.clippingPlanes.bounds.min[2]),_(1,0,0,-t.clippingPlanes.bounds.max[0]),_(0,1,0,-t.clippingPlanes.bounds.max[1]),_(0,0,1,-t.clippingPlanes.bounds.max[2])],r=y(b(),o.worldViewMatrix);C(r,r);for(const t of e)O(t,t,r);for(let t=0;t<6;t++)n[`clippingPlanes${t}`]=e[t];a=6,s=t.clippingPlanes.inside}const{clippingVolume:l}=t;if(l.enabled){const e="intersection"==l.mode,t=[V(),V(),V(),V(),V(),V()],{planes:r}=l;a=Math.min(6,r.length);for(let o=0;o<a;o++)e?B(t[o],r[o]):E(t[o],r[o]);const i=y(b(),o.worldViewMatrix);C(i,i);for(const e of t)O(e,e,i);for(let e=0;e<6;e++)n[`clippingPlanes${e}`]=t[e];s=e}return this.state={...this.state,2884:!this.isDoubleSided(e)},{...n,numClippingPlanes:a,clipInside:s}};computeMeshUniforms=(e,t)=>{const{cameraUniforms:o}=e,{modelWorldMatrix:r,modelClipMatrix:i,modelViewMatrix:n}=this.cameraUniforms;return t.modelWorldMatrix?(M(r,t.modelWorldMatrix),S(i,o.worldClipMatrix,r),S(n,o.worldViewMatrix,r)):(M(r,o.modelWorldMatrix),M(i,o.modelClipMatrix),M(n,o.modelViewMatrix)),this.cameraUniforms};state={...k,3024:!1,2929:!0,2884:!0,2932:515}}!function(e){e.contextData={shaders:{vertex:"precision highp float;precision highp int;const int MaxClippingPlanes=6;uniform mat4 uModelClipMatrix;uniform mat4 uModelWorldMatrix;uniform mat4 uModelViewMatrix;uniform float uNumMaterials;uniform vec2 uObjectInfoTextureSize;uniform float uOctantMask;uniform vec4 uClippingPlanes[MaxClippingPlanes];uniform float uNumClippingPlanes;uniform bool uClipInside;uniform sampler2D texMaterialProperties;uniform sampler2D texObjectInfo;uniform sampler2D texColorMatrices;in vec4 aPosition;in vec3 aTexcoord1;out vec3 vPositionVS;out float vObjectIndex;out float vLinearZ;out float vObjectHighlight;out vec2 vTextureCoord1;bool bitTest(uint bits,uint bitValue){return(bits&bitValue)!=0U;}void main(){float w=uObjectInfoTextureSize.x;float h=uObjectInfoTextureSize.y;vec2 objectInfoUV=vec2((mod(aTexcoord1.z,w)+0.5)/w,(floor(aTexcoord1.z/w)+0.5)/h);float octantBits=round(aTexcoord1.x);if(octantBits!=float(0xff)&&!bitTest(uint(uOctantMask),uint(octantBits)))return;float objectHighlight=round(texture(texObjectInfo,objectInfoUV).x*255.0);bool hidden=objectHighlight==255.0;if(hidden)return;vObjectHighlight=objectHighlight;vTextureCoord1=vec2(aTexcoord1.x,(aTexcoord1.y+0.5)/uNumMaterials);gl_Position=uModelClipMatrix*aPosition;vPositionVS=vec3(uModelViewMatrix*aPosition);vObjectIndex=aTexcoord1.z;vLinearZ=gl_Position.w;}",fragment:"precision highp float;precision highp int;const float NaN=.0/.0;const int MaxClippingPlanes=6;uniform mat4 uModelClipMatrix;uniform mat4 uModelWorldMatrix;uniform mat4 uModelViewMatrix;uniform float uNumMaterials;uniform vec2 uObjectInfoTextureSize;uniform float uOctantMask;uniform vec4 uClippingPlanes[MaxClippingPlanes];uniform float uNumClippingPlanes;uniform bool uClipInside;uniform sampler2D texMaterialProperties;uniform sampler2D texObjectInfo;uniform sampler2D texColorMatrices;in vec3 vPositionVS;in float vObjectIndex;in float vLinearZ;in float vObjectHighlight;in vec2 vTextureCoord1;layout(location=0)out vec4 fragColor;layout(location=1)out vec2 fragNormal;layout(location=2)out float fragDepth;layout(location=3)out uvec2 fragInfo;const float GAMMA=2.2;const float INV_GAMMA=1.0/GAMMA;vec3 linearTosRGB(vec3 color){return pow(color,vec3(INV_GAMMA));}vec3 sRGBToLinear(vec3 srgbIn){return vec3(pow(srgbIn.xyz,vec3(GAMMA)));}vec3 toneMapACES_Narkowicz(vec3 color){const float A=2.51;const float B=0.03;const float C=2.43;const float D=0.59;const float E=0.14;return clamp((color*(A*color+B))/(color*(C*color+D)+E),0.0,1.0);}vec3 RRTAndODTFit(vec3 color){vec3 a=color*(color+0.0245786)-0.000090537;vec3 b=color*(0.983729*color+0.4329510)+0.238081;return a/b;}vec4 floatToRgba(float texelFloat,bool littleEndian){int exponent=int(log2(abs(texelFloat))+1.0);texelFloat/=exp2(float(exponent));texelFloat=(texelFloat+1.0)*(256.0*256.0*256.0-1.0)/(2.0*256.0*256.0*256.0);vec4 encode=fract(texelFloat*vec4(1.0,256.0,256.0*256.0,256.0*256.0*256.0));vec4 res=vec4(encode.xyz-encode.yzw/256.0+1.0/512.0,(float(exponent)+127.5)/256.0);return littleEndian ? res : res.abgr;}float rgbaToFloat(vec4 pack,bool littleEndian){if(!littleEndian)pack=pack.abgr;int exponent=int(pack.w*256.0-127.0);float value=dot(pack.xyz,1.0/vec3(1.0,256.0,256.0*256.0));value=value*(2.0*256.0*256.0*256.0)/(256.0*256.0*256.0-1.0)-1.0;return value*exp2(float(exponent));}const mat4 ditherThresholds=mat4(0.0/16.0,8.0/16.0,2.0/16.0,10.0/16.0,12.0/16.0,4.0/16.0,14.0/16.0,6.0/16.0,3.0/16.0,11.0/16.0,1.0/16.0,9.0/16.0,15.0/16.0,7.0/16.0,13.0/16.0,5.0/16.0);float dither(vec2 xy){int x=int(xy.x)&3;int y=int(xy.y)&3;return ditherThresholds[y][x];}void main(){vec4 vPVS=vec4(vPositionVS,1);bool inside=uNumClippingPlanes>0.0;int nc=int(uNumClippingPlanes);for(int i=0;i<MaxClippingPlanes;i++){if(!inside||i>=nc)break;inside=dot(vPVS,uClippingPlanes[i])<=0.0;}if(inside==uClipInside)discard;vec4 diffuseOpacity=texture(texMaterialProperties,vec2(vTextureCoord1.y,0.5/2.0));diffuseOpacity.rgb=sRGBToLinear(diffuseOpacity.rgb);float objectHighlight=round(vObjectHighlight);float u=(objectHighlight+0.5)/256.0;mat4 colorTransform;colorTransform[0]=texture(texColorMatrices,vec2(u,0.5/5.0));colorTransform[1]=texture(texColorMatrices,vec2(u,1.5/5.0));colorTransform[2]=texture(texColorMatrices,vec2(u,2.5/5.0));colorTransform[3]=texture(texColorMatrices,vec2(u,3.5/5.0));vec4 colorTranslation=texture(texColorMatrices,vec2(u,4.5/5.0));diffuseOpacity=colorTransform*diffuseOpacity+colorTranslation;if((diffuseOpacity.a-0.5/16.0)<dither(gl_FragCoord.xy))discard;fragColor.rgb=diffuseOpacity.rgb;fragColor.a=1.0;if(diffuseOpacity.a>=1.0){fragNormal=vec2(NaN,NaN);fragDepth=vLinearZ;fragInfo=uvec2(vObjectIndex,0);}}",flags:[]},vertexLayout:Tt,vertexSemanticNames:It,uniforms:Pt,textureSlots:Dt,drawBuffers:Vt},e.isDoubleSided=function(e){throw new Error("Function not implemented.")}}(_t||(_t={}));const Et=Y([{semantic:0,type:5126,components:3,normalize:!1},{semantic:22,type:5126,components:1,normalize:!1}]),Bt={0:"aPosition",22:"aId"},Ot={modelViewMatrix:["uModelViewMatrix","mat4"],viewClipMatrix:["uViewClipMatrix","mat4"],worldViewNormalMatrix:["uWorldViewNormalMatrix","mat3"],selectedSide:["uSelectedSide","float",-1]},Ut=[36064,36065,36066,36067];class zt extends Q{constructor(e,t){super(e,t)}computeUniforms=e=>{const{settings:t,cameraUniforms:o}=e,{min:r,max:i}=t.clippingPlanes.bounds;let n;var a,s,l,u,c,f,m,d,p,x,h,g,M,C,y,w,I,P,N,D,V,_,E;return t.clippingPlanes&&t.clippingPlanes.enabled&&t.clippingPlanes.showBox?(a=b(),s=U(),l=r,u=function(e,t,o){return e[0]=t[0]-o[0],e[1]=t[1]-o[1],e[2]=t[2]-o[2],e}(T(),i,r),g=(c=s[0])*(p=c+c),M=c*(x=(f=s[1])+f),C=c*(h=(m=s[2])+m),y=f*x,w=f*h,I=m*h,P=(d=s[3])*p,N=d*x,D=d*h,V=u[0],_=u[1],E=u[2],a[0]=(1-(y+I))*V,a[1]=(M+D)*V,a[2]=(C-N)*V,a[3]=0,a[4]=(M-D)*_,a[5]=(1-(g+I))*_,a[6]=(w+P)*_,a[7]=0,a[8]=(C+N)*E,a[9]=(w-P)*E,a[10]=(1-(g+y))*E,a[11]=0,a[12]=l[0],a[13]=l[1],a[14]=l[2],a[15]=1,n=a,S(n,o.worldViewMatrix,n)):n=function(e,t,o,r,i,n,a,s,l,u,c,f,m,d,p,x){var h=new v(16);return h[0]=0,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=0,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=0,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=0,h}(),{selectedSide:t.clippingPlanes?.highlight??-1,modelViewMatrix:n}};state={...k,3024:!1,2929:!0,2884:!0,3042:!0,32969:770,32971:770,32968:771,32970:1}}(zt||(zt={})).contextData={shaders:{vertex:"precision highp float;precision highp int;uniform mat4 uModelViewMatrix;uniform mat4 uViewClipMatrix;uniform mat3 uWorldViewNormalMatrix;uniform float uSelectedSide;in vec4 aPosition;in float aId;out float vId;out vec4 vColor;out float vLinearZ;out vec3 vNormalVS;void main(){vec4 posVS=uModelViewMatrix*aPosition;gl_Position=uViewClipMatrix*posVS;vColor=aId==uSelectedSide ? vec4(1,0,0,0.125): vec4(0,1,0,0.125);vId=aId;vLinearZ=posVS.z;int axis=int(aId+0.25);vNormalVS=(axis>2)?-uWorldViewNormalMatrix[axis-3]: uWorldViewNormalMatrix[axis];}",fragment:"precision highp float;precision highp int;uniform mat4 uModelViewMatrix;uniform mat4 uViewClipMatrix;uniform mat3 uWorldViewNormalMatrix;uniform float uSelectedSide;in float vId;in vec4 vColor;in float vLinearZ;in vec3 vNormalVS;layout(location=0)out vec4 fragColor;layout(location=1)out vec2 fragNormal;layout(location=2)out float fragDepth;layout(location=3)out uvec2 fragInfo;void main(){fragColor=vColor;fragNormal=normalize(vNormalVS).xy;fragDepth=vLinearZ;fragInfo=uvec2(uint(0xFFFFFFFE)-uint(round(vId)),0);}",flags:[]},vertexLayout:Et,vertexSemanticNames:Bt,uniforms:Ot,drawBuffers:Ut};const Lt={background:K,watermark:ee,basic:se,basic_z:le,basic_za:ue,gltf:be,gltf_unlit:Me,gltf_t:Ce,gltf_unlit_t:ye,gltf_p:we,octree:Oe,octree_a:Ue,octree_ds:ze,octree_outline:Re,octree_ds_outline:Ae,octree_ds_a:Le,octree_terrain:je,octree_albedo:Ze,octree_document:Ye,clipping_box:zt,pointcloud:rt,pointcloud_deviation:ct,pointcloud_deviation2:ft,pointcloud_intensity:xt,pointcloud_deviation_intensity:St,pointcloud_deviation2_intensity:wt,lines:_t};function Rt(e){switch(e){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 33635:case 32819:case 32820:case 5131:case 36193:return Uint16Array;case 5125:case 34042:case 35902:case 33640:case 35899:return Uint32Array;case 5124:return Int32Array;case 5126:return Float32Array}throw new Error(`Unknown buffer type: ${e}!`)}class At{u;f;constructor(){this.f=new Float32Array(1),this.u=new Uint32Array(this.f.buffer)}}function jt(e){const t=260046848,o=new At;o.u[0]=113<<23;const r=new At;r.u[0]=(32767&e)<<13;const i=t&r.u[0];return r.u[0]+=112<<23,i===t?r.u[0]+=112<<23:0==i&&(r.u[0]+=1<<23,r.f[0]-=o.f[0]),r.u[0]|=(32768&e)<<16,r.f[0]}function Ft(e){return"compressed"==e.kind}function Gt(e){return 0==(e&e-1)}class Wt{gl;images=[];textures=[];nullTexture2D;nullTextureCube;constructor(e){this.gl=e;const t=new Uint8Array([255,255,255,255]);this.nullTexture2D=e.createTexture(),e.bindTexture(3553,this.nullTexture2D),e.texImage2D(3553,0,32856,1,1,0,6408,5121,t),e.bindTexture(3553,null),this.nullTextureCube=e.createTexture(),e.bindTexture(34067,this.nullTextureCube);for(let o=0;o<6;o++)e.texImage2D(34069+o,0,32856,1,1,0,6408,5121,t);e.bindTexture(34067,null)}nullTexture(e){return 3553==e?this.nullTexture2D:this.nullTextureCube}reset(){const{gl:e,textures:t,images:o}=this;for(const r of t)r&&r.texture&&!o.includes(r)&&e.deleteTexture(r.texture);this.textures.length=0;for(const t of o)t&&e.deleteTexture(t.texture);this.images.length=0}dispose(){this.reset();const{gl:e,nullTexture2D:t,nullTextureCube:o}=this;e.deleteTexture(t),e.deleteTexture(o)}getImage(e){return this.images[e]}getTexture(e){return this.textures[e]}setImage(e,t,o){const{gl:r,images:i}=this,{generateMipmaps:n,defaultColor:a,format:s}=o??{},l=i[e]?.texture??r.createTexture(),u=t&&(n??!0)&&Gt(t.width)&&Gt(t.height),c=u?Math.log2(Math.min(t.width,t.height))+1:1;i[e]||(i[e]={texture:l,mips:c}),r.bindTexture(3553,l),r.pixelStorei(37443,r.NONE);const f=s??6408;t?(r.texImage2D(3553,0,f,f,5121,t),u&&r.generateMipmap(3553)):void 0===t&&r.texImage2D(3553,0,f,1,1,0,f,5121,new Uint8Array(a??[255,255,255,255])),r.bindTexture(3553,null)}setImageFromBuffer(e,t,o){const{gl:r,images:i}=this,{width:n,height:a,generateMipmaps:s}=o,l=(s??!0)&&Gt(n)&&Gt(a),u=o.type??5121,c=o.internalFormat??6408,f=o.format??6408,m=i[e]?.texture??r.createTexture(),d=l?Math.log2(Math.min(n,a))+1:1;i[e]||(i[e]={texture:m,mips:d}),r.bindTexture(3553,m),r.pixelStorei(37443,r.NONE),r.texImage2D(3553,0,c,n,a,0,f,u,t),l&&r.generateMipmap(3553),r.bindTexture(3553,null)}deleteTexture(e){this.textures[e]?.texture&&(this.gl.deleteTexture(this.textures[e].texture),this.textures[e]=void 0)}setTexture(e,t,o){const{gl:r,textures:i}=this,{generateMipmaps:n,sampler:a,defaultColor:s,format:l}=o??{},u=void 0!==t&&"number"!=typeof t&&(n??!0)&&Gt(t.width)&&Gt(t.height);let c="number"==typeof t?this.images[t].texture:r.createTexture();const f="number"==typeof t?this.images[t].mips:u?Math.log2(Math.min(t.width,t.height))+1:1,m=i[e]??{texture:c,mips:f,samplerOverrides:a};if(i[e]||(i[e]=m),"number"!=typeof t){r.bindTexture(3553,m.texture),r.pixelStorei(37443,r.NONE);const e=l??6408;t?(r.texImage2D(3553,0,e,e,5121,t),(n??1)&&Gt(t.width)&&Gt(t.height)&&r.generateMipmap(3553)):void 0===t&&r.texImage2D(3553,0,e,1,1,0,e,5121,new Uint8Array(s??[255,255,255,255])),r.bindTexture(3553,null)}}async setTexturesFromArchive(e,t,o,r){const{gl:i}=this,{useSingleMipMapLevel:n,sampler:a}=r??{};i.activeTexture(33984);for(let r=0;r<t.length;r++){const s=i.createTexture(),{target:l}=t[r];i.bindTexture(l,s);const u=Math.max(...t[r].images.map((e=>e.level)))+1;for(const e of t[r].images){let{target:t,level:r,blobRange:a}=e;if(u>1&&void 0!==n){if(r!=n)continue;r=0}const[s,l]=a,c=o.slice(s,l);if(Ft(e)){const{width:o,height:n,internalFormat:a}=e;i.compressedTexImage2D(t,r,a,o,n,0,new Uint8Array(c))}else{let{width:o,height:n,format:a,internalFormat:s,baseInternalFormat:l,type:u}=e;const f=new(Rt(u))(c);i.pixelStorei(37443,i.NONE),i.texImage2D(t,r,s,o,n,0,a,u,f)}}this.textures[e]?.texture&&i.deleteTexture(this.textures[e].texture),this.textures[e++]={texture:s,mips:u,samplerOverrides:a},i.bindTexture(l,null)}}}class kt{width;height;normals;depths;infos;lastContext;constructor(e,t){this.width=e,this.height=t,this.normals=new Uint16Array(e*t*2),this.depths=new Float32Array(e*t*2),this.infos=new Uint32Array(e*t*2)}getNormal(e){const{normals:t}=this,o=jt(t[2*e+0]),r=jt(t[2*e+1]);return I(o,r,Math.sqrt(1-(o*o+r*r)))}getDepth(e){return this.depths[e]}getInfo(e){const{infos:t}=this,o=t[2*e+0];if(4294967295==o)return;const r=new Uint16Array(t.buffer,8*e+4),i=jt(r[0]),n=jt(r[1]);return{objectId:o,deviation:65504==i?void 0:i,intensity:65504==n?void 0:n}}update(e){if(this.lastContext===e)return;this.lastContext=e;const{gl:t,buffers:o}=e,{width:r,height:i,normals:n,depths:a,infos:s}=this;performance.mark("render_pick_begin"),t.bindFramebuffer(36160,e.frameBuffer),t.framebufferTexture2D(36008,36064,3553,o.color.texture,0),t.framebufferTexture2D(36008,36065,3553,o.normal.texture,0),t.framebufferTexture2D(36008,36066,3553,o.linearDepth.texture,0),t.framebufferTexture2D(36008,36067,3553,o.info.texture,0),t.readBuffer(36065),t.readPixels(0,0,r,i,o.normal.format.base,o.normal.format.type,n),t.readBuffer(36066),t.readPixels(0,0,r,i,o.linearDepth.format.base,o.linearDepth.format.type,a),t.readBuffer(36067),t.readPixels(0,0,r,i,o.info.format.base,o.info.format.type,s),t.readBuffer(36064),t.bindFramebuffer(36160,null),performance.measure("render_pick","render_pick_begin")}}const Ht={createTextures(e,t,o,r){this.textureCache.setTexturesFromArchive(e,t,o,r)},createImage(e,t,o){this.textureCache.setImage(e,t,o)},createImageFromBuffer(e,t,o){const r=new(Rt(o.type??5121))(t);this.textureCache.setImageFromBuffer(e,r,o)},createTexture(e,t,o){this.textureCache.setTexture(e,t,o)},deleteTexture(e){this.textureCache.deleteTexture(e)},createMaterial(e,t,o,r){this.materialGroups[e]=this.createMaterialGroup(t,o,r)},setSceneUniforms(e){this.sceneUniforms=e},setSceneTextures(e){this.sceneTextures=e},createMesh(e,t,o){this.materialGroups[e].createMesh(t,o)},updateMesh(e,t,o){this.materialGroups[e].updateMesh(t,o)},deleteMesh(e,t){this.materialGroups[e].deleteMesh(t)},updateMaterial(e,t,o){this.materialGroups[e].update(t,o)},updateImage(e,t,o){if(t instanceof ImageData){const{generateMipmaps:r}=o;this.textureCache.setImage(e,t,{generateMipmaps:r})}else{const{type:r}=o,i=new(Rt(r??5121))(t);this.textureCache.setImageFromBuffer(e,i,o)}}};class qt{gl;ext;device;generation;settings;cameraUniforms;sceneUniforms;sceneTextures;textures;materialGroups;buffers;currentState;drawcalls=0;triangles=0;points=0;frameBuffer;defaultClearColor=_(0,0,.25,1);constructor(e,t,o,r,i,n,a,s,l,u,c,f){this.gl=e,this.ext=t,this.device=o,this.generation=r,this.settings=i,this.cameraUniforms=n,this.sceneUniforms=a,this.sceneTextures=s,this.textures=l,this.materialGroups=u,this.buffers=c,this.currentState=f,this.frameBuffer=e.createFramebuffer()}get sortedMaterialGroups(){const e=[...this.materialGroups];return e.sort(((e,t)=>e.color.renderOrder-t.color.renderOrder)),e}dispose(){const{gl:e}=this;e.bindFramebuffer(36160,null),e.deleteFramebuffer(this.frameBuffer)}jitter(e,t){const{cameraUniforms:o}=this,{width:r,height:i}=o;var n;(n=o.viewClipMatrix)[8]+=e/r,n[9]+=t/i,w(o.worldClipMatrix,o.viewClipMatrix,o.worldViewMatrix)}clearColorBuffer(){const{gl:e,settings:t}=this,o=t.background&&"color"in t.background?t.background.color:this.defaultClearColor;o&&e.clearBufferfv(6144,0,new Float32Array(o)),e.clearBufferfi(34041,0,1,0)}clearDepthBuffer(){const{gl:e}=this;e.clearBufferfi(34041,0,1,0)}clearOtherBuffers(){const{gl:e,buffers:t,settings:o}=this;e.clearBufferfv(6144,1,new Float32Array([Number.NaN,Number.NaN,0,0])),e.clearBufferfv(6144,2,new Float32Array([Number.POSITIVE_INFINITY,0,0,0])),e.clearBufferuiv(6144,3,new Uint32Array([4294967295,4294967295,0,0]))}renderColor(){const{gl:e,ext:t,buffers:o}=this;e.bindFramebuffer(36160,this.frameBuffer),e.framebufferTexture2D(36009,36096,3553,o.depth.texture,0),e.framebufferTexture2D(36009,36064,3553,o.color.texture,0),e.framebufferTexture2D(36009,36065,3553,o.normal.texture,0),e.framebufferTexture2D(36009,36066,3553,o.linearDepth.texture,0),e.framebufferTexture2D(36009,36067,3553,o.info.texture,0);const r=this.settings.advanced.renderBufferMask,i=[e.COLOR_ATTACHMENT0,e.COLOR_ATTACHMENT1,36066,36067];for(let e=0;e<i.length;e++)0==(r&1<<e)&&(i[e]=0);e.drawBuffers(i),this.clearColorBuffer(),this.clearDepthBuffer(),r>1&&this.clearOtherBuffers(),this.renderPass("color"),e.bindFramebuffer(36160,null)}renderOutline(){const{gl:e,buffers:t}=this;e.bindFramebuffer(36160,this.frameBuffer),e.framebufferTexture2D(36009,36064,3553,t.color.texture,0),e.framebufferTexture2D(36009,36065,3553,t.normal.texture,0),e.framebufferTexture2D(36009,36066,3553,t.linearDepth.texture,0),e.framebufferTexture2D(36009,36067,3553,t.info.texture,0),e.drawBuffers([e.COLOR_ATTACHMENT0]),this.renderPass("outline"),e.bindFramebuffer(36160,null)}renderPass(e="color"){const{gl:t,sortedMaterialGroups:o,cameraUniforms:r}=this,{modelViewMatrix:i}=r;for(const t of o){if(0==t.count)continue;const o=t.color?.isAlpha,r=o?-1:1,n=t[e];if(n&&n.apply(this)){let e=[...t.meshes];if(e.length>1){const t=e.map(((e,t)=>t)),o=e.map((e=>e.sortCoord?D(T(),e.sortCoord,i)[2]:Number.MAX_SAFE_INTEGER*r));t.sort(((e,t)=>(o[t]-o[e])*r)),e=t.map((t=>e[t]))}for(const t of e)t.visible&&(n.applyMeshUniforms(this,t),n.applyAttributes(),t.draw(this.device),this.drawcalls++,this.triangles+=t.triangleCount(),this.points+=t.pointsCount());n.cleanup(this)&&this.clearDepthBuffer()}}}resetGLState(){const{gl:e,ext:t}=this;H(e,t,this.currentState,k),this.currentState=k,e.useProgram(null),e.bindVertexArray(null),e.bindBuffer(34963,null),e.bindBuffer(34962,null),e.bindFramebuffer(36160,null),e.bindRenderbuffer(36161,null),e.drawBuffers([e.BACK]),e.readBuffer(1029);const o=e.getParameter(34930);for(let t=0;t<o;t++)e.activeTexture(33984+t),e.bindTexture(3553,null),e.bindSampler(0,null);e.activeTexture(33984)}}class Xt{width;height;format;texture;constructor(e,t,o,r){this.width=t,this.height=o,this.format=r;const i=e.createTexture();!function(e,t,o,r,i){const{type:n,base:a,internal:s}=i;e.activeTexture(33984),e.bindTexture(3553,t),e.texImage2D(3553,0,s,o,r,0,a,n,null),e.bindTexture(3553,null)}(e,i,t,o,r),this.texture=i}}class Qt{format;_texture=null;getTexture;constructor(e){this.format=e}init(e){this.getTexture=e,this._texture=null}get texture(){return this.getTexture&&(this._texture=this.getTexture(this.format),this.getTexture=void 0),this._texture}set texture(e){this._texture=e,this.getTexture=void 0}}class Zt{gl;color;depth;linearDepth;normal;info;freeBuffers=[];acquiredBuffers=[];constructor(e){this.gl=e;const{colorBufferFormat:t,depthBufferFormat:o,linearDepthBufferFormat:r,normalBufferFormat:i,infoBufferFormat:n}={colorBufferFormat:{type:5131,base:6408,internal:34842},depthBufferFormat:{type:5126,base:6402,internal:36012},linearDepthBufferFormat:{type:5126,base:6403,internal:33326},normalBufferFormat:{type:5131,base:33319,internal:33327},infoBufferFormat:{type:5125,base:33320,internal:33340}};this.color=new Qt(t),this.depth=new Qt(o),this.linearDepth=new Qt(r),this.normal=new Qt(i),this.info=new Qt(n)}dispose(e){const{gl:t}=this;for(const o of e?this.freeBuffers:[...this.freeBuffers,...this.acquiredBuffers])t.deleteTexture(o.texture);this.freeBuffers.length=0,e||(this.acquiredBuffers.length=0)}init(e,t){this.color.texture&&this.releaseBuffer(this.color.texture),this.depth.texture&&this.releaseBuffer(this.depth.texture),this.linearDepth.texture&&this.releaseBuffer(this.linearDepth.texture),this.normal.texture&&this.releaseBuffer(this.normal.texture),this.info.texture&&this.releaseBuffer(this.info.texture),this.dispose(!0);const o=o=>this.acquireBuffer(e,t,o);this.color.init(o),this.depth.init(o),this.linearDepth.init(o),this.normal.init(o),this.info.init(o)}acquireBuffer(e,t,o){const{gl:r,freeBuffers:i,acquiredBuffers:n}=this,a=i.findIndex((r=>r.width==e&&r.height==t&&r.format.internal==o.internal)),s=a>=0?i.splice(a,1)[0]:new Xt(r,e,t,o);return n.push(s),r.bindTexture(3553,null),s.texture}releaseBuffer(e){const{gl:t,freeBuffers:o,acquiredBuffers:r}=this,i=r.findIndex((t=>t.texture==e)),n=r.splice(i,1)[0];o.push(n)}}class Yt{gl;ext;program;state;inputTextures;vb;maxAttributes;fb;uniforms;constructor(e,t,o,r,i,n){this.gl=e,this.ext=t,this.program=o,this.state=r,this.inputTextures=i,this.vb=e.createBuffer(),e.bindBuffer(34962,this.vb),e.bufferData(34962,new Float32Array([-1,1,-1,-1,1,1,1,-1]),35044),this.fb=e.createFramebuffer(),this.maxAttributes=e.getParameter(34921),this.uniforms=n?G(e,o,n):void 0}draw(e,t,o,r){const{gl:i,ext:n,vb:a,fb:s,program:l,inputTextures:u,state:c}=this;i.useProgram(l),this.uniforms&&r&&this.uniforms.set(r),H(i,n,e,c);for(let e=0;e<u.length;e++){const{uniform:t,samplerState:r}=u[e],n=o[e];i.uniform1i(t,e),i.activeTexture(33984+e),i.bindTexture(3553,n),q(i,r)}i.bindBuffer(34962,a),i.enableVertexAttribArray(0);const{maxAttributes:f}=this;for(let e=1;e<f;++e)i.disableVertexAttribArray(e);return i.vertexAttribPointer(0,2,5126,!1,0,0),i.bindFramebuffer(36160,t?s:null),t&&i.framebufferTexture2D(36009,36064,3553,t,0),i.drawArrays(5,0,4),i.bindFramebuffer(36160,null),i.bindTexture(3553,null),i.bindBuffer(34962,null),i.useProgram(null),c}}const $t={...k,3024:!1},Kt={type:3553,10240:9728,10241:9728,10242:33071,10243:33071},Jt={vertex:"precision highp float;uniform mat3 uColorTransform;uniform sampler2D texInput;in vec2 aVertexPosition;out vec2 vTexCoords;const vec2 scale=vec2(0.5,0.5);void main(){vTexCoords=aVertexPosition*scale+scale;gl_Position=vec4(aVertexPosition,0.0,1.0);}",fragment:"precision highp float;uniform mat3 uColorTransform;uniform sampler2D texInput;in vec2 vTexCoords;out vec4 fragColor;void main(){vec4 color=texture(texInput,vTexCoords);color.rgb=color.rgb*uColorTransform;fragColor=color;}"},eo=(.21,.71,.07,.21,.71,.07,.21,.71,.07,(to=new v(9))[0]=.21,to[1]=.71,to[2]=.07,to[3]=.21,to[4]=.71,to[5]=.07,to[6]=.21,to[7]=.71,to[8]=.07,to);var to;const oo={...k,3024:!1},ro={type:3553,10240:9728,10241:9728,10242:33071,10243:33071},io={vertex:"precision highp float;uniform float uExposure;uniform sampler2D texInput;in vec2 aVertexPosition;out vec2 vTexCoords;const vec2 scale=vec2(0.5,0.5);void main(){vTexCoords=aVertexPosition*scale+scale;gl_Position=vec4(aVertexPosition,0.0,1.0);}",fragment:"#define COLOR\nprecision highp float;precision highp int;precision highp usampler2D;const float maxDeviation=1.;const float maxIntensity=255.;const uint modeColor=0U;const uint modeNormal=1U;const uint modeDepth=2U;const uint modeObjectId=3U;const uint modeDeviation=4U;const uint modeIntensity=5U;uniform float uExposure;uniform uint uMode;uniform float uMaxLinearDepth;uniform sampler2D texColor;uniform sampler2D texNormal;uniform sampler2D texDepth;uniform usampler2D texInfo;in vec2 vTexCoords;out vec4 fragColor;const float GAMMA=2.2;const float INV_GAMMA=1.0/GAMMA;vec3 linearTosRGB(vec3 color){return pow(color,vec3(INV_GAMMA));}vec3 sRGBToLinear(vec3 srgbIn){return vec3(pow(srgbIn.xyz,vec3(GAMMA)));}vec3 toneMapACES_Narkowicz(vec3 color){const float A=2.51;const float B=0.03;const float C=2.43;const float D=0.59;const float E=0.14;return clamp((color*(A*color+B))/(color*(C*color+D)+E),0.0,1.0);}vec3 RRTAndODTFit(vec3 color){vec3 a=color*(color+0.0245786)-0.000090537;vec3 b=color*(0.983729*color+0.4329510)+0.238081;return a/b;}uint hash(uint x){x+=(x<<10u);x ^=(x>>6u);x+=(x<<3u);x ^=(x>>11u);x+=(x<<15u);return x;}void main(){vec4 color=vec4(1,0,0,1);switch(uMode){case modeColor:{color=texture(texColor,vTexCoords);color.rgb=RRTAndODTFit(color.rgb*uExposure);color.rgb=linearTosRGB(color.rgb);break;}case modeNormal:{vec2 xy=texture(texNormal,vTexCoords).xy;if(any(isnan(xy))){color.rgb=vec3(0);}else{float z=sqrt(1.-dot(xy,xy));color.rgb=vec3(xy,z)*.5+.5;}break;}case modeDepth:{float linearDepth=texture(texDepth,vTexCoords).x;if(isinf(linearDepth)){color.rgb=vec3(0,0,0.25);}else{float i=(linearDepth/uMaxLinearDepth);color.rgb=vec3(pow(i,0.5));}break;}case modeObjectId:{uint objectId=texture(texInfo,vTexCoords).x;if(objectId==0xffffffffU){color.rgb=vec3(0);}else{uint rgba=hash(~objectId);float r=float((rgba>>16U)&0xffU)/255.;float g=float((rgba>>8U)&0xffU)/255.;float b=float((rgba>>0U)&0xffU)/255.;color.rgb=vec3(r,g,b);}break;}case modeDeviation:{float deviation=unpackHalf2x16(texture(texInfo,vTexCoords).y).x;color.rgb=deviation>0. ?vec3(0,deviation/maxDeviation,0):vec3(-deviation/maxDeviation,0,0);break;}case modeIntensity:{float intensity=unpackHalf2x16(texture(texInfo,vTexCoords).y).y;color.rgb=vec3(intensity/maxIntensity);break;}}fragColor=color;}"},no=class{webglVersion=1;quad;constructor(e,t){const o=j(e,io,"#version 300 es\n"),r=["texColor","texNormal","texDepth","texInfo"].map((t=>({uniform:e.getUniformLocation(o,t),samplerState:ro})));this.quad=new Yt(e,t,o,oo,r,{exposure:["uExposure","float"],mode:["uMode","uint"],far:["uMaxLinearDepth","float"]})}apply(e){const{quad:t}=this,o=Math.pow(2,e.settings.exposure??0),{near:r,far:i}=e.cameraUniforms,n=e.settings.advanced.displayBuffer,{buffers:a}=e,s=[a.color.texture,a.normal.texture,a.linearDepth.texture,a.info.texture];if(a.color.texture){const{gl:r}=t;r.bindFramebuffer(36160,null),r.drawBuffers([1029]);const a=null;e.currentState=t.draw(e.currentState,a,s,{exposure:o,mode:n,far:i})}}},ao={...k,3024:!1},so={type:3553,10240:9728,10241:9728,10242:33071,10243:33071},lo={vertex:"precision highp float;in vec2 aVertexPosition;out vec2 vTexCoords;const vec2 scale=vec2(0.5,0.5);void main(){vTexCoords=aVertexPosition*scale+scale;gl_Position=vec4(aVertexPosition,0.0,1.0);}",fragment:"precision highp float;uniform float uT;uniform sampler2D texA;uniform sampler2D texB;in vec2 vTexCoords;out vec4 fragColor;void main(){vec4 color=uT<1.0 ? texture(texB,vTexCoords)*uT+texture(texA,vTexCoords)*(1.0-uT): texture(texB,vTexCoords);fragColor=color;}"},uo=[[-4,-7],[-7,-5],[-3,-5],[-5,-4],[-1,-4],[-2,-2],[-6,-1],[-4,0],[-7,1],[-1,2],[-6,3],[-3,3],[-7,6],[-3,6],[-5,7],[-1,7],[5,-7],[1,-6],[6,-5],[4,-4],[2,-3],[7,-2],[1,-1],[4,-1],[2,1],[6,2],[0,4],[4,4],[2,5],[7,5],[5,6],[3,7]].sort(((e,t)=>e[0]*e[0]+e[1]*e[1]-t[0]*t[0]-t[1]*t[1])).map((e=>e.map((e=>e/8)))),co={_:{flags:[],attributes:[{name:"aVertexPosition",size:1,type:35664}],uniforms:[{name:"uViewClipMatrix",size:1,type:35676},{name:"uSamples[0]",size:64,type:35665},{name:"uNumSamples",size:1,type:5126},{name:"uRadius",size:1,type:5126},{name:"uNoiseScale",size:1,type:35664},{name:"texLinearDepth",size:1,type:35678},{name:"texNormal",size:1,type:35678},{name:"texNoise",size:1,type:35678}]}},fo="precision highp float;const vec2 scale=vec2(0.5,0.5);uniform mat4 uClipViewMatrix;uniform mat4 uViewClipMatrix;uniform vec3 uSamples[64];uniform float uNumSamples;uniform float uRadius;uniform vec2 uNoiseScale;uniform sampler2D texLinearDepth;uniform sampler2D texNormal;uniform sampler2D texNoise;in vec2 aVertexPosition;out vec2 vTexCoords;void main(){vTexCoords=aVertexPosition*scale+scale;gl_Position=vec4(aVertexPosition,0.0,1.0);}",mo="precision highp float;precision highp int;uniform mat4 uClipViewMatrix;uniform mat4 uViewClipMatrix;uniform vec3 uSamples[64];uniform float uNumSamples;uniform float uRadius;uniform vec2 uNoiseScale;uniform sampler2D texLinearDepth;uniform sampler2D texNormal;uniform sampler2D texNoise;in vec2 vTexCoords;out vec4 fragColor;float getDepth(vec2 coords){vec4 depthTexel=texture(texLinearDepth,coords);float depth=depthTexel.x;return depth+2.0*uViewClipMatrix[3][2]/(uViewClipMatrix[2][2]-1.0);}void main(){vec3 normal=texture(texNormal,vTexCoords).xyz;float nXYsqare=normal.x*normal.x+normal.y*normal.y;if(nXYsqare>1.5){fragColor=vec4(1.0);}else{normal.z=sqrt(1.0-nXYsqare);float depth=getDepth(vTexCoords);vec3 fragPos=vec3((vTexCoords*2.0-1.0)*depth/vec2(uViewClipMatrix[0][0],uViewClipMatrix[1][1]),-depth);vec3 randomVec=texture(texNoise,vTexCoords*uNoiseScale).xyz;vec3 tangent=normalize(randomVec-normal*dot(randomVec,normal));vec3 bitangent=cross(normal,tangent);mat3 TBN=mat3(tangent,bitangent,normal);float occlusion=0.0;for(int i=0;i<64;++i){if(float(i)>=uNumSamples)break;vec3 samplePos=TBN*uSamples[i];samplePos=fragPos+samplePos*uRadius;vec4 offset=vec4(samplePos,1.0);offset=uViewClipMatrix*offset;offset.xyz/=offset.w;offset.xyz=offset.xyz*0.5+0.5;float sampleDepth=-getDepth(offset.xy);float rangeCheck=smoothstep(0.0,1.0,uRadius/abs(samplePos.z-sampleDepth));occlusion+=(sampleDepth>=samplePos.z+0.005 ? rangeCheck : 0.0);}vec4 color=vec4(vec3(1.0-(occlusion/uNumSamples)),1.0);fragColor=color;}}",po={configurations:co,vertex:fo,fragment:mo},xo=Object.freeze({__proto__:null,configurations:co,vertex:fo,fragment:mo,default:po}),ho={_:{flags:[],attributes:[{name:"aVertexPosition",size:1,type:35664}],uniforms:[{name:"uScreenSizeInv",size:1,type:35664},{name:"uSsao",size:1,type:35678},{name:"uInput",size:1,type:35678}]}},vo="precision highp float;uniform vec2 uScreenSizeInv;uniform sampler2D uSsao;uniform sampler2D uInput;in vec2 aVertexPosition;out vec2 vTexCoords;const vec2 scale=vec2(0.5,0.5);void main(){vTexCoords=aVertexPosition*scale+scale;gl_Position=vec4(aVertexPosition,0.0,1.0);}",go="precision highp float;uniform vec2 uScreenSizeInv;uniform sampler2D uSsao;uniform sampler2D uInput;in vec2 vTexCoords;out vec4 fragColor;void main(){vec4 color=texture(uInput,vTexCoords);float result=0.0;for(int x=-2;x<2;++x){for(int y=-2;y<2;++y){vec2 offset=vec2(float(x),float(y))*uScreenSizeInv;result+=texture(uSsao,vTexCoords+offset).r;}}color.rgb=color.rgb*result*0.0625;fragColor=color;}",bo={configurations:ho,vertex:vo,fragment:go},Mo=Object.freeze({__proto__:null,configurations:ho,vertex:vo,fragment:go,default:bo}),Co={...k,3024:!1},yo={type:3553,10240:9728,10241:9728,10242:33071,10243:33071},So={type:3553,10240:9728,10241:9728,10242:10497,10243:10497},wo={taa:class{webglVersion=1;quad;lastWidth=0;lastHeight=0;count=0;accumulate;constructor(e,t){const o=j(e,lo,"#version 300 es\n"),r=e.getUniformLocation(o,"texA"),i=e.getUniformLocation(o,"texB");this.quad=new Yt(e,t,o,ao,[{uniform:r,samplerState:so},{uniform:i,samplerState:so}],{t:["uT","float"]})}apply(e,t){const o=e.buffers,r=o.color.texture;if(!r)return;const{reset:i}=t,n=t.radius??1;i&&(this.count=0);let{width:a,height:s}=e.settings.display;a*=e.settings.quality.resolution.value,s*=e.settings.quality.resolution.value,a===this.lastWidth&&s===this.lastHeight||(this.lastWidth=a,this.lastHeight=s,this.accumulate&&o.releaseBuffer(this.accumulate),this.accumulate=o.acquireBuffer(a,s,o.color.format),this.count=0);const{quad:l}=this;if(!(this.count>=0&&this.count<uo.length))return l.draw(e.currentState,r,[this.accumulate,this.accumulate],{t:1}),!1;{const t=uo[this.count],i=o.acquireBuffer(a,s,o.color.format);e.jitter(t[0]*n,t[1]*n),e.renderColor(),e.jitter(-t[0]*n,-t[1]*n);const u={t:1/(this.count+1)};l.draw(e.currentState,i,[this.accumulate,r],u),l.draw(e.currentState,this.accumulate,[i,i],{t:1}),o.releaseBuffer(r),o.color.texture=i}return++this.count<uo.length}},ssao:class{webglVersion=1;ssao;ssaoBlur;noiseTex;samples=[];numSamples=0;lastWidth=0;lastHeight=0;ssaoBuff;constructor(e,t){const o=j(e,xo,"#version 300 es\n"),r=e.getUniformLocation(o,"texLinearDepth"),i=e.getUniformLocation(o,"texNoise"),n=e.getUniformLocation(o,"texNormal");this.ssao=new Yt(e,t,o,Co,[{uniform:r,samplerState:yo},{uniform:n,samplerState:yo},{uniform:i,samplerState:So}],{clipViewMatrix:["uClipViewMatrix","mat4"],viewClipMatrix:["uViewClipMatrix","mat4"],samples:["uSamples","vec3"],numSamples:["uNumSamples","float"],radius:["uRadius","float"],noiseScale:["uNoiseScale","vec2"]});const a=[];for(let e=0;e<16;e++){const e=2*Math.random()-1,t=2*Math.random()-1;a.push(e,t,0,1)}this.noiseTex=e.createTexture(),e.bindTexture(3553,this.noiseTex),e.pixelStorei(37443,e.NONE),e.texImage2D(3553,0,34836,4,4,0,6408,5126,new Float32Array(a)),e.bindTexture(3553,null);const s=j(e,Mo,"#version 300 es\n"),l=e.getUniformLocation(s,"uSsao"),u=e.getUniformLocation(s,"uInput");this.ssaoBlur=new Yt(e,t,s,Co,[{uniform:l,samplerState:yo},{uniform:u,samplerState:yo}],{screenSizeInv:["uScreenSizeInv","vec2"]})}apply(e,t){const o=e.buffers,r=o.color.texture;if(!r)return;const{radius:i,skipOpacity:n}=t,a=Math.max(16,Math.min(64,t.samples));if(a!==this.numSamples){this.numSamples=a;const e=[];for(let t=0;t<a;t++){const o=I(2*Math.random()-1,2*Math.random()-1,Math.random()),r=t/a;N(o,o),P(o,o,.1+.9*r*r),e.push(...o)}this.samples=e}const{clipViewMatrix:s,viewClipMatrix:l}=e.cameraUniforms;let{width:u,height:c}=e.settings.display;u*=e.settings.quality.resolution.value,c*=e.settings.quality.resolution.value;let{reset:f}=t;u===this.lastWidth&&c===this.lastHeight||(this.lastWidth=u,this.lastHeight=c,this.ssaoBuff&&o.releaseBuffer(this.ssaoBuff),this.ssaoBuff=o.acquireBuffer(u,c,o.color.format),f=!0);const{ssao:m,ssaoBlur:d,ssaoBuff:p}=this,x=o.acquireBuffer(u,c,o.color.format);if(f){const t=z(.25*u,.25*c),r={clipViewMatrix:s,viewClipMatrix:l,samples:this.samples,numSamples:a,radius:i,noiseScale:t};m.draw(e.currentState,p,[o.linearDepth.texture,o.normal.texture,this.noiseTex],r)}d.draw(e.currentState,x,[p,r],{screenSizeInv:z(1/u,1/c)}),o.color.texture=x,o.releaseBuffer(r)}},gs:class{webglVersion=1;quad;constructor(e,t){const o=j(e,Jt,"#version 300 es\n"),r=e.getUniformLocation(o,"texInput");this.quad=new Yt(e,t,o,$t,[{uniform:r,samplerState:Kt}],{colorTransform:["uColorTransform","mat3"]})}apply(e,t){const{quad:o}=this,r=t.colorTransform??eo,i=e.buffers;let{width:n,height:a}=e.settings.display;n*=e.settings.quality.resolution.value,a*=e.settings.quality.resolution.value;const s=i.color.texture,l={colorTransform:r};if(s){const t=i.acquireBuffer(n,a,i.color.format);o.draw(e.currentState,t,[s],l),i.color.texture=t,i.releaseBuffer(s)}}},outline:class{webglVersion=1;apply(e,t){const{cameraUniforms:o}=e,r=M(b(),o.viewClipMatrix);function i(t,o){const{cameraUniforms:r}=e,i=b();i[8]=t,i[9]=o,w(r.worldViewMatrix,i,r.worldViewMatrix),w(r.worldClipMatrix,r.viewClipMatrix,r.worldViewMatrix)}o.viewClipMatrix[10]=-10,o.viewClipMatrix[14]=-0;const n=M(b(),e.cameraUniforms.worldViewMatrix),{outline:a}=e.settings,{doubleSided:s}=e.settings.advanced,{opaque:l,transparent:u}=s;s.opaque=!0,s.transparent=!0,a.color=t?.color,a.enable=!0,i(0,1/r[0]*.1),e.renderOutline(),M(o.worldViewMatrix,n),i(1/r[5]*.1,0),e.renderOutline(),M(o.worldViewMatrix,n),M(o.viewClipMatrix,r),w(o.worldClipMatrix,o.viewClipMatrix,o.worldViewMatrix),a.enable=!1,s.opaque=l,s.transparent=u}},tonemap:no};class To{gl;ext;query;constructor(e,t){this.gl=e,this.ext=t,this.query=e.createQuery()}dispose(){const{gl:e,query:t}=this;e.deleteQuery(t)}begin(){const{gl:e,ext:t,query:o}=this;e.beginQuery(t.TIME_ELAPSED_EXT,o)}end(){const{gl:e,ext:t}=this;e.endQuery(t.TIME_ELAPSED_EXT)}poll(){const{gl:e,ext:t,query:o}=this;if(!e.getParameter(t.GPU_DISJOINT_EXT))return e.getQueryParameter(o,e.QUERY_RESULT_AVAILABLE)?e.getQueryParameter(o,e.QUERY_RESULT)/1e6:0}}class Io{gl;ext;startQuery;endQuery;constructor(e,t){this.gl=e,this.ext=t,this.startQuery=e.createQuery(),this.endQuery=e.createQuery()}dispose(){const{gl:e,startQuery:t,endQuery:o}=this;e.deleteQuery(t),e.deleteQuery(o)}begin(){const{ext:e,startQuery:t}=this;e.queryCounterEXT(t,e.TIMESTAMP_EXT)}end(){const{ext:e,endQuery:t}=this;e.queryCounterEXT(t,e.TIMESTAMP_EXT)}poll(){const{gl:e,ext:t,startQuery:o,endQuery:r}=this;if(!e.getParameter(t.GPU_DISJOINT_EXT)){if(e.getQueryParameter(r,e.QUERY_RESULT_AVAILABLE)){const t=e.getQueryParameter(o,e.QUERY_RESULT);return(e.getQueryParameter(r,e.QUERY_RESULT)-t)/1e6}return 0}}}const Po=[[1,0],[0,1],[1,1],[-1,0],[0,-1],[-1,-1],[1,-1],[-1,1],[-1,2],[1,2],[2,0],[2,-1],[0,-2],[-2,-1],[-2,1]];class No{width;height;materialTypes;canvas;gl;webGLExtensions;extensions;materialContexts=new Map;materialGroups=[];sceneTextures={};sceneUniforms={};commands=[];textureCache;defaultClearColor=_(0,0,.25,1);objectPicker;disposing=!1;buffers;tonemapper;posteffects=new Map;_gpuTimers=[];_prevFrameTime=0;currentContext;_changedCB;constructor(e,t,o,r){this.width=e,this.height=t,this.materialTypes=o;const i=void 0===r,n=r??new OffscreenCanvas(e,t);i||(n.width=e,n.height=t);let a=null;if(a=n.getContext("webgl2",{alpha:!0,antialias:!1,depth:!0,failIfMajorPerformanceCaveat:!1,desynchronized:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!0,powerPreference:"high-performance",stencil:!1}),!a)throw new Error("WebGL 2 is not supported by this device!");n.addEventListener("webglcontextlost",(function(e){}),!1),n.addEventListener("webglcontextrestored",(function(e){}),!1),this.webGLExtensions=function(e){const t={EXT_color_buffer_float:e.getExtension("EXT_color_buffer_float"),WEBGL_multi_draw:e.getExtension("WEBGL_multi_draw")};for(let e in t)if(!Reflect.get(t,e))throw new Error(`WebGL ${e} extension not supported!`);const o={OES_draw_buffers_indexed:e.getExtension("OES_draw_buffers_indexed"),OES_texture_half_float_linear:e.getExtension("OES_texture_half_float_linear"),WEBGL_compressed_texture_astc:e.getExtension("WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_atc:e.getExtension("WEBGL_compressed_texture_atc"),WEBGL_compressed_texture_etc:e.getExtension("WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:e.getExtension("WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:e.getExtension("WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:e.getExtension("WEBGL_compressed_texture_s3tc_srgb")};return{...t,...o}}(a);const s={};for(let e in this.webGLExtensions){const t=Reflect.get(this.webGLExtensions,e);s[e]=null!==t}this.extensions=s,this.gl=a,this.canvas=n,this.textureCache=new Wt(a),this.objectPicker=new kt(this.width,this.height),this.buffers=new Zt(a),this.buffers.init(e,t),this.tonemapper=new no(a,this.webGLExtensions)}getMaterial(e,t,o){const{gl:r,webGLExtensions:i,extensions:n,materialTypes:a,materialContexts:s}=this,l=a[e];let u=s.get(e);return u||(u=new X(r,i,n,l.contextData),s.set(e,u)),new l(u,t??{},o??{})}createMaterialGroup(e,t,o){const{gl:r,materialTypes:i,webGLExtensions:n}=this,{outlineVariant:a}=i[e],s=this.getMaterial(e,t,o),l=a?this.getMaterial(a,t,o):void 0;return new R(r,n,e,s,l)}init(){this.commands.length=0,this.disposeMaterialGroups(),this.textureCache.reset(),this.materialContexts.clear()}dispose(){this.disposing=!0,this.disposeMaterialGroups(),this.textureCache.dispose()}disposeMaterialGroups(){for(const e of this.materialGroups)e.dispose();this.materialGroups.length=0}size(e,t){this.width==e&&this.height==t||(this.canvas.width=this.width=e,this.canvas.height=this.height=t,this.gl.viewport(0,0,e,t),this.buffers.init(e,t))}render(e,t,o,r){const{gl:i,webGLExtensions:n,buffers:a,_gpuTimers:s}=this;t.background&&"color"in t.background?t.background.color:this.defaultClearColor,performance.mark("render_update_begin"),this.applyCommands(),performance.measure("render_update","render_update_begin"),performance.mark("render_draw_begin");const l=t.quality.resolution.value,u=Math.floor(t.display.width*l),c=Math.floor(t.display.height*l);this.size(u,c);let f=0,m=0,d=0;if(e){const{textureCache:l}=this,{sceneUniforms:u,sceneTextures:c}=this;this.currentContext&&this.currentContext.dispose();const p=this.currentContext=new qt(i,n,o,r,t,e,u,c,l,this.materialGroups,a,k),x=function(e){const t=e.getExtension("EXT_disjoint_timer_query_webgl2");if(t)return e.getParameter(t.GPU_DISJOINT_EXT),e.getQuery(t.TIMESTAMP_EXT,t.QUERY_COUNTER_BITS_EXT)?new Io(e,t):new To(e,t)}(i);x?.begin(),p.renderColor(),x?.end(),x&&s.push(x),f=p.drawcalls,m=p.triangles,d=p.points}performance.measure("render_draw","render_draw_begin");const p=performance.getEntriesByName("render_draw")[0].duration,x=performance.getEntriesByName("render_update")[0].duration;let h;performance.clearMarks(),performance.clearMeasures();for(let e=0;e<s.length;e++){const t=s[e],o=t.poll();o&&(s.splice(e--,1),t.dispose(),h=o)}const v=performance.now(),g=v-this._prevFrameTime;return this._prevFrameTime=v,{drawTime:p,gpuTime:h,frameInterval:g,updateTime:x,triangles:m,points:d,drawcalls:f}}applyPostEffect(e){const{kind:t}=e,{currentContext:o}=this;let r=this.posteffects.get(t);if(!r){const e=wo[t];e&&(r=new e(this.gl,this.webGLExtensions),this.posteffects.set(t,r))}if(o)return r?.apply(o,e)}updatePickBuffers(){const e=this.currentContext;if(!e)return;const{width:t,height:o}=this;t===this.objectPicker.width&&o===this.objectPicker.height||(this.objectPicker=new kt(t,o)),this.objectPicker.update(e)}pick(e,t,o){const r=this.currentContext;if(!r)return;const{gl:i,width:n,height:a}=this,{objectPicker:s}=this;e=Math.round(e),t=Math.round(a-1-t);let l=Math.round(e+t*n),u=s.getInfo(l);const{viewClipMatrix:c,viewWorldMatrix:f,viewWorldNormalMatrix:m}=r.cameraUniforms,d=0!=c[15];if(!u)for(let o=0;o<Po.length;o++){const[r,i]=Po[o],c=e+r,f=t+i;if(!(c<0||f<0||c>=n||f>a)&&(l=Math.round(c+f*n),u=s.getInfo(l),u))break}if(!d&&!u)return;const p=u&&!o?s.getDepth(l):0,x=(t+.5)/a*2-1,h=d?1:p,v=_(((e+.5)/n*2-1)/c[0]*h,x/c[5]*h,-p,1),g=I(0,1,0);u&&function(e,t,o){var r=t[0],i=t[1],n=t[2];e[0]=r*o[0]+i*o[3]+n*o[6],e[1]=r*o[1]+i*o[4]+n*o[7],e[2]=r*o[2]+i*o[5]+n*o[8]}(g,s.getNormal(l),m);const b=O(V(),v,f),M=I(b[0],b[1],b[2]);let C=-1;return u&&4294967288!=u.objectId&&(C=u.objectId),{objectId:C,position:M,normal:g}}measure(e,t){const o=this.currentContext;if(!o)return;const r=.01,{width:i,height:n}=this,{objectPicker:a}=this;e=Math.round(e),t=Math.round(n-1-t);const s=Math.round(e+t*i);if(s<0)return;const l=a.getInfo(s),{viewClipMatrix:u,viewWorldMatrix:c}=o.cameraUniforms;if(0==u[15]&&!l)return;const f=l?l.deviation:void 0;let m=l?a.getDepth(s):0;const d=(e+.5)/i*2-1,p=(t+.5)/n*2-1,x=0==u[15]?m:1,h=_(d/u[0]*x,p/u[5]*x,-m,1),v=O(V(),h,c),g=I(v[0],v[1],v[2]);if(!l||4294967288==l.objectId)return{objectId:-1,position:g,normalVS:void 0,deviation:f};let b=a.getNormal(s);function M(e){const t=a.getNormal(e),[o,i]=t,n=o*o+i*i;if(n>1.5)return!0;if(b[0]-o>r)return!0;if(b[1]-i>r)return!0;const s=Math.sqrt(1-n);return b[2]-s>r}const C=Math.round(i/700);if(M(e-C+t*i))return{objectId:l.objectId,position:g,normalVS:void 0,deviation:f};if(M(e+C+t*i))return{objectId:l.objectId,position:g,normalVS:void 0,deviation:f};const y=Math.round(n/700);return M(e+(t-y)*i)||M(e+(t+y)*i)?{objectId:l.objectId,position:g,normalVS:void 0,deviation:f}:{objectId:l.objectId,position:g,normalVS:b,deviation:f}}getOutputImage(){const e=this.currentContext;if(e){this.tonemapper.apply(e),e.resetGLState();const t="DedicatedWorkerGlobalScope"in self;if("transferToImageBitmap"in this.canvas){const e=this.canvas.transferToImageBitmap();return t?m(e,[e]):e}}}transferToImageBitmap(){if(this.canvas instanceof OffscreenCanvas){const e=this.canvas.transferToImageBitmap();return m(e,[e])}}async convertToBlob(e){if(this.canvas instanceof OffscreenCanvas)return await this.canvas.convertToBlob(e)}executeCommands(e){this.disposing||this.commands.push(...e)}applyCommands(){const{commands:e}=this;!function(e,t){for(let o of t)Ht[o.name].apply(e,o.args)}(this,e),e.length=0}}v=Array;const Do=new class{materialTypes=function(){const e={};for(let t of Reflect.ownKeys(Lt)){const o=Reflect.get(Lt,t),{contextData:r}=o;Reflect.set(e,t,{contextData:r})}return e}();terminate(){"DedicatedWorkerGlobalScope"in self&&self.close()}async createView(e,t){return d(new No(e,t,Lt,self.__htmlRenderCanvas__))}};"DedicatedWorkerGlobalScope"in self?a(Do):self.__initRenderServiceEndPoint__=e=>{a(Do,e)};