!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).NovoRender={})}(this,(function(t){"use strict";const e=Symbol("Comlink.proxy"),i=Symbol("Comlink.endpoint"),s=Symbol("Comlink.releaseProxy"),a=Symbol("Comlink.thrown"),r=t=>"object"==typeof t&&null!==t||"function"==typeof t,n=new Map([["proxy",{canHandle:t=>r(t)&&t[e],serialize(t){const{port1:e,port2:i}=new MessageChannel;return o(t,e),[i,[i]]},deserialize:t=>(t.start(),c(t))}],["throw",{canHandle:t=>r(t)&&a in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error(t.value.message),t.value);throw t.value}}]]);function o(t,e=self){e.addEventListener("message",(function i(s){if(!s||!s.data)return;const{id:r,type:n,path:c}=Object.assign({path:[]},s.data),l=(s.data.argumentList||[]).map(v);let d;try{const e=c.slice(0,-1).reduce(((t,e)=>t[e]),t),i=c.reduce(((t,e)=>t[e]),t);switch(n){case"GET":d=i;break;case"SET":e[c.slice(-1)[0]]=v(s.data.value),d=!0;break;case"APPLY":d=i.apply(e,l);break;case"CONSTRUCT":d=f(new i(...l));break;case"ENDPOINT":{const{port1:e,port2:i}=new MessageChannel;o(t,i),d=p(e,[e])}break;case"RELEASE":d=void 0;break;default:return}}catch(t){d={value:t,[a]:0}}Promise.resolve(d).catch((t=>({value:t,[a]:0}))).then((t=>{const[s,a]=w(t);e.postMessage(Object.assign(Object.assign({},s),{id:r}),a),"RELEASE"===n&&(e.removeEventListener("message",i),h(e))}))})),e.start&&e.start()}function h(t){(function(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function c(t,e){return d(t,[],e)}function l(t){if(t)throw new Error("Proxy has been released and is not useable")}function d(t,e=[],a=function(){}){let r=!1;const n=new Proxy(a,{get(i,a){if(l(r),a===s)return()=>g(t,{type:"RELEASE",path:e.map((t=>t.toString()))}).then((()=>{h(t),r=!0}));if("then"===a){if(0===e.length)return{then:()=>n};const i=g(t,{type:"GET",path:e.map((t=>t.toString()))}).then(v);return i.then.bind(i)}return d(t,[...e,a])},set(i,s,a){l(r);const[n,o]=w(a);return g(t,{type:"SET",path:[...e,s].map((t=>t.toString())),value:n},o).then(v)},apply(s,a,n){l(r);const o=e[e.length-1];if(o===i)return g(t,{type:"ENDPOINT"}).then(v);if("bind"===o)return d(t,e.slice(0,-1));const[h,c]=u(n);return g(t,{type:"APPLY",path:e.map((t=>t.toString())),argumentList:h},c).then(v)},construct(i,s){l(r);const[a,n]=u(s);return g(t,{type:"CONSTRUCT",path:e.map((t=>t.toString())),argumentList:a},n).then(v)}});return n}function u(t){const e=t.map(w);return[e.map((t=>t[0])),(i=e.map((t=>t[1])),Array.prototype.concat.apply([],i))];var i}const m=new WeakMap;function p(t,e){return m.set(t,e),t}function f(t){return Object.assign(t,{[e]:!0})}function w(t){for(const[e,i]of n)if(i.canHandle(t)){const[s,a]=i.serialize(t);return[{type:"HANDLER",name:e,value:s},a]}return[{type:"RAW",value:t},m.get(t)||[]]}function v(t){switch(t.type){case"HANDLER":return n.get(t.name).deserialize(t.value);case"RAW":return t.value}}function g(t,e,i){return new Promise((s=>{const a=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");t.addEventListener("message",(function e(i){i.data&&i.data.id&&i.data.id===a&&(t.removeEventListener("message",e),s(i.data))})),t.start&&t.start(),t.postMessage(Object.assign({id:a},e),i)}))}var y=1e-6,b="undefined"!=typeof Float32Array?Float32Array:Array;function M(t){b=t}var k=Math.PI/180;function P(t){return t*k}function x(t,e){return Math.abs(t-e)<=y*Math.max(1,Math.abs(t),Math.abs(e))}function _(){var t=new b(9);return b!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function V(t,e){var i=e[0],s=e[1],a=e[2],r=e[3],n=i+i,o=s+s,h=a+a,c=i*n,l=s*n,d=s*o,u=a*n,m=a*o,p=a*h,f=r*n,w=r*o,v=r*h;return t[0]=1-d-p,t[3]=l-v,t[6]=u+w,t[1]=l+v,t[4]=1-c-p,t[7]=m-f,t[2]=u-w,t[5]=m+f,t[8]=1-c-d,t}function S(){var t=new b(16);return b!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function E(t,e){var i=e[0],s=e[1],a=e[2],r=e[3],n=e[4],o=e[5],h=e[6],c=e[7],l=e[8],d=e[9],u=e[10],m=e[11],p=e[12],f=e[13],w=e[14],v=e[15],g=i*o-s*n,y=i*h-a*n,b=i*c-r*n,M=s*h-a*o,k=s*c-r*o,P=a*c-r*h,x=l*f-d*p,_=l*w-u*p,V=l*v-m*p,S=d*w-u*f,E=d*v-m*f,T=u*v-m*w,L=g*T-y*E+b*S+M*V-k*_+P*x;return L?(L=1/L,t[0]=(o*T-h*E+c*S)*L,t[1]=(a*E-s*T-r*S)*L,t[2]=(f*P-w*k+v*M)*L,t[3]=(u*k-d*P-m*M)*L,t[4]=(h*V-n*T-c*_)*L,t[5]=(i*T-a*V+r*_)*L,t[6]=(w*b-p*P-v*y)*L,t[7]=(l*P-u*b+m*y)*L,t[8]=(n*E-o*V+c*x)*L,t[9]=(s*V-i*E-r*x)*L,t[10]=(p*k-f*b+v*g)*L,t[11]=(d*b-l*k-m*g)*L,t[12]=(o*_-n*S-h*x)*L,t[13]=(i*S-s*_+a*x)*L,t[14]=(f*y-p*M-w*g)*L,t[15]=(l*M-d*y+u*g)*L,t):null}function T(t,e,i){var s=e[0],a=e[1],r=e[2],n=e[3],o=e[4],h=e[5],c=e[6],l=e[7],d=e[8],u=e[9],m=e[10],p=e[11],f=e[12],w=e[13],v=e[14],g=e[15],y=i[0],b=i[1],M=i[2],k=i[3];return t[0]=y*s+b*o+M*d+k*f,t[1]=y*a+b*h+M*u+k*w,t[2]=y*r+b*c+M*m+k*v,t[3]=y*n+b*l+M*p+k*g,y=i[4],b=i[5],M=i[6],k=i[7],t[4]=y*s+b*o+M*d+k*f,t[5]=y*a+b*h+M*u+k*w,t[6]=y*r+b*c+M*m+k*v,t[7]=y*n+b*l+M*p+k*g,y=i[8],b=i[9],M=i[10],k=i[11],t[8]=y*s+b*o+M*d+k*f,t[9]=y*a+b*h+M*u+k*w,t[10]=y*r+b*c+M*m+k*v,t[11]=y*n+b*l+M*p+k*g,y=i[12],b=i[13],M=i[14],k=i[15],t[12]=y*s+b*o+M*d+k*f,t[13]=y*a+b*h+M*u+k*w,t[14]=y*r+b*c+M*m+k*v,t[15]=y*n+b*l+M*p+k*g,t}function L(t,e,i){var s=Math.sin(i),a=Math.cos(i),r=e[0],n=e[1],o=e[2],h=e[3],c=e[4],l=e[5],d=e[6],u=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=r*a+c*s,t[1]=n*a+l*s,t[2]=o*a+d*s,t[3]=h*a+u*s,t[4]=c*a-r*s,t[5]=l*a-n*s,t[6]=d*a-o*s,t[7]=u*a-h*s,t}function R(t,e,i){var s=e[0],a=e[1],r=e[2],n=e[3],o=s+s,h=a+a,c=r+r,l=s*o,d=s*h,u=s*c,m=a*h,p=a*c,f=r*c,w=n*o,v=n*h,g=n*c;return t[0]=1-(m+f),t[1]=d+g,t[2]=u-v,t[3]=0,t[4]=d-g,t[5]=1-(l+f),t[6]=p+w,t[7]=0,t[8]=u+v,t[9]=p-w,t[10]=1-(l+m),t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t}function C(t,e){var i=e[0],s=e[1],a=e[2],r=e[4],n=e[5],o=e[6],h=e[8],c=e[9],l=e[10];return t[0]=Math.hypot(i,s,a),t[1]=Math.hypot(r,n,o),t[2]=Math.hypot(h,c,l),t}function O(t,e){var i=new b(3);C(i,e);var s=1/i[0],a=1/i[1],r=1/i[2],n=e[0]*s,o=e[1]*a,h=e[2]*r,c=e[4]*s,l=e[5]*a,d=e[6]*r,u=e[8]*s,m=e[9]*a,p=e[10]*r,f=n+l+p,w=0;return f>0?(w=2*Math.sqrt(f+1),t[3]=.25*w,t[0]=(d-m)/w,t[1]=(u-h)/w,t[2]=(o-c)/w):n>l&&n>p?(w=2*Math.sqrt(1+n-l-p),t[3]=(d-m)/w,t[0]=.25*w,t[1]=(o+c)/w,t[2]=(u+h)/w):l>p?(w=2*Math.sqrt(1+l-n-p),t[3]=(u-h)/w,t[0]=(o+c)/w,t[1]=.25*w,t[2]=(d+m)/w):(w=2*Math.sqrt(1+p-n-l),t[3]=(o-c)/w,t[0]=(u+h)/w,t[1]=(d+m)/w,t[2]=.25*w),t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var A=function(t,e,i,s,a){var r,n=1/Math.tan(e/2);return t[0]=n/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=a&&a!==1/0?(r=1/(s-a),t[10]=(a+s)*r,t[14]=2*a*s*r):(t[10]=-1,t[14]=-2*s),t};function B(){var t=new b(3);return b!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function D(t,e,i){var s=new b(3);return s[0]=t,s[1]=e,s[2]=i,s}function j(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function W(t,e,i,s){return t[0]=e,t[1]=i,t[2]=s,t}function I(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t}function z(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function N(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t}function U(t,e){var i=e[0]-t[0],s=e[1]-t[1],a=e[2]-t[2];return Math.hypot(i,s,a)}function H(t,e){var i=e[0],s=e[1],a=e[2],r=i*i+s*s+a*a;return r>0&&(r=1/Math.sqrt(r)),t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}function K(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function G(t,e,i){var s=e[0],a=e[1],r=e[2],n=i[0],o=i[1],h=i[2];return t[0]=a*h-r*o,t[1]=r*n-s*h,t[2]=s*o-a*n,t}function F(t,e,i){var s=e[0],a=e[1],r=e[2],n=i[3]*s+i[7]*a+i[11]*r+i[15];return n=n||1,t[0]=(i[0]*s+i[4]*a+i[8]*r+i[12])/n,t[1]=(i[1]*s+i[5]*a+i[9]*r+i[13])/n,t[2]=(i[2]*s+i[6]*a+i[10]*r+i[14])/n,t}function q(t,e,i){var s=e[0],a=e[1],r=e[2];return t[0]=s*i[0]+a*i[3]+r*i[6],t[1]=s*i[1]+a*i[4]+r*i[7],t[2]=s*i[2]+a*i[5]+r*i[8],t}function Y(t,e,i){var s=i[0],a=i[1],r=i[2],n=i[3],o=e[0],h=e[1],c=e[2],l=a*c-r*h,d=r*o-s*c,u=s*h-a*o,m=a*u-r*d,p=r*l-s*u,f=s*d-a*l,w=2*n;return l*=w,d*=w,u*=w,m*=2,p*=2,f*=2,t[0]=o+l+m,t[1]=h+d+p,t[2]=c+u+f,t}function X(t,e){var i=t[0],s=t[1],a=t[2],r=e[0],n=e[1],o=e[2];return Math.abs(i-r)<=y*Math.max(1,Math.abs(i),Math.abs(r))&&Math.abs(s-n)<=y*Math.max(1,Math.abs(s),Math.abs(n))&&Math.abs(a-o)<=y*Math.max(1,Math.abs(a),Math.abs(o))}var Z=z,Q=U;function $(){var t=new b(4);return b!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function J(t,e,i,s){var a=new b(4);return a[0]=t,a[1]=e,a[2]=i,a[3]=s,a}function tt(t,e,i,s,a){return t[0]=e,t[1]=i,t[2]=s,t[3]=a,t}function et(){var t=new b(4);return b!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function it(t,e,i){i*=.5;var s=e[0],a=e[1],r=e[2],n=e[3],o=Math.sin(i),h=Math.cos(i);return t[0]=s*h+n*o,t[1]=a*h+r*o,t[2]=r*h-a*o,t[3]=n*h-s*o,t}function st(t,e,i){i*=.5;var s=e[0],a=e[1],r=e[2],n=e[3],o=Math.sin(i),h=Math.cos(i);return t[0]=s*h-r*o,t[1]=a*h+n*o,t[2]=r*h+s*o,t[3]=n*h-a*o,t}function at(t,e){var i,s=e[0]+e[4]+e[8];if(s>0)i=Math.sqrt(s+1),t[3]=.5*i,i=.5/i,t[0]=(e[5]-e[7])*i,t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i;else{var a=0;e[4]>e[0]&&(a=1),e[8]>e[3*a+a]&&(a=2);var r=(a+1)%3,n=(a+2)%3;i=Math.sqrt(e[3*a+a]-e[3*r+r]-e[3*n+n]+1),t[a]=.5*i,i=.5/i,t[3]=(e[3*r+n]-e[3*n+r])*i,t[r]=(e[3*r+a]+e[3*a+r])*i,t[n]=(e[3*n+a]+e[3*a+n])*i}return t}B(),$();var rt=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t};function nt(){var t=new b(2);return b!=Float32Array&&(t[0]=0,t[1]=0),t}function ot(t,e){var i=new b(2);return i[0]=t,i[1]=e,i}function ht(t,e,i){return t[0]=e,t[1]=i,t}B(),D(1,0,0),D(0,1,0),et(),et(),_();function ct(t,e,i){return t<e?t=e:t>i&&(t=i),t}nt(),M(Array);const lt=function(){const t=_();return function(e){return V(t,e),t}}();function dt(t){let e,i,s;const[a,r,n,o,h,c,l,d,u]=t;return e=Math.asin(-ct(d,-1,1)),Math.abs(d)<.9999999?(i=Math.atan2(l,u),s=Math.atan2(r,h)):(i=Math.atan2(-n,a),s=0),{x:e,y:i,z:s}}class ut{outputPosition=B();outputRotation=et();zoomTarget;sceneVolume;camera;domElement;mouseButtonsMap={rotate:1,pan:4,orbit:2,pivot:2};fingersMap={rotate:1,pan:2,orbit:3,pivot:3,zoomZ:0};enabled=!0;autoZoomToScene=!0;lastRecordePoistion=void 0;recodedPosition=void 0;lastUpdatedPosition=0;lastUpdate=0;lastGesture=void 0;constructor(t){this.domElement=t}needPointerLock=!1;async setLastPosition(t,e){const{camera:i,enabled:s}=this;if(i&&s&&"flight"==this.params.kind&&this.params.proportionalCameraSpeed){if(this.lastUpdate-this.lastUpdatedPosition<this.params.proportionalCameraSpeed.pickDelay)return;const s=i.view,a=await(s.lastRenderOutput?.pick(t,e));a?(this.recodedPosition=a.position,this.lastRecordePoistion=a.position,this.lastUpdatedPosition=performance.now()):s._validPickBuffers&&(this.recodedPosition=void 0,this.lastUpdatedPosition=performance.now())}}connect(){this.domElement&&(this.domElement.addEventListener("click",this.preventDefault,!1),this.domElement.addEventListener("contextmenu",this.preventDefault,!1),this.domElement.addEventListener("mousedown",this.mousedown,!1),this.domElement.addEventListener("mouseup",this.mouseup,!1),this.domElement.addEventListener("mousemove",this.mousemove,!1),this.domElement.addEventListener("wheel",this.mousewheel,!1),this.domElement.addEventListener("touchstart",this.touchstart,!1),this.domElement.addEventListener("touchmove",this.touchmove,!1),this.domElement.addEventListener("touchend",this.touchend,!1),this.domElement.addEventListener("touchcancel",this.touchcancel,!1),this.domElement.focus())}disconnect(){this.domElement&&(this.domElement.removeEventListener("click",this.preventDefault,!1),this.domElement.removeEventListener("contextmenu",this.preventDefault,!1),this.domElement.removeEventListener("mousedown",this.mousedown,!1),this.domElement.removeEventListener("mouseup",this.mouseup,!1),this.domElement.removeEventListener("mousemove",this.mousemove,!1),this.domElement.removeEventListener("wheel",this.mousewheel,!1),this.domElement.removeEventListener("touchstart",this.touchstart,!1),this.domElement.removeEventListener("touchmove",this.touchmove,!1),this.domElement.removeEventListener("touchend",this.touchend,!1),this.domElement.removeEventListener("touchcancel",this.touchcancel,!1))}preventDefault=t=>{t.preventDefault()};mousedown=async t=>{this.camera&&this.enabled&&(this.needPointerLock=!0,"ortho"==this.params.kind&&(this.needPointerLock=null!=this.params.pointerLockOnPan&&this.params.pointerLockOnPan),this.lastGesture="mouse",(t.buttons&this.mouseButtonsMap.pan||t.buttons&this.mouseButtonsMap.orbit)&&await this.setLastPosition(t.offsetX,t.offsetY),t.preventDefault())};mouseup=t=>{this.camera&&this.enabled&&(t.preventDefault(),"exitPointerLock"in document&&document.exitPointerLock(),this.needPointerLock=!1)};mousewheel=async t=>{const{camera:e,enabled:i}=this;e&&i&&(this.lastGesture="mouse",await this.setLastPosition(t.offsetX,t.offsetY),this.zoom(t.deltaY,t.offsetX,t.offsetY))};mousemove=async t=>{if(this.camera&&this.enabled&&!(t.buttons<1||Math.abs(t.movementX)>100||Math.abs(t.movementY)>100))if(this.needPointerLock&&(t.currentTarget.requestPointerLock(),this.needPointerLock=!1),t.buttons&this.mouseButtonsMap.orbit){const e=_();V(e,this.outputRotation),this.orbit(t.movementX,t.movementY,e,!0)}else if(t.buttons&this.mouseButtonsMap.pan){const e=_();V(e,this.outputRotation),this.pan(t.movementX,t.movementY,e)}else t.buttons&this.mouseButtonsMap.rotate&&this.rotate(-t.movementX,-t.movementY)};pointerTable=[];_touchMovePrev=nt();prevTouchCenter=void 0;_touchZoomDistancePrev=0;touchstart=async t=>{if(this.camera&&this.enabled)if(this.lastGesture="touch",this.pointerTable=Array.from(t.touches).map((t=>({id:t.identifier,x:Math.round(t.clientX),y:Math.round(t.clientY)}))),1===this.pointerTable.length)ht(this._touchMovePrev,this.pointerTable[0].x,this.pointerTable[0].y);else{const t=this.pointerTable[0].x-this.pointerTable[1].x,e=this.pointerTable[0].y-this.pointerTable[1].y;this._touchZoomDistancePrev=Math.sqrt(t*t+e*e);const i=(this.pointerTable[0].x+this.pointerTable[1].x)/2,s=(this.pointerTable[0].y+this.pointerTable[1].y)/2;ht(this._touchMovePrev,i,s),await this.setLastPosition(i,s)}};touchend=t=>{if(this.camera&&this.enabled)switch(this.pointerTable=Array.from(t.touches).map((t=>({id:t.identifier,x:Math.round(t.clientX),y:Math.round(t.clientY)}))),this.pointerTable.length){case 0:break;case 1:ht(this._touchMovePrev,this.pointerTable[0].x,this.pointerTable[0].y);break;default:const t=this.pointerTable[0].x-this.pointerTable[1].x,e=this.pointerTable[0].y-this.pointerTable[1].y;this._touchZoomDistancePrev=Math.sqrt(t*t+e*e);const i=(this.pointerTable[0].x+this.pointerTable[1].x)/2,s=(this.pointerTable[0].y+this.pointerTable[1].y)/2;ht(this._touchMovePrev,i,s)}};touchcancel=t=>{this.camera&&this.enabled&&(t.preventDefault(),this.pointerTable=Array.from(t.touches).map((t=>({id:t.identifier,x:Math.round(t.clientX),y:Math.round(t.clientY)}))))};touchmove=t=>{if(!this.camera||!this.enabled)return;t.cancelable&&t.preventDefault(),this.pointerTable=Array.from(t.touches).map((t=>({id:t.identifier,x:Math.round(t.clientX),y:Math.round(t.clientY)})));let{x:e,y:i}=this.pointerTable[0];if(this.pointerTable.length>1){const t=this.pointerTable[0].x-this.pointerTable[1].x,s=this.pointerTable[0].y-this.pointerTable[1].y,a=Math.sqrt(t*t+s*s);e=(this.pointerTable[0].x+this.pointerTable[1].x)/2,i=(this.pointerTable[0].y+this.pointerTable[1].y)/2;const r=ot(e,i);let n=0;this.prevTouchCenter&&(n=function(t,e){var i=e[0]-t[0],s=e[1]-t[1];return Math.hypot(i,s)}(this.prevTouchCenter,r)),this.prevTouchCenter=r;const o=this._touchZoomDistancePrev-a;this._touchZoomDistancePrev=a,this.pointerTable.length==this.fingersMap.zoomZ&&"ortho"==this.params.kind?this.zoomZ(o/20):2===this.pointerTable.length&&2*n<Math.abs(o)&&this.zoom(o,e,i)}else this.prevTouchCenter=void 0;switch(this.pointerTable.length){case this.fingersMap.rotate:this.rotate(e-this._touchMovePrev[0],i-this._touchMovePrev[1]);break;case this.fingersMap.orbit:this.orbit(this._touchMovePrev[0]-e,this._touchMovePrev[1]-i,V(_(),this.outputRotation));break;case this.fingersMap.pan:this.pan(e-this._touchMovePrev[0],i-this._touchMovePrev[1],V(_(),this.outputRotation))}ht(this._touchMovePrev,e,i)};update(t,e,i){this.lastUpdate=performance.now(),this.enabled&&(t!=this.camera&&(this.camera=t,t&&this.newCamera(t)),t&&(this.sceneVolume!==e&&(this.sceneVolume=e,e&&(this.newScene(e,t),!this.zoomTarget&&this.autoZoomToScene&&(this.zoomTarget=e))),this.zoomTarget&&(this.bringIntoView(this.zoomTarget,t),this.zoomTarget=void 0)),this.animate(i),this.output(this.outputPosition,this.outputRotation),t&&(j(t.position,this.outputPosition),rt(t.rotation,this.outputRotation)))}zoomTo=t=>{this.zoomTarget=t};moveTo=(t,e)=>{};newScene(t,e){e.near=t.radius/5e3,e.far=10*t.radius}newCamera(t){}animate(t){}rotate(t,e){}pan(t,e,i){}orbit(t,e,i,s){}zoom(t,e,i){}zoomZ(t){}}class mt extends ut{static defaultParams={kind:"static",position:D(0,0,1),target:D(0,0,0),up:D(0,1,0)};inputParams;params;constructor(t){super(),this.inputParams=t,this.params={...mt.defaultParams,...t}}reset(){Object.assign(this.params,mt.defaultParams,this.inputParams),this.sceneVolume=void 0}bringIntoView(t,e){let i;switch(j(this.params.target,t.center),e.kind){case"pinhole":i=t.radius/Math.tan(P(e.fieldOfView)/2);break;case"orthographic":i=t.radius,e.fieldOfView=2*t.radius}if(i){const t=B();z(t,this.params.target,this.params.position);const e=1e-6;K(t,t)>e?H(t,t):W(t,0,0,1),N(t,t,i),I(this.params.position,this.params.target,t)}}output(t,e){const i=S(),s=_();var a,r;!function(t,e,i,s){var a=e[0],r=e[1],n=e[2],o=s[0],h=s[1],c=s[2],l=a-i[0],d=r-i[1],u=n-i[2],m=l*l+d*d+u*u;m>0&&(l*=m=1/Math.sqrt(m),d*=m,u*=m);var p=h*u-c*d,f=c*l-o*u,w=o*d-h*l;(m=p*p+f*f+w*w)>0&&(p*=m=1/Math.sqrt(m),f*=m,w*=m),t[0]=p,t[1]=f,t[2]=w,t[3]=0,t[4]=d*w-u*f,t[5]=u*p-l*w,t[6]=l*f-d*p,t[7]=0,t[8]=l,t[9]=d,t[10]=u,t[11]=0,t[12]=a,t[13]=r,t[14]=n,t[15]=1}(i,this.params.position,this.params.target,this.params.up),r=i,(a=s)[0]=r[0],a[1]=r[1],a[2]=r[2],a[3]=r[4],a[4]=r[5],a[5]=r[6],a[6]=r[8],a[7]=r[9],a[8]=r[10],at(e,s),j(t,this.params.position)}}class pt extends ut{static defaultParams={kind:"turntable",pivotPoint:D(0,0,0),distance:20,elevation:.5,rotation:0,rotationalVelocity:30};inputParams;params;constructor(t){super(),this.inputParams=t,this.params={...pt.defaultParams,...t}}reset(){Object.assign(this.params,pt.defaultParams,this.inputParams),this.sceneVolume=void 0}bringIntoView(t,e){switch(this.params.pivotPoint=t.center,e.kind){case"pinhole":this.params.distance=t.radius/Math.tan(P(e.fieldOfView)/2);break;case"orthographic":this.params.distance=t.radius,e.fieldOfView=2*t.radius}}animate(t){for(this.params.rotation+=this.params.rotationalVelocity*t;this.params.rotation>=360;)this.params.rotation-=360;for(;this.params.rotation<0;)this.params.rotation+=360}output(t,e){const i=P(this.params.rotation),s=Math.atan2(this.params.elevation,this.params.distance),a=et();var r,n,o;st(a,a,i),it(e,a,-s);const h=D(0,0,(n=(r=ot(this.params.elevation,this.params.distance))[0],o=r[1],Math.hypot(n,o)));Y(h,h,e),I(t,this.params.pivotPoint,h)}}class ft extends ut{static defaultParams={kind:"orbit",pivotPoint:B(),distance:0,pitch:30,yaw:0,maxDistance:1e3,rotationalVelocity:.2,linearVelocity:.01};mouseButtonsMap={rotate:1,pan:2,orbit:0,pivot:0};inputParams;params;constructor(t,e){super(e),this.inputParams=t,this.params={...ft.defaultParams,...t}}reset(){Object.assign(this.params,ft.defaultParams,this.inputParams),this.sceneVolume=void 0}newCamera(t){const e=lt(t.rotation),{x:i,y:s}=dt(e);this.params.yaw=s*Math.PI/180,this.params.pitch=i*Math.PI/180,this.wrapYaw(),this.clampPitch()}wrapYaw(){for(;this.params.yaw>=360;)this.params.yaw-=360;for(;this.params.yaw<0;)this.params.yaw+=360}clampPitch(){this.params.pitch=ct(this.params.pitch,-89,89)}clampDistance(){this.params.distance=ct(this.params.distance,0,this.params.maxDistance)}bringIntoView(t,e){switch(this.params.pivotPoint=t.center,e.kind){case"pinhole":this.params.distance=t.radius/Math.tan(P(e.fieldOfView)/2);break;case"orthographic":this.params.distance=t.radius,e.fieldOfView=2*t.radius}}newScene(t,e){super.newScene(t,e),this.params.linearVelocity=t.radius/1e3,this.params.maxDistance=50*t.radius}output(t,e){const i=P(this.params.yaw),s=P(this.params.pitch),a=et();st(a,a,i),it(e,a,-s);const r=D(0,0,this.params.distance);Y(r,r,e),I(t,this.params.pivotPoint,r)}rotate(t,e){this.params.yaw+=-t*this.params.rotationalVelocity,this.params.pitch+=e*this.params.rotationalVelocity,this.wrapYaw(),this.clampPitch()}pan(t,e,i){const s=D(-t*this.params.linearVelocity,0,0),a=D(0,e*this.params.linearVelocity,0),r=B();q(s,s,i),q(a,a,i),I(r,s,a),I(this.params.pivotPoint,this.params.pivotPoint,r)}zoom(t){this.params.distance+=t*this.params.linearVelocity,this.clampDistance()}}class wt extends ut{static defaultParams={kind:"flight",position:B(),pivotPoint:void 0,pitch:-30,yaw:30,linearVelocity:.03,autoZoomSpeed:!1,near:.1,far:5e3,flightTime:1,fieldOfView:60,proportionalCameraSpeed:{min:5,max:300,pickDelay:1e3}};inputParams;get params(){return this.state}state;distance;targetPosition=B();target_pitch=0;target_yaw=0;remainTime=-1;keys=new Set;constructor(t,e){super(e),this.inputParams=t,this.state={...wt.defaultParams,...t},j(this.outputPosition,this.state.position)}reset(){Object.assign(this.params,wt.defaultParams,this.inputParams),this.sceneVolume=void 0,this.distance=void 0,W(this.targetPosition,0,0,0),this.target_pitch=0,this.target_yaw=0,this.remainTime=-1,j(this.outputPosition,this.state.position),rt(this.outputRotation,et())}connect(){super.connect(),this.state.pivotPoint=void 0,this.domElement.tabIndex=0,this.domElement.addEventListener("mousedown",this.handleMouseDown,!1),this.domElement.addEventListener("blur",this.blur,!1),this.domElement.addEventListener("keydown",this.keydown,!1),this.domElement.addEventListener("keyup",this.keyup,!1),this.domElement.addEventListener("touchstart",this._touchstart,!1),this.domElement.addEventListener("touchend",this._touchstart,!1)}disconnect(){super.disconnect(),this.domElement.removeEventListener("mousedown",this.handleMouseDown,!1),this.domElement.removeEventListener("blur",this.blur,!1),this.domElement.removeEventListener("keydown",this.keydown,!1),this.domElement.removeEventListener("keyup",this.keyup,!1),this.domElement.removeEventListener("touchstart",this._touchstart,!1),this.domElement.removeEventListener("touchend",this._touchstart,!1)}_touchstart=async t=>{const e=this.camera?.view;if(e&&this.enabled)if(this.pointerTable.length===this.fingersMap.pivot){let t=this.pointerTable[0].x,i=this.pointerTable[0].y;this.pointerTable.length>1&&(t=.5*(this.pointerTable[0].x+this.pointerTable[1].x),i=.5*(this.pointerTable[0].y+this.pointerTable[1].y));const s=await(e.lastRenderOutput?.pick(t,i));this.state.pivotPoint=s?s.position:this.lastRecordePoistion?this.lastRecordePoistion:void 0,this.state.pivotPoint?(this.distance=U(this.state.pivotPoint,this.state.position),(this.distance>this.state.far||this.distance>5e4)&&(this.distance=void 0,this.state.pivotPoint=void 0)):this.distance=void 0}else this.state.pivotPoint=void 0};handleMouseDown=async t=>{const e=this.camera?.view;if(e&&this.enabled&&(this.domElement.focus(),t.preventDefault(),this.distance=void 0,t.buttons&this.mouseButtonsMap.pivot)){const i=await(e.lastRenderOutput?.pick(t.offsetX,t.offsetY));this.state.pivotPoint=i?i.position:this.lastRecordePoistion?this.lastRecordePoistion:void 0,this.state.pivotPoint?(this.distance=U(this.state.pivotPoint,this.state.position),(this.distance>this.state.far||this.distance>5e4)&&(this.distance=void 0,this.state.pivotPoint=void 0)):this.distance=void 0}};zoomTo=t=>{if(this.camera&&this.enabled)if(0===this.state.flightTime)this.bringIntoView(t,this.camera);else{const e=Math.max(t.radius/Math.tan(P(this.camera.fieldOfView)/2),t.radius+this.state.near);this.output(B(),this.outputRotation),I(this.targetPosition,Y(this.targetPosition,D(0,0,e),this.outputRotation),t.center),this.target_pitch=this.state.pitch,this.target_yaw=this.state.yaw,this.remainTime=this.state.flightTime,this.state.yaw+=.05}};moveTo=(t,e)=>{if(!this.enabled)return;j(this.targetPosition,t);const i=lt(e),{x:s,y:a}=dt(i);this.target_yaw=180*a/Math.PI,this.target_yaw>=360?this.target_yaw-=360:this.target_yaw<0&&(this.target_yaw+=360),this.target_pitch=ct(180*s/Math.PI,-89,89),this.remainTime=this.state.flightTime,this.state.yaw+=.05};animate(t){if(this.enabled){if(this.camera&&this.state.near>0&&(this.camera.near=this.state.near),this.camera&&this.state.far>0&&(this.camera.far=this.state.far),this.camera&&this.state.fieldOfView>0&&0==this.mouseButtonsMap.pan&&(this.camera.fieldOfView=this.state.fieldOfView),(t<0||t>.25)&&(t=.01666666),this.remainTime>=0){if(t>=this.remainTime)this.state.yaw=this.target_yaw,this.state.pitch=this.target_pitch,j(this.state.position,this.targetPosition);else{const h=t/this.remainTime;e=this.state.position,i=this.state.position,s=this.targetPosition,a=h,r=i[0],n=i[1],o=i[2],e[0]=r+a*(s[0]-r),e[1]=n+a*(s[1]-n),e[2]=o+a*(s[2]-o);let c=this.target_yaw-this.state.yaw;c<-180?c+=360:c>180&&(c-=360),this.state.yaw+=c*h,this.state.pitch+=(this.target_pitch-this.state.pitch)*h,this.wrapYaw(),this.clampPitch()}this.remainTime-=t}var e,i,s,a,r,n,o;if(this.keys.size){let e=1;this.keys.has("ShiftLeft")&&(e*=2),this.keys.has("ShiftRight")&&(e*=2),this.keys.has("ControlLeft")&&(e*=5),this.keys.has("ControlRight")&&(e*=5),this.keys.has("AltLeft")&&(e*=.2),this.keys.has("AltRight")&&(e*=.2);let i=0,s=0,a=0,r=this.state.linearVelocity*t*100*e;if("pinhole"==this.camera?.kind&&this.mouseButtonsMap.pan>0?(this.keys.has("KeyW")&&(a-=r),this.keys.has("KeyS")&&(a+=r)):this.camera&&(this.keys.has("KeyW")&&(this.state.fieldOfView*=.995,this.state.fieldOfView=this.state.fieldOfView<.1?.1:this.state.fieldOfView),this.keys.has("KeyS")&&(this.state.fieldOfView*=1.005,this.state.fieldOfView=this.state.fieldOfView>60?60:this.state.fieldOfView)),this.mouseButtonsMap.pan>0&&(this.keys.has("KeyA")&&(i-=r),this.keys.has("KeyD")&&(i+=r),this.keys.has("KeyQ")&&(s-=r),this.keys.has("KeyE")&&(s+=r),0!=i||0!=s||0!=a)){const t=D(i,s,a);Y(t,t,this.outputRotation),I(this.state.position,this.state.position,t)}let n=0,o=0,h=60*t;this.keys.has("ArrowUp")&&(n-=h),this.keys.has("ArrowDown")&&(n+=h),this.keys.has("ArrowLeft")&&(o+=h),this.keys.has("ArrowRight")&&(o-=h),0==n&&0==o||(this.state.yaw+=o,this.state.pitch+=n,this.wrapYaw(),this.clampPitch())}this.camera&&(this.camera.kind="pinhole")}}newCamera(t){}wrapYaw(){for(;this.state.yaw>=360;)this.state.yaw-=360;for(;this.state.yaw<0;)this.state.yaw+=360}clampPitch(){this.state.pitch=ct(this.state.pitch,-89,89)}bringIntoView(t,e){switch(e.kind){case"pinhole":{const i=t.radius/Math.tan(P(e.fieldOfView)/2);this.output(B(),this.outputRotation),I(this.state.position,Y(this.state.position,D(0,0,i),this.outputRotation),t.center);break}case"orthographic":e.fieldOfView=2*t.radius}}newScene(t,e){super.newScene(t,e),this.state.near>0&&(e.near=this.state.near),this.state.far>0&&(e.far=this.state.far),0===this.state.linearVelocity&&(this.state.linearVelocity=.03)}output(t,e){const i=P(this.state.yaw),s=P(this.state.pitch),a=et();st(a,a,i),it(e,a,s),j(t,this.state.position)}rotate(t,e){const i=this.domElement.clientHeight;this.state.yaw+=t*this.camera.fieldOfView/i,this.state.pitch+=e*this.camera.fieldOfView/i,this.wrapYaw(),this.clampPitch()}pan(t,e,i){const{camera:s,recodedPosition:a,params:r,lastGesture:n}=this,{proportionalCameraSpeed:o}=r;let h="linearVelocity"in this.params?this.params.linearVelocity:1;o&&a&&s&&(h="mouse"==n?ct(h*(Q(a,s.position)/150),o.min/5e3,o.max/600):ct(h*(Q(a,s.position)/30),o.min/1e3,o.max/100));const c=D(-t*h,0,0),l=D(0,e*h,0),d=B();q(c,c,i),q(l,l,i),I(d,c,l),I(this.state.position,this.state.position,d)}orbit(t,e,i,s){if(this.state.pivotPoint){const i=this.state.pitch,f=this.state.yaw;s?(e*=-5,t*=-5):(e*=5,t*=5);const w=B();Z(w,this.state.position,this.state.pivotPoint);const v=D(1,0,0);Y(v,v,this.outputRotation),this.rotate(t,e),e=this.state.pitch-i,t=this.state.yaw-f;const g=et(),y=et();(function(t,e,i){i*=.5;var s=Math.sin(i);t[0]=s*e[0],t[1]=s*e[1],t[2]=s*e[2],t[3]=Math.cos(i)})(g,v,P(e)),st(y,y,P(t));const b=et();a=b,n=g,o=(r=y)[0],h=r[1],c=r[2],l=r[3],d=n[0],u=n[1],m=n[2],p=n[3],a[0]=o*p+l*d+h*m-c*u,a[1]=h*p+l*u+c*d-o*m,a[2]=c*p+l*m+o*u-h*d,a[3]=l*p-o*d-h*u-c*m;const M=V(_(),b);I(this.state.position,q(w,w,M),this.state.pivotPoint)}else this.pan(t,e,i);var a,r,n,o,h,c,l,d,u,m,p}zoom(t,e,i){if(0==t||this.keys.has("ShiftLeft")||this.keys.has("ShiftRight"))return;const{recodedPosition:s,camera:a,lastGesture:r,params:n}=this,{proportionalCameraSpeed:o}=n;if(0!=this.mouseButtonsMap.pan&&o&&s&&a&&r){const e=t<0?-1:1;t="mouse"==r?ct(Math.abs(t*((Q(s,a.position)-a.near)/90)),o.min,o.max)*e:ct(Math.abs(t*((Q(s,a.position)-a.near)/30)),o.min/6,o.max/2)*e}const h=this.domElement.clientWidth,c=this.domElement.clientHeight;if("pinhole"==this.camera?.kind){const s=S();A(s,P(this.camera.fieldOfView),h/c,this.camera.near,this.camera.far);const a=D(2*e/h-1,1-2*i/c,0);E(s,s),F(a,a,s);const r=_();if(V(r,this.outputRotation),q(a,a,r),H(a,a),this.mouseButtonsMap.pan<1){const s=.001*t,a=Math.max(Math.min(60,this.camera.fieldOfView*(1+s)),.1),r=a-this.camera.fieldOfView;if(0===r)return;this.state.fieldOfView=a;const n=r*(e-.5*h)/c,o=r*(i/c-.5);return this.state.yaw+=n,this.state.pitch+=o,this.wrapYaw(),void this.clampPitch()}let n=this.state.autoZoomSpeed&&this.distance?this.distance*Math.tan(P(this.camera.fieldOfView))/c:this.state.linearVelocity;this.keys.size&&(this.keys.has("ShiftLeft")&&(n*=2),this.keys.has("ShiftRight")&&(n*=2),this.keys.has("ControlLeft")&&(n*=5),this.keys.has("ControlRight")&&(n*=5),this.keys.has("AltLeft")&&(n*=.2),this.keys.has("AltRight")&&(n*=.2)),N(a,a,-t*n),I(this.state.position,this.state.position,a)}else if("orthographic"==this.camera?.kind){const s=t/500;if(this.state.fieldOfView*=1+s,t<0){const t=i/c-.5,s=D((e/h-.5)*this.state.fieldOfView,t*this.state.fieldOfView*-1,0);I(this.state.position,this.state.position,Y(s,s,this.outputRotation))}}}blur=t=>{"exitPointerLock"in document&&document.exitPointerLock(),this.keys.clear()};keydown=t=>{switch(t.code){case"KeyW":case"KeyS":case"KeyA":case"KeyD":case"KeyQ":case"KeyE":t.preventDefault()}this.keys.add(t.code)};keyup=t=>{switch(t.code){case"KeyW":case"KeyS":case"KeyA":case"KeyD":case"KeyQ":case"KeyE":t.preventDefault()}this.keys.delete(t.code)}}class vt extends ut{static defaultParams={kind:"ortho",referenceCoordSys:S(),position:B(),linearVelocity:.01,near:.1,far:5e3,fieldOfView:2,pointerLockOnPan:!1};inputParams;params;keys=new Set;constructor(t,e){super(e),this.inputParams=t,this.params={...vt.defaultParams,...t}}reset(){Object.assign(this.params,vt.defaultParams,this.inputParams),this.sceneVolume=void 0}update(t,e,i){super.update(t,e,i);const{params:s}=this;t&&(t.far=s.far,t.near=s.near)}connect(){super.connect(),this.domElement.tabIndex=0,this.domElement.addEventListener("mousedown",this.handleMouseDown,!1),this.domElement.addEventListener("blur",this.blur,!1),this.domElement.addEventListener("keydown",this.keydown,!1),this.domElement.addEventListener("keyup",this.keyup,!1),this.domElement.addEventListener("touchstart",this._touchstart,!1),this.domElement.addEventListener("touchend",this._touchstart,!1),this.domElement.focus()}disconnect(){super.disconnect(),this.domElement.removeEventListener("mousedown",this.handleMouseDown,!1),this.domElement.removeEventListener("blur",this.blur,!1),this.domElement.removeEventListener("keydown",this.keydown,!1),this.domElement.removeEventListener("keyup",this.keyup,!1),this.domElement.removeEventListener("touchstart",this._touchstart,!1),this.domElement.removeEventListener("touchend",this._touchstart,!1)}_touchstart=async t=>{this.camera?.view};handleMouseDown=async t=>{const e=this.camera?.view;e&&(this.domElement.focus(),t.preventDefault(),t.buttons,this.mouseButtonsMap.pivot)};zoomTo=t=>{this.camera&&this.bringIntoView(t,this.camera)};moveTo=(t,e)=>{if(!this.camera)return;const i=R(S(),e,t);this.params.referenceCoordSys=i,W(this.params.position,0,0,1)};animate(t){if(this.camera&&this.params.near>0&&(this.camera.near=this.params.near),this.camera&&this.params.far>0&&(this.camera.far=this.params.far),this.camera&&this.params.fieldOfView>0&&(this.camera.fieldOfView=this.params.fieldOfView),this.keys.size){let e=1;this.keys.has("ShiftLeft")&&(e*=2),this.keys.has("ShiftRight")&&(e*=2),this.keys.has("ControlLeft")&&(e*=5),this.keys.has("ControlRight")&&(e*=5),this.keys.has("AltLeft")&&(e*=.2),this.keys.has("AltRight")&&(e*=.2);let i=0,s=0,a=this.params.linearVelocity*t*100*e;if(this.camera&&(this.keys.has("KeyQ")&&(this.params.fieldOfView*=.99),this.keys.has("KeyE")&&(this.params.fieldOfView*=1.01)),this.keys.has("KeyA")&&(i-=a*this.params.fieldOfView),this.keys.has("KeyD")&&(i+=a*this.params.fieldOfView),this.keys.has("KeyW")&&(s+=a*this.params.fieldOfView),this.keys.has("KeyS")&&(s-=a*this.params.fieldOfView),this.keys.has("ArrowLeft")&&(this.params.referenceCoordSys=L(S(),this.params.referenceCoordSys,Math.PI/256*e)),this.keys.has("ArrowRight")&&(this.params.referenceCoordSys=L(S(),this.params.referenceCoordSys,-Math.PI/256*e)),0!=i||0!=s){const t=D(i,s,0);I(this.params.position,this.params.position,t)}}this.camera&&(this.camera.kind="orthographic")}newCamera(t){}bringIntoView(t,e){e.fieldOfView=2*t.radius}newScene(t,e){super.newScene(t,e),this.params.near>0&&(e.near=this.params.near),this.params.far>0&&(e.far=this.params.far),0===this.params.linearVelocity&&(this.params.linearVelocity=t.radius/1e3)}output(t,e){const{position:i,referenceCoordSys:s}=this.params;O(e,s),F(t,i,s)}pan(t,e){const i=this.params.fieldOfView/this.domElement.clientHeight;I(this.params.position,this.params.position,D(-t*i,e*i,0))}zoom(t,e,i){if(this.keys.has("ShiftLeft")||this.keys.has("ShiftRight"))return void this.zoomZ(t/100);const{camera:s,domElement:a}=this;if(0!=t&&s){const s=a.clientHeight,r=1+t/s,n=-(e-a.clientWidth/2)/s*2*t/2,o=(i-s/2)/s*2*t/2;this.params.fieldOfView*=r;const h=this.params.fieldOfView/s,c=O(et(),this.params.referenceCoordSys),l=Y(B(),D(n*h,o*h,0),c);this.params.referenceCoordSys[12]+=l[0],this.params.referenceCoordSys[13]+=l[1],this.params.referenceCoordSys[14]+=l[2]}}zoomZ(t){const e=O(et(),this.params.referenceCoordSys),i=Y(B(),D(0,0,t),e);this.params.referenceCoordSys[12]+=i[0],this.params.referenceCoordSys[13]+=i[1],this.params.referenceCoordSys[14]+=i[2]}blur=t=>{"exitPointerLock"in document&&document.exitPointerLock(),this.keys.clear()};keydown=t=>{switch(t.code){case"KeyW":case"KeyS":case"KeyA":case"KeyD":case"KeyQ":case"KeyE":t.preventDefault()}this.keys.add(t.code)};keyup=t=>{switch(t.code){case"KeyW":case"KeyS":case"KeyA":case"KeyD":case"KeyQ":case"KeyE":t.preventDefault()}this.keys.delete(t.code)};init(t,e,i){const{params:s}=this;if(e){const n=(a=e,(r=new b(3))[0]=a[0],r[1]=a[1],r[2]=a[2],r),o=D(0,1,0);Y(o,o,i.rotation);const h=G(B(),o,n);!function(t){const[e,i,s]=t;t[0]=t[1]=t[2]=0;const a=Math.abs(e),r=Math.abs(i),n=Math.abs(s);a>r&&a>n?t[0]=Math.sign(e):r>n?t[1]=Math.sign(i):t[2]=Math.sign(s)}(h),G(o,n,h),H(o,o),G(h,o,n),H(h,h);const c=function(t,e,i,s,a,r,n,o,h){var c=new b(9);return c[0]=t,c[1]=e,c[2]=i,c[3]=s,c[4]=a,c[5]=r,c[6]=n,c[7]=o,c[8]=h,c}(h[0],h[1],h[2],o[0],o[1],o[2],n[0],n[1],n[2]),l=at(et(),c),d=R(S(),l,t);s.referenceCoordSys=d,W(s.position,0,0,1)}else{const t=V(_(),i.rotation),e=i.position;s.referenceCoordSys=function(t,e,i,s,a,r,n,o,h,c,l,d,u,m,p,f){var w=new b(16);return w[0]=t,w[1]=e,w[2]=i,w[3]=0,w[4]=a,w[5]=r,w[6]=n,w[7]=0,w[8]=h,w[9]=c,w[10]=l,w[11]=0,w[12]=u,w[13]=m,w[14]=p,w[15]=1,w}(t[0],t[1],t[2],0,t[3],t[4],t[5],0,t[6],t[7],t[8],0,e[0],e[1],e[2])}var a,r;if(W(s.position,0,0,1),"pinhole"==i.kind){const e=i.getDistanceFromViewPlane(t),a=Math.max(.1,e)*Math.tan(Math.PI/180*i.fieldOfView/2)*2;s.fieldOfView=a}}}class gt{view;kind="pinhole";_controller=new mt({kind:"static"});position=B();rotation=et();fieldOfView=45;near=.1;far=1e3;generation=0;previousState={position:B(),rotation:et(),fieldOfView:0,near:0,far:0,kind:"pinhole"};viewClipMatrix=S();viewWorldMatrix=S();viewFrustum={left:$(),right:$(),top:$(),bottom:$(),near:$(),far:$(),image:$()};constructor(t){this.view=t}get controller(){return this._controller}set controller(t){this._controller!=t&&(this._controller.disconnect(),this._controller=t,this._controller.connect())}getDistanceFromViewPlane(t){const{position:e,rotation:i}=this,s=D(0,0,-1);Y(s,s,i);const a=-K(s,e);return K(t,s)+a}update(t){const{position:e,rotation:i,fieldOfView:s,generation:a}=this;this.updateState();const{viewClipMatrix:r,viewWorldMatrix:n,viewFrustum:o}=this;if("orthographic"==this.kind){const a=s/2,h=a*t;(function(t,e,i,s,a,r,n){var o=1/(e-i),h=1/(s-a),c=1/(r-n);t[0]=-2*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+i)*o,t[13]=(a+s)*h,t[14]=(n+r)*c,t[15]=1})(r,-h,h,-a,a,this.near,this.far),R(n,i,e);const{left:c,right:l,top:d,bottom:u,near:m,far:p,image:f}=o;tt(c,-1,0,0,h),tt(l,1,0,0,h),tt(d,0,1,0,a),tt(u,0,-1,0,a),tt(m,0,0,1,-this.near),tt(p,0,0,-1,this.far),tt(f,0,0,-1,0)}else{A(r,P(s),t,this.near,this.far),R(n,i,e);const a=P(s/2),h=Math.atan(Math.tan(a)*t),{left:c,right:l,top:d,bottom:u,near:m,far:p,image:f}=o;tt(c,-Math.cos(h),0,Math.sin(h),0),tt(l,Math.cos(h),0,Math.sin(h),0),tt(d,0,Math.cos(a),Math.sin(a),0),tt(u,0,-Math.cos(a),Math.sin(a),0),tt(m,0,0,1,-this.near),tt(p,0,0,-1,this.far),tt(f,0,0,-1,0)}return{generation:a,viewFrustum:o,viewClipMatrix:r,viewWorldMatrix:n}}get hasChanged(){const{previousState:t}=this;return e=t.position,i=this.position,!(e[0]===i[0]&&e[1]===i[1]&&e[2]===i[2]&&function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}(t.rotation,this.rotation)&&x(t.fieldOfView,this.fieldOfView)&&x(t.near,this.near)&&x(t.far,this.far)&&t.kind==this.kind);var e,i}updateState(){const{hasChanged:t}=this;if(t){const{previousState:t}=this;j(t.position,this.position),rt(t.rotation,this.rotation),t.fieldOfView=this.fieldOfView,t.near=this.near,t.far=this.far,t.kind=this.kind,this.generation++}return t}}var yt;function bt(t,e){return 4*t+e}!function(t){t[t.Model=0]="Model",t[t.World=1]="World",t[t.View=2]="View",t[t.Clip=3]="Clip"}(yt||(yt={}));const Mt=[0,0,0],kt=[0,0,0];function Pt(t){return{modelWorldMatrix:t.getMatrix(yt.Model,yt.World),modelViewMatrix:t.getMatrix(yt.Model,yt.View),modelClipMatrix:t.getMatrix(yt.Model,yt.Clip),clipViewMatrix:t.getMatrix(yt.Clip,yt.View),clipWorldMatrix:t.getMatrix(yt.Clip,yt.World),clipModelMatrix:t.getMatrix(yt.Clip,yt.Model),worldViewMatrix:t.getMatrix(yt.World,yt.View),worldClipMatrix:t.getMatrix(yt.World,yt.Clip),viewWorldMatrix:t.getMatrix(yt.View,yt.World),viewModelMatrix:t.getMatrix(yt.View,yt.Model),viewClipMatrix:t.getMatrix(yt.View,yt.Clip),worldModelMatrix:t.getMatrix(yt.World,yt.Model)}}function xt(t){return{modelWorldNormalMatrix:t.getMatrixNormal(yt.Model,yt.World),modelViewNormalMatrix:t.getMatrixNormal(yt.Model,yt.View),modelClipNormalMatrix:t.getMatrixNormal(yt.Model,yt.Clip),clipViewNormalMatrix:t.getMatrixNormal(yt.Clip,yt.View),clipWorldNormalMatrix:t.getMatrixNormal(yt.Clip,yt.World),clipModelNormalMatrix:t.getMatrixNormal(yt.Clip,yt.Model),worldViewNormalMatrix:t.getMatrixNormal(yt.World,yt.View),worldClipNormalMatrix:t.getMatrixNormal(yt.World,yt.Clip),viewWorldNormalMatrix:t.getMatrixNormal(yt.View,yt.World),viewModelNormalMatrix:t.getMatrixNormal(yt.View,yt.Model),viewClipNormalMatrix:t.getMatrixNormal(yt.View,yt.Clip),worldModelNormalMatrix:t.getMatrixNormal(yt.World,yt.Model)}}class _t{_mtx4=new Array(16);_mtx3=new Array(16);constructor(t,e,i){this._mtx4[bt(yt.Model,yt.World)]=t,this._mtx4[bt(yt.View,yt.World)]=e,this._mtx4[bt(yt.View,yt.Clip)]=i;const s=this._mtx4[bt(yt.World,yt.Model)]=S(),a=this._mtx4[bt(yt.World,yt.View)]=S(),r=this._mtx4[bt(yt.Clip,yt.View)]=S();E(s,t),E(a,e),E(r,i)}getMatrix(t,e){const i=bt(t,e);let s=this._mtx4[i];return s||(this._mtx4[i]=s=S(),e>t?T(s,this.getMatrix(e-1,e),this.getMatrix(t,e-1)):T(s,this.getMatrix(t-1,e),this.getMatrix(t,t-1))),s}getMatrixNormal(t,e){const i=bt(t,e);let s=this._mtx3[i];var a,r,n,o,h,c,l,d,u,m,p,f,w,v,g,y,b,M,k,P,x,V,S,E,T,L,R,C,O,A,B;return s||(this._mtx3[i]=s=_(),a=s,n=(r=this.getMatrix(t,e))[0],o=r[1],h=r[2],c=r[3],l=r[4],d=r[5],u=r[6],m=r[7],p=r[8],f=r[9],w=r[10],v=r[11],g=r[12],y=r[13],b=r[14],(B=(k=n*d-o*l)*(A=w*(M=r[15])-v*b)-(P=n*u-h*l)*(O=f*M-v*y)+(x=n*m-c*l)*(C=f*b-w*y)+(V=o*u-h*d)*(R=p*M-v*g)-(S=o*m-c*d)*(L=p*b-w*g)+(E=h*m-c*u)*(T=p*y-f*g))&&(B=1/B,a[0]=(d*A-u*O+m*C)*B,a[1]=(u*R-l*A-m*L)*B,a[2]=(l*O-d*R+m*T)*B,a[3]=(h*O-o*A-c*C)*B,a[4]=(n*A-h*R+c*L)*B,a[5]=(o*R-n*O-c*T)*B,a[6]=(y*E-b*S+M*V)*B,a[7]=(b*x-g*E-M*P)*B,a[8]=(g*S-y*x+M*k)*B)),s}}class Vt{itemRefs=[];add(t){const e=new WeakRef(t);this.itemRefs.push(e)}remove(t){const e=this.itemRefs.findIndex((e=>e.deref()==t));this.itemRefs.splice(e,1)}*[Symbol.iterator](){const{itemRefs:t}=this,e=[];for(let i=0;i<t.length;i++){const s=t[i].deref();s?yield s:e.push(i)}e.reverse();for(const i of e)t.splice(i,1)}}function St(t){if("object"!=typeof t)return t;let e;const i=t.constructor;switch(i){case RegExp:e=new RegExp(t);break;case Date:e=new Date(t.getTime());break;default:e=ArrayBuffer.isView(t)||t instanceof ArrayBuffer?structuredClone(t):i?new i:Object.create(null)}for(var s in t){const i=t[s];"function"!=typeof i&&(e[s]=St(i))}return e}const Et=Symbol("scope");function Tt(t,...e){for(const i of e)if(void 0!==i)for(const e of Reflect.ownKeys(i))void 0!==t[e]&&(`#${e.toString()}`in t||t[e]!==Object(t[e])?Reflect.set(t,e,i[e]):Tt(t[e],i[e]))}function Lt(t){return Reflect.defineProperty(t,Et,{enumerable:!1}),t}class Rt{onChange;proxy;constructor(t,e){this.onChange=t,this.proxy=e??Object.create(null)}wrap(t){for(let e in t){const i=t[e];i&&"object"==typeof i&&Et in i?this.scope(e,i):this.mutable(e,i)}}mutable(t,e){const{proxy:i,onChange:s}=this;"object"==typeof e&&(e=Array.isArray(e)?[...e]:{...e},Object.seal(e));const a=`#${t.toString()}`;Reflect.defineProperty(i,a,{enumerable:!1,value:e,writable:!0}),Reflect.defineProperty(i,t,{enumerable:!0,get:function(){return this[a]},set:function(t){this[a]!=t&&(this[a]=t,s())}})}scope(t,e){const{proxy:i,onChange:s}=this,a=new Rt(s);a.wrap(e),Reflect.defineProperty(i,t,{enumerable:!0,writable:!1,value:a.proxy})}}const Ct={display:Lt({width:150,height:100}),grid:Lt({enabled:!1,majorLineCount:21,minorLineCount:0,origo:B(),axisX:D(1,0,0),axisY:D(0,1,0),majorColor:[.5,1,.5],minorColor:[1,.5,.5]}),background:Lt({color:[0,0,.25,1],skyBoxBlur:0}),clippingPlanes:Lt({enabled:!1,inside:!0,showBox:!1,bounds:Lt({min:[0,0,0],max:[0,0,0]}),highlight:0}),clippingVolume:Lt({enabled:!1,mode:"union",planes:[]}),environment:void 0,exposure:0,light:Lt({ambient:{brightness:.1},camera:Lt({brightness:0,distance:10}),sun:Lt({brightness:1,position:Lt({azimuth:135,inclination:45})})}),objectHighlights:[],points:Lt({shape:"disc",size:Lt({pixel:1,maxPixel:void 0,metric:0,toleranceFactor:0}),deviation:Lt({mode:"mix",index:0,colors:[{deviation:-1,color:[1,0,0,1]},{deviation:-.5,color:[1,1,0,1]},{deviation:-.45,color:[1,1,0,0]},{deviation:.45,color:[1,1,0,0]},{deviation:.5,color:[1,1,0,1]},{deviation:1,color:[0,1,0,1]}]}),intensity:Lt({mode:"mix",colors:[{intensity:0,color:[1,0,0,0]},{intensity:.5,color:[1,1,0,.5]},{intensity:1,color:[0,1,0,1]}]})}),ocean:Lt({enabled:!1,color:[.5,.5,1],opacity:.5}),quality:Lt({detail:Lt({value:1,maxLodGPUBytes:Number.MAX_SAFE_INTEGER}),resolution:Lt({value:1})}),terrain:Lt({elevationColors:[{elevation:-10,color:[0,0,.5]},{elevation:0,color:[.5,.5,1]},{elevation:0,color:[0,.5,0]},{elevation:10,color:[.5,1,.5]}],asBackground:!1}),advanced:Lt({doubleSided:Lt({opaque:!1,transparent:!1}),hideTerrain:!1,hidePoints:!1,hideTriangles:!1,hideLines:!1,hideDocuments:!1,displayBuffer:0,renderBufferMask:255,terrainBiasLimit:7,documentsBiasLimit:3.5}),diagnostics:Lt({maxQueueSize:8,holdDynamic:!1,showBoundingBoxes:!1}),outline:Lt({enable:!1,color:void 0}),pickBuffer:Lt({includeTransparent:!1})};class Ot{view;deviceProfile;cameraValues;renderSettings;viewSceneGeneration;idleframe;detailAdjustment;statistics;workerView;_scene;_sceneGen;_validPickBuffers=!1;imagesRequested=0;constructor(t,e,i,s,a,r,n){this.view=t,this.deviceProfile=e,this.cameraValues=i,this.renderSettings=s,this.viewSceneGeneration=a,this.idleframe=r,this.detailAdjustment=n,this.workerView=t.workerView,this.statistics=St(t.performanceStatistics),this.cameraValues=i,this._scene=t.scene,this._sceneGen=t.scene?.generation}get viewWorldMatrix(){return this.cameraValues?.viewWorldMatrix??S()}get worldViewMatrix(){return this.cameraValues?.worldViewMatrix??S()}get viewClipMatrix(){return this.cameraValues?.viewClipMatrix??S()}get worldClipMatrix(){return this.cameraValues?.worldClipMatrix??S()}async ensurePickBuffers(){return this.view._validPickBuffers?(this._validPickBuffers||this.cameraValues&&(await this.view.workerView.updatePickBuffers(),this._validPickBuffers=!0),this._validPickBuffers):(this._validPickBuffers=!1,!1)}async pick(t,e,i){if(await this.ensurePickBuffers()){const{renderSettings:s}=this,a=s.quality.resolution.value;return await this.workerView.pick(t*a,e*a,i)}}async measure(t,e){if(await this.ensurePickBuffers()){const{renderSettings:i}=this,s=i.quality.resolution.value;return await this.workerView.measure(t*s,e*s)}}async applyPostEffect(t){return await this.workerView.applyPostEffect(t)}async getImage(){const t=await this.workerView.getOutputImage();return this.imagesRequested++,this.imagesRequested>1&&this.view.dropTime(),t}dispose(){}async hasChanged(){const{view:t,renderSettings:e,cameraValues:i,_scene:s,viewSceneGeneration:a,_sceneGen:r,detailAdjustment:n}=this,o=await t.currentSceneGeneration(),h=(i?.generation??0)!=t.camera.generation||t.camera.hasChanged,c=t.scene!==s||s?.generation!=r||a!=o,l=e.generation!=t.settings.generation,d=!t._validPickBuffers;if(h||c||l||d||n)return{camera:h,scene:c,settings:l,misc:d,detailAdjustment:n};t.dropTime()}isIdleFrame(){return this.idleframe}}M(Array);class At{api;workerView;_scene;_sceneViewState;_renderViewInitialized=Promise.resolve();_modelWorldMatrix=S();_validPickBuffers=!1;_lastRenderStartTime=0;lastRenderOutput;disposed=!1;camera;settings=function(){const t=Object.create(null);return t.generation=0,new Rt((()=>{t.generation++}),t).wrap(Ct),t}();performanceStatistics={cpuTime:{animation:0,render:{draw:0,update:0,total:0},geometry:{update:0}},gpuTime:void 0,gpuBytes:void 0,frameInterval:void 0,triangles:0,points:0,drawCalls:0,sceneResolved:!1,cameraGeneration:0};generation=0;throttleFrames=0;constructor(t,e,i){this.api=t,this.workerView=e,i&&this.applySettings(i),this.throttleFrames=t.deviceProfile.throttleFrames,this.camera=new gt(this)}applySettings(t){const{settings:e}=this,i=e.generation;if(Tt(e,t),!Number.isInteger(e.display.width)||!Number.isInteger(e.display.height))throw new Error("Display size is non-integer!");e.generation!=i&&(e.generation=i+1)}async setScene(t){if(this._scene=t,t){const{config:s}=t;e=this._modelWorldMatrix,i=s.modelWorldMatrix??S(),e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15]}else!function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(this._modelWorldMatrix);var e,i;this._sceneViewState&&(await this._sceneViewState.dispose(),this._sceneViewState=void 0),t&&(this._sceneViewState=await t.createViewState(this.workerView,this.api.deviceProfile),this.performanceStatistics.sceneResolved=!1)}get scene(){return this._scene}set scene(t){this._scene!=t&&(this.lastRenderOutput=void 0,this._renderViewInitialized=this.setScene(t))}async dispose(){this.disposed||(this.disposed=!0,this._sceneViewState&&await this._sceneViewState.dispose(),this.workerView&&(await this.workerView.dispose(),this.workerView[s]()))}computeCameraValues(){const{camera:t,settings:e}=this;if(t){const i=e.quality.resolution.value,{near:s,far:a}=t;let{width:r,height:n}=e.display;r*=i,n*=i;const o=r/n,{generation:h,viewFrustum:c,viewClipMatrix:l,viewWorldMatrix:d}=t.update(o);return function(t,e,i,s,a,r,n,o,h,c){const l=new _t(t,e,i);return function(t,e,i){var s,a;(s=kt)[0]=(a=e)[12],s[1]=a[13],s[2]=a[14];const{left:r,right:n,top:o,bottom:h,near:c,far:l,image:d}=t,u=[r,n,o,h,c,l,d];for(const t of u){const[e,s,a,r]=t;W(Mt,e,s,a),q(Mt,Mt,i);const n=r+K(kt,Mt);tt(t,Mt[0],Mt[1],Mt[2],-n)}}(s,l.getMatrix(yt.View,yt.Model),l.getMatrixNormal(yt.View,yt.Model)),{generation:a,viewFrustum:s,width:r,height:n,near:o,far:h,...Pt(l),...xt(l),projection:c}}(this._modelWorldMatrix,d,l,c,h,r,n,s,a,t.kind)}}update(){const{camera:t}=this;if(t){const{controller:e}=t;if(void 0!==e){const i=performance.now();e.update(t,this._scene?.boundingSphere,.001*(i-this.controllerLastTime)),this.controllerLastTime=i}}}dropTime(){this._lastRenderStartTime=0}invalidateCamera(){this.camera.generation++}_lastSceneGeneration=0;async currentSceneGeneration(){const t=await(this._sceneViewState?.generation());return t&&(this._lastSceneGeneration=t),t}_prevIdleRenderTime;_detailBiasLevel=1;async render(t){const{api:e,performanceStatistics:i}=this;let s=!1,a=!1,r=0;for(;;){r=await e.waitFrame();for(let t=0;t<this.throttleFrames;t++)r=await e.waitFrame();this.update();const i=this.lastRenderOutput?await this.lastRenderOutput.hasChanged():{camera:!1,settings:!1,detailAdjustment:!1};if(i){a=i.detailAdjustment,s=i.camera||i.settings,s&&(this._prevIdleRenderTime=r);break}if(this._prevIdleRenderTime&&r>this._prevIdleRenderTime+750){this._prevIdleRenderTime=void 0;break}this._lastRenderStartTime=0,t&&t()}const n=this.computeCameraValues(),{deviceProfile:o}=e,h=function(t){return St(t)}(this.settings),c=h,{quality:l}=c;let d=o.orthoDetailBias&&"orthographic"==this.camera.kind?o.orthoDetailBias:o.detailBias;s||this._prevIdleRenderTime?(l.resolution.value*=o.renderResolution*this.resolutionModifier,this._detailBiasLevel=1):(d*=d*Math.pow(this._detailBiasLevel,2)*2,l.resolution.value*=o.renderResolutionIdle);let u=!1;l.detail.value*=d;const{holdDynamic:m}=h.diagnostics;if(n&&!m){const t=this._sceneViewState;if(t){const s=await t.update(n,h,e.deviceProfile);i.cpuTime.geometry.update=s.updateTime,i.gpuBytes=s.gpuBytes,!a&&d<3&&s.gpuBytes&&s.resolved&&s.gpuBytes<.75*o.gpuBytesLimit&&this._detailBiasLevel<4?(i.sceneResolved=!1,o.gpuBytesLimit/s.gpuBytes>4?this._detailBiasLevel+=2:++this._detailBiasLevel,u=!0):i.sceneResolved=s.resolved}}await this._renderViewInitialized;const{workerView:p}=this;let f;this._lastRenderStartTime?(this.lastGeneration!==i.cameraGeneration&&(f=r-this._lastRenderStartTime),this.lastGeneration=i.cameraGeneration):this.performanceStatistics.cpuTime.render.total=0,this._lastRenderStartTime=r;const w=s?1:this.settings.advanced.renderBufferMask;h.advanced.renderBufferMask=w,this._validPickBuffers=1!=w;const v=await p.render(n,h,e.deviceProfile,this.generation++);i.cpuTime.render.draw=v.drawTime,i.cpuTime.render.update=v.updateTime,i.gpuTime=v.gpuTime,i.frameInterval=f,i.drawCalls=v.drawcalls,i.triangles=v.triangles,i.points=v.points,i.cameraGeneration=n?.generation??0;const g=new Ot(this,o,n,h,this._lastSceneGeneration,void 0===this._prevIdleRenderTime,u);return this.lastRenderOutput=g,g}controllerLastTime=0;lastGeneration=0;lastQualityAdjustTime=performance.now()+5e3;resolutionModifier=1;resolutionTier=2;frameIntervals=[];adjustQuality(t){const{performanceStatistics:e,frameIntervals:i,settings:s}=this,a=t?t.lowerBound:200,r=t?t.upperBound:33.3,{frameInterval:n}=e;if(n){i.push(n);const t=9;if(i.length==t){const e=[...i];e.sort();const s=e[Math.floor(t/2)];i.splice(0,1);const n=3e3,o=performance.now();if(o>this.lastQualityAdjustTime+n){const t=[.66,.75,1];s>a?(0!=this.resolutionTier&&(this.resolutionModifier=t[--this.resolutionTier]),this.lastQualityAdjustTime=o):s<r&&2!=this.resolutionTier&&(this.resolutionModifier=t[++this.resolutionTier],this.lastQualityAdjustTime=o)}return s}}}async transferToImageBitmap(){return await this.workerView.transferToImageBitmap()}async convertToBlob(t){return await this.workerView.convertToBlob(t)}async updatePickBuffers(){this._validPickBuffers&&this.computeCameraValues()&&await this.workerView.updatePickBuffers()}}const Bt={cube:[new class{id;name;path;type;constructor(t,e,i,s){this.id=t,this.name=e,this.path=i,this.type=s}description;url;properties=[];loadMetaData(){return Promise.resolve(this)}save(){return Promise.resolve(!1)}}(0,"cube","cube",1)]},Dt={empty:{kind:"empty",id:"empty",version:"",boundingSphere:{center:B(),radius:1},modelWorldMatrix:S(),materials:[],db:"empty"},cube:{kind:"cube",id:"cube",version:"",count:1,radius:0,boundingSphere:{center:B(),radius:0+Math.sqrt(3)},modelWorldMatrix:S(),materials:[{kind:"basic_z",uniforms:{rgba:J(1,0,0,1)}},{kind:"basic_z",uniforms:{rgba:J(1,1,0,1)}},{kind:"basic_z",uniforms:{rgba:J(0,1,0,1)}},{kind:"basic_z",uniforms:{rgba:J(0,1,1,1)}},{kind:"basic_z",uniforms:{rgba:J(0,0,1,1)}},{kind:"basic_z",uniforms:{rgba:J(1,0,1,1)}}],db:"cube"}};function jt(t,e){const i=("string"==typeof e?[e]:e).map((t=>new RegExp(t,"i")));if(i.some((e=>e.test(t.name))))return!0;const{path:s}=t,a=s.split("/");if(i.some((t=>t.test(a[a.length-1])))||t.description&&i.some((e=>e.test(t.description))))return!0;const{properties:r}=t;if(void 0!==r)for(let t of r)if(i.some((e=>e.test(t[0])))||i.some((e=>e.test(t[1]))))return!0;return!1}function Wt(t,e){if(t.name===e)return!0;const{path:i}=t,s=i.split("/");if(s[s.length-1]===e||t.description===e)return!0;const{properties:a}=t;if(void 0!==a)for(let t of a)if(t[0]===e||t[1]===e)return!0;return!1}async function*It(t,e){let i=e.parentPath??"",s=0,a=e.descentDepth??1e5;if(i.length>0)s=i.split("/").length-1,a>0?(i+="/",a+=s,t=t.filter((t=>t.level>s&&t.level<=a&&t.path.startsWith(i)))):t=t.filter((t=>t.level===s&&t.path===i));else{if(0===a)return;t=t.filter((t=>t.level<a))}const{searchPattern:r}=e;if(r)if(Array.isArray(r)){for(const{property:e,value:i,exact:s}of r)if(void 0!==i)if(e)if(s)t=t.filter((t=>{for(const s of t.properties)if(s[0]===e&&s[1]===i)return!0;return!1}));else{const s=new RegExp(e,"i"),a=("string"==typeof i?[i]:i).map((t=>new RegExp(t,"i")));t=t.filter((t=>{for(const e of t.properties)if(s.test(e[0])&&a.some((t=>t.test(e[1]))))return!0;return!1}))}else t=s?t.filter((t=>Wt(t,i))):t.filter((t=>jt(t,i)))}else t=t.filter((t=>jt(t,r)));yield*t.sort(((t,e)=>(0===t.type?-2:0)+(0===e.type?2:0)+(t.path>e.path?1:-1)))}class zt{db;loadMetaData(){return Promise.resolve(this)}save(){return Promise.resolve(!1)}constructor(t){this.db=t,t.forEach(((t,e)=>{t.loadMetaData=this.loadMetaData,t.save=this.save}))}search(t,e){return It(this.db,t)}getObjectMetdata(t){return Promise.resolve(this.db[t])}}async function*Nt(t,e){const i=await fetch(t.toString(),{signal:e});if(!i.ok)throw new Error(`Failed to retreive scene metadata: ${i.status} ${i.statusText}`);if(i.body){const t=i.body.getReader(),e=new TextDecoder("utf-8");let{value:s,done:a}=await t.read(),r=s?e.decode(s):"",n=/\r\n|\n|\r/gm,o=0;for(;;){let i=n.exec(r);if(i)yield r.substring(o,i.index),o=n.lastIndex;else{if(a)break;let i=r.substr(o);({value:s,done:a}=await t.read()),r=i+(s?e.decode(s):""),o=n.lastIndex=0}}o<r.length&&(yield r.substr(o))}}class Ut{url;loadMetaData(){return Promise.resolve(this)}save(){return Promise.resolve(!1)}_promise;constructor(t){this.url=t}async getDB(t){if(!this._promise){const e=new URL(this.url);e.pathname+="metadata",this._promise=async function(t,e,i,s){let a=[];const r=Nt(t,s);for await(const t of r){const s=JSON.parse(t);s.loadMetaData=e,s.save=i,a.push(s)}return a}(e,this.loadMetaData,this.save,t)}return this._promise}search(t,e){return async function*(t,e){const i=await t;for await(const t of It(i,e))yield t}(this.getDB(e),t)}async getObjectMetdata(t){return(await this.getDB())[t]}}class Ht{changedCB;objectHighlightIndices;generation=0;constructor(t,e){this.changedCB=e,this.objectHighlightIndices=new Uint8Array(t)}async commit(){this.changedCB?.(),this.generation++}}!function(t){t.empty=new t(0)}(Ht||(Ht={}));class Kt{assetUrl;config;db;workerAssets;createWorkerScene;title="";dateCreated=new Date(Date.now());dateLastSaved=new Date(Date.now());description="";location;timezone;_highlighter;instances=[];boundingSphere;id;get subtrees(){return this.config.subtrees}get variants(){return this.config.variants}_generation=0;get generation(){return this._generation}constructor(t,e,i,s,a){this.assetUrl=t,this.config=e,this.db=i,this.workerAssets=s,this.createWorkerScene=a,this.id=e.id;const{center:r,radius:n}=e.boundingSphere,o=D(1,1,1);e.modelWorldMatrix&&(C(o,e.modelWorldMatrix),F(r,r,e.modelWorldMatrix)),this.boundingSphere={center:r,radius:n*o[0]}}async createViewState(t,e){const{config:s,assetUrl:a}=this,r=await this.createWorkerScene(),n=await t[i](),o=await r.initialize(p(n,[n]),e,s,a);return o&&(j(this.boundingSphere.center,o.center),this.boundingSphere.radius=o.radius),new Kt.ViewState(this,r)}get dynamicObjects(){const{instances:t}=this;return function*(){for(let e of t)e&&(yield e)}()}getObjectReference(t){return{id:t,loadMetaData:()=>this.db.getObjectMetdata(t)}}search(t,e){return this.db.search(t,e)}async descendants(t,e){if(!t.descendants)try{const i=new URL(this.assetUrl);i.pathname+=`descendants/${t.id}`;const s=[],a=Nt(i,e);for await(const t of a)s.push(parseInt(t));t.descendants=s}catch{t.descendants=[]}return t.descendants??[]}computeSunPosition(t){if(!this.location)return{azimuth:0,inclination:0};function e(t){return Math.sin(t*Math.PI/180)}function i(t){return 180*Math.asin(t)/Math.PI}function s(t){return Math.cos(t*Math.PI/180)}function a(t){return 180*Math.acos(Math.max(-1,Math.min(1,t)))/Math.PI}const r=Math.floor((t.getTime()-new Date(t.getFullYear(),0,1).getTime())/864e5),n=t.getHours()+t.getMinutes()/60+this.location.longitude/15-(this.timezone??0),o=15*n-90,h=-i(.39779*s(.98565*(r+10)+1.914*e(.98565*(r-2)))),c=i(e(this.location.latitude)*e(h)+e(o)*s(this.location.latitude)*s(h));let l;return l=this.location.latitude<90&&this.location.latitude>-90?a((e(h)-s(90-c)*e(this.location.latitude))/(e(90-c)*s(this.location.latitude))):a(s(15*n)*s(h)/e(90-c)),{azimuth:n>12||n<0?360-l:l,inclination:c}}createDynamicObject(t){const{instances:e}=this,i=e.length,s=new Gt(this,t,(()=>{this._generation++}),(()=>{e[i]=void 0}));return e[i]=s,s}get objectHighlighter(){if(!this._highlighter){const{config:t}=this;function e(t){return"octree"==t.kind}if(!e(t))return Ht.empty;{const{numObjects:i}=t;this._highlighter=new Ht(i,(()=>{this._generation++}))}}return this._highlighter}}!function(t){t.ViewState=class{scene;workerScene;_prevHighlighterGeneration=-1;_prevObjectHighlights;constructor(t,e){this.scene=t,this.workerScene=e,this._prevObjectHighlights=Ct.objectHighlights}async dispose(){await this.workerScene.dispose(),this.workerScene[s]()}async generation(){return await this.workerScene.generation}async update(t,e,i){const s=this.scene.instances.map((t=>{if(t){const{visible:e,position:i,rotation:s,scale:a,geometry:r}=t;return{assetId:r.id,visible:e,position:i,rotation:s,scale:a}}})),a=this.scene._highlighter;let r;if(a&&this._prevHighlighterGeneration!=a.generation&&(this._prevHighlighterGeneration=a.generation,r=a.objectHighlightIndices.buffer),this._prevObjectHighlights!=e.objectHighlights)this._prevObjectHighlights=e.objectHighlights;else{const{objectHighlights:t,...i}=e;e=i}return await this.workerScene.update(t,s,r,e,i)}}}(Kt||(Kt={}));class Gt{scene;geometry;updated;remove;_visible=!1;_position=B();_rotation=et();_scale=D(1,1,1);get visible(){return this._visible}get position(){return this._position}get rotation(){return this._rotation}get scale(){return this._scale}set visible(t){t!==this._visible&&(this._visible=t,this.updated())}set position(t){X(t,this._position)||(this._position=t,this.updated())}set rotation(t){(function(t,e){var i=t[0],s=t[1],a=t[2],r=t[3],n=e[0],o=e[1],h=e[2],c=e[3];return Math.abs(i-n)<=y*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(s-o)<=y*Math.max(1,Math.abs(s),Math.abs(o))&&Math.abs(a-h)<=y*Math.max(1,Math.abs(a),Math.abs(h))&&Math.abs(r-c)<=y*Math.max(1,Math.abs(r),Math.abs(c))})(t,this._rotation)||(this._rotation=t,this.updated())}set scale(t){X(t,this._scale)||(this._scale=t,this.updated())}constructor(t,e,i,s){this.scene=t,this.geometry=e,this.updated=i,this.remove=s}dispose(){this.remove()}}const Ft=document.currentScript?.src??("undefined"==typeof document&&"undefined"==typeof location?new(require("url").URL)("file:"+__filename).href:"undefined"==typeof document?location.href:document.currentScript&&document.currentScript.src||new URL("index_umd.js",document.baseURI).href);async function qt(t){const e=await createImageBitmap(t),i=document.createElement("canvas"),{width:s,height:a}=e;i.width=s,i.height=a;const r=i.getContext("2d",{alpha:!0,desynchronized:!0});return r.drawImage(e,0,0),r.getImageData(0,0,s,a)}function Yt(t){let e=1,i=0;return function(t){return"object"==typeof t}(t)?(t.scale&&(e=t.scale),t.offset&&(i=t.offset)):"number"==typeof t&&(e=0,i=t),[e,i]}class Xt{url;id;boundingSphere;remove;constructor(t,e,i,s){this.url=t,this.id=e,this.boundingSphere=i,this.remove=s}dispose(){this.remove()}}class Zt{version;scriptUrl;run=!0;frameNumber=0;animate;supportsOffscreenCanvas="OffscreenCanvas"in self;animHandle;dynamicAssets=[];environments=[];views=new Vt;workerAssets;_deviceProfile;workers;constructor(t,e){const i=new URL(e??Ft);this.scriptUrl=new URL("./",i).href.slice(0,-1),this.version="0.4.59",t&&(this.supportsOffscreenCanvas=!1),this._deviceProfile=function(){const t=document.createElement("CANVAS");t.width=1,t.height=1,document.body.appendChild(t);const e=t.getContext("webgl",{failIfMajorPerformanceCaveat:!0});t.remove();let i="unknown",s=null==e,a=.5,r=1,n=.25,o=.35,h=5e8,c=5e6,l=!0;const d=e?.getExtension("WEBGL_debug_renderer_info"),u=d?e?.getParameter(37446):"???",{userAgent:m}=navigator,p=/\bMobile\b/.test(m);return/\bWindows\b/.test(m)?(i="windows",s||(n=1,a=screen.height>1200?.5:1,r=devicePixelRatio,h=2e9,c=1e7,o=.2)):/\bMacintosh\b/.test(m)?p?s||(i="ipad",n=.5,a=.5,r=devicePixelRatio,o=.35,h=5e8,c=5e6):(i="mac",s||(n=1,a=screen.height>1200?.5:1,r=devicePixelRatio,o=.2,h=2e9,c=1e7,/\bM[1|2]\b/.test(u)&&(a=devicePixelRatio,h=4e9,c=2e7,o=1.5,l=!1))):/\biPad/.test(m)?(i="ipad",s||(n=.5,a=.5,r=devicePixelRatio,o=.35,h=5e8,c=5e6)):/\biPhone/.test(m)?(i="ios",a=1,r=devicePixelRatio):/\bAndroid\b/.test(m)&&(i="android",p||s||(n=.5,a=.5,o=.35,h=5e8,c=5e6)),{name:i,hasMajorPerformanceCaveat:s,discreteGPU:!1,throttleFrames:0,detailBias:o,renderResolution:a,renderResolutionIdle:r,textureResolution:n,gpuBytesLimit:h,triangleLimit:c,weakDevice:l}}()}async createWorkers(){const t=(t,e)=>{if(this.scriptUrl.startsWith(self.location.origin))return new Worker(t,{type:"classic",name:e});{const i=new Blob([`importScripts(${JSON.stringify(t)});`],{type:"text/javascript"}),s=URL.createObjectURL(i),a=new Worker(s,{type:"classic",name:e});return URL.revokeObjectURL(s),a}},e=this.supportsOffscreenCanvas?t(`${this.scriptUrl}/render.js`,"Render"):(t=>{const{port1:e,port2:i}=new MessageChannel;return import(t).then((t=>{const{__initRenderServiceEndPoint__:e}=self;e(i),delete self.__initRenderServiceEndPoint__}),(t=>{throw new t})),e})(`${this.scriptUrl}/render.js`),i=t(`${this.scriptUrl}/geometry.js`,"Geometry"),s=c(e),a=c(i);this.workers={render:{worker:e,service:s},geometry:{worker:i,service:a}};const r=await s.materialTypes;this.workerAssets=await a.initialize(r,this.scriptUrl,f(qt)),this.animHandle=requestAnimationFrame(this.animateCB)}async dispose(){this.run=!1,this.animHandle&&(cancelAnimationFrame(this.animHandle),this.animHandle=void 0);for(const t of this.views)await t.dispose();const{workers:t}=this;if(t){const{render:e,geometry:i}=t;await i.service.terminate(),await e.service.terminate(),i.service[s](),e.service[s](),this.workers=void 0}}resolves=[];animateCB=async t=>{this.run&&(this.animate?.(t),this.internalUpdate());for(const e of this.resolves)e(t);this.resolves.length=0,this.frameNumber++,this.animHandle=requestAnimationFrame(this.animateCB)};get deviceProfile(){return this._deviceProfile}set deviceProfile(t){this._deviceProfile=t}waitFrame(){return new Promise((t=>{this.resolves.push(t)}))}internalUpdate(){const t=[];for(const e of this.views)e.disposed?t.push(e):e.update();for(const e of t)this.views.remove(e)}async update(){await this.internalUpdate(),await this.waitFrame()}async loadScene(t,e){return this.workers||await this.createWorkers(),"string"!=typeof t&&(t=t.toString()),async function(t,e,i){let s=Dt[e];if(s)e=location.origin;else{const t=new URL(e);t.pathname+="config.json",s=await async function(t){const e=await fetch(t,{mode:"cors"});if(!e.ok)throw new Error(e.statusText);return await e.json()}(t.toString())}const a=Bt[s.id],r=i??(a?new zt(a):new Ut(e)),{assets:n,createScene:o}=await t.createAssets(e);return new Kt(e,s,r,n,o)}(this.workers.geometry.service,t,e)}async loadAsset(t){this.workers||await this.createWorkers();const{dynamicAssets:e,workerAssets:i}=this,s=e.length;e[s]=void 0;const a=await i.loadAsset(s,t.toString());return e[s]=new Xt(t,s,a,(async()=>{await i.disposeAsset(s),e[s]=void 0}))}async loadEnvironment(t){this.workers||await this.createWorkers();const{environments:e,workerAssets:i}=this,s=e.length;return e[s]=void 0,await i.loadEnvironment(s,t.url),e[s]={id:s,dispose:async()=>{await i.disposeEnvironment(s),e[s]=void 0}}}async createView(t,e){this.workers||await this.createWorkers();const i=await async function(t,e,i,s){const a=i?.quality?.resolution.value??1,r=i?.display?.width??300*a,n=i?.display?.height??150*a;self.__htmlRenderCanvas__=s;const o=await e.createView(r,n);return delete self.__htmlRenderCanvas__,new At(t,o,i)}(this,this.workers.render.service,t,e);return this.views.add(i),i}createNeutralHighlight(){return{rgbaTransform:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0]}}createTransparentHighlight(t){return{rgbaTransform:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,t,0]}}createColorSetHighlight(t){const[e,i,s,a]=t;return{rgbaTransform:[0,0,0,0,e,0,0,0,0,i,0,0,0,0,s,0,0,0,0,a??1]}}createRGBATransformHighlight(t){const e=Yt(t.red),i=Yt(t.green),s=Yt(t.blue),a=Yt(t.opacity);return{rgbaTransform:[e[0],0,0,0,e[1],0,i[0],0,0,i[1],0,0,s[0],0,s[1],0,0,0,a[0],a[1]]}}createHSLATransformHighlight(t){const[e,i]=Yt(t.lightness),[s,a]=Yt(t.opacity);function r(t,e,i){return t+(e-t)*i}const n=t.saturation??1,o=r(1/3,1,n)*e,h=r(1/3,0,n)*e;return{rgbaTransform:[o,h,h,0,i,h,o,h,0,i,h,h,o,0,i,0,0,0,s,a]}}createHighlight(t){switch(t.kind){case"neutral":return this.createNeutralHighlight();case"transparent":return this.createTransparentHighlight(t.opacity);case"color":return this.createColorSetHighlight(t.color);case"rgba":return this.createRGBATransformHighlight(t);case"hsla":return this.createHSLATransformHighlight(t);default:{function e(t){throw new Error("Unknown highlight type {$params.kind}!")}return e()}}}createCameraController(t,e){switch(t.kind){case"static":return new mt(t);case"turntable":return new pt(t);case"orbit":return new ft(t,e);case"flight":return new wt(t,e);case"ortho":return new vt(t,e);default:{function i(t){throw new Error("Unknown controller type {$params.kind}!")}return i()}}}async availableEnvironments(t){let e=[];const i=new URL(t??"/assets/env/index.json",Ft),s=await fetch(i.toString());return s.ok&&(e=(await s.json()).map((t=>({name:t,url:new URL(t,i).toString(),thumnbnailURL:new URL(`thumbnails/${t}.png`,i).toString()})))),e}}var Qt,$t;t.WellKnownSceneUrls=void 0,(Qt=t.WellKnownSceneUrls||(t.WellKnownSceneUrls={})).empty="empty",Qt.cube="cube",Qt.condos="https://api.novorender.com/assets/scenes/condos/",t.NodeType=void 0,($t=t.NodeType||(t.NodeType={}))[$t.Internal=0]="Internal",$t[$t.Leaf=1]="Leaf",t.API=Zt,t.createAPI=function(t){return new Zt(t?.noOffscreenCanvas??!1,t?.scriptBaseUrl)},Object.defineProperty(t,"__esModule",{value:!0})}));